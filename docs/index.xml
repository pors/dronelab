<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>dronelab.dev</title>
<link>https://dronelab.dev/</link>
<atom:link href="https://dronelab.dev/index.xml" rel="self" type="application/rss+xml"/>
<description>On this blog, dronelab.dev, I explore machine learning by teaching a drone to fly autonomously. I break things down into small steps and share my discoveries along the way.</description>
<generator>quarto-1.7.27</generator>
<lastBuildDate>Tue, 10 Jun 2025 21:00:00 GMT</lastBuildDate>
<item>
  <title>MNIST basics - Training a Digit Classifier</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/mnist-basics/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-06-11</p>
</header>


<p><a href="https://colab.research.google.com/github/pors/dronelab/blob/main/posts/mnist-basics/index.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="under-the-hood-training-a-digit-classifier" class="level1">
<h1>Under the Hood: Training a Digit Classifier</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook is a copy of chapter four of the fastai book <a href="https://github.com/fastai/fastbook/blob/master/04_mnist_basics.ipynb" target="_blank">Under the Hood: Training a Digit Classifier</a>.</p>
<p>I added and removed code and markdown here and there reflecting my own understanding of the topic. Not very interesting (aka boring) for 99+% of you, it is mostly for my own reference. My approach here is to work through the original notebook, and if I don’t understand something fully, I dive into it a bit. My comments are marked with <mark>&lt;mark&gt;…&lt;/mark&gt;</mark>.</p>
<p>For drone related stuff, see the <a href="../../series/index.html">Code, Fly &amp; AI Series</a>.</p>
</div>
</div>
<section id="pixels-the-foundations-of-computer-vision" class="level2">
<h2 class="anchored" data-anchor-id="pixels-the-foundations-of-computer-vision">Pixels: The Foundations of Computer Vision</h2>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-2">matplotlib.rc(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Greys'</span>)</span></code></pre></div>
</div>
<p>For this initial tutorial we are just going to try to create a model that can classify any image as a 3 or a 7. So let’s download a sample of MNIST that contains images of just these digits:</p>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:37}}" data-outputid="e2dd7b78-1d09-4a96-9e88-c8348bc30d03" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> untar_data(URLs.MNIST_SAMPLE)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="3219456" class="" max="3214948" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.14% [3219456/3214948 00:01&lt;00:00]
    </div>
    
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#hide</span></span>
<span id="cb3-2">Path.BASE_PATH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path</span></code></pre></div>
</div>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="c5393658-2cbc-4761-9c5a-ececeb92fbad" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>).ls()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(#2) [Path('train/7'),Path('train/3')]</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="3360ee2f-5d66-4a64-83a3-0d273c4ddfb7" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">threes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3'</span>).ls().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb6-2">sevens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'7'</span>).ls().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb6-3">threes</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(#6131) [Path('train/3/10.png'),Path('train/3/10000.png'),Path('train/3/10011.png'),Path('train/3/10031.png'),Path('train/3/10034.png'),Path('train/3/10042.png'),Path('train/3/10052.png'),Path('train/3/1007.png'),Path('train/3/10074.png'),Path('train/3/10091.png')...]</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-outputid="ee69753f-b303-4c2a-d067-a51805d5ed47" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">im3_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-2">im3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(im3_path)</span>
<span id="cb8-3">im3</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-12" class="cell" data-outputid="598cf5d9-9ab8-4ca4-8252-450731e04186">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">array(im3)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[  0,   0,   0,   0,   0,   0],
       [  0,   0,   0,   0,   0,  29],
       [  0,   0,   0,  48, 166, 224],
       [  0,  93, 244, 249, 253, 187],
       [  0, 107, 253, 253, 230,  48],
       [  0,   3,  20,  20,  15,   0]], dtype=uint8)</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-outputid="6de93db1-c035-4392-a4ec-9a94d23f18c6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">tensor(im3)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[  0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,  29],
        [  0,   0,   0,  48, 166, 224],
        [  0,  93, 244, 249, 253, 187],
        [  0, 107, 253, 253, 230,  48],
        [  0,   3,  20,  20,  15,   0]], dtype=torch.uint8)</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-outputid="122b00d5-51a5-4365-8ae8-2d559780b693" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">im3_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(im3)</span>
<span id="cb13-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(im3_t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>])</span>
<span id="cb13-3">df.style.set_properties(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-size'</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'6pt'</span>}).background_gradient(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Greys'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<style type="text/css">
#T_1743a_row0_col0, #T_1743a_row0_col1, #T_1743a_row0_col2, #T_1743a_row0_col3, #T_1743a_row0_col4, #T_1743a_row0_col5, #T_1743a_row0_col6, #T_1743a_row0_col7, #T_1743a_row0_col8, #T_1743a_row0_col9, #T_1743a_row0_col10, #T_1743a_row0_col11, #T_1743a_row0_col12, #T_1743a_row0_col13, #T_1743a_row0_col14, #T_1743a_row0_col15, #T_1743a_row0_col16, #T_1743a_row0_col17, #T_1743a_row1_col0, #T_1743a_row1_col1, #T_1743a_row1_col2, #T_1743a_row1_col3, #T_1743a_row1_col4, #T_1743a_row1_col15, #T_1743a_row1_col16, #T_1743a_row1_col17, #T_1743a_row2_col0, #T_1743a_row2_col1, #T_1743a_row2_col2, #T_1743a_row2_col15, #T_1743a_row2_col16, #T_1743a_row2_col17, #T_1743a_row3_col0, #T_1743a_row3_col15, #T_1743a_row3_col16, #T_1743a_row3_col17, #T_1743a_row4_col0, #T_1743a_row4_col6, #T_1743a_row4_col7, #T_1743a_row4_col8, #T_1743a_row4_col9, #T_1743a_row4_col10, #T_1743a_row4_col15, #T_1743a_row4_col16, #T_1743a_row4_col17, #T_1743a_row5_col0, #T_1743a_row5_col5, #T_1743a_row5_col6, #T_1743a_row5_col7, #T_1743a_row5_col8, #T_1743a_row5_col9, #T_1743a_row5_col15, #T_1743a_row5_col16, #T_1743a_row5_col17, #T_1743a_row6_col0, #T_1743a_row6_col1, #T_1743a_row6_col2, #T_1743a_row6_col3, #T_1743a_row6_col4, #T_1743a_row6_col5, #T_1743a_row6_col6, #T_1743a_row6_col7, #T_1743a_row6_col8, #T_1743a_row6_col9, #T_1743a_row6_col14, #T_1743a_row6_col15, #T_1743a_row6_col16, #T_1743a_row6_col17, #T_1743a_row7_col0, #T_1743a_row7_col1, #T_1743a_row7_col2, #T_1743a_row7_col3, #T_1743a_row7_col4, #T_1743a_row7_col5, #T_1743a_row7_col6, #T_1743a_row7_col13, #T_1743a_row7_col14, #T_1743a_row7_col15, #T_1743a_row7_col16, #T_1743a_row7_col17, #T_1743a_row8_col0, #T_1743a_row8_col1, #T_1743a_row8_col2, #T_1743a_row8_col3, #T_1743a_row8_col4, #T_1743a_row8_col13, #T_1743a_row8_col14, #T_1743a_row8_col15, #T_1743a_row8_col16, #T_1743a_row8_col17, #T_1743a_row9_col0, #T_1743a_row9_col1, #T_1743a_row9_col2, #T_1743a_row9_col3, #T_1743a_row9_col4, #T_1743a_row9_col16, #T_1743a_row9_col17, #T_1743a_row10_col0, #T_1743a_row10_col1, #T_1743a_row10_col2, #T_1743a_row10_col3, #T_1743a_row10_col4, #T_1743a_row10_col5, #T_1743a_row10_col6, #T_1743a_row10_col17 {
  font-size: 6pt;
  background-color: #ffffff;
  color: #000000;
}
#T_1743a_row1_col5 {
  font-size: 6pt;
  background-color: #efefef;
  color: #000000;
}
#T_1743a_row1_col6, #T_1743a_row1_col13 {
  font-size: 6pt;
  background-color: #7c7c7c;
  color: #f1f1f1;
}
#T_1743a_row1_col7 {
  font-size: 6pt;
  background-color: #4a4a4a;
  color: #f1f1f1;
}
#T_1743a_row1_col8, #T_1743a_row1_col9, #T_1743a_row1_col10, #T_1743a_row2_col5, #T_1743a_row2_col6, #T_1743a_row2_col7, #T_1743a_row2_col11, #T_1743a_row2_col12, #T_1743a_row2_col13, #T_1743a_row3_col4, #T_1743a_row3_col12, #T_1743a_row3_col13, #T_1743a_row4_col1, #T_1743a_row4_col2, #T_1743a_row4_col3, #T_1743a_row4_col12, #T_1743a_row4_col13, #T_1743a_row5_col12, #T_1743a_row6_col11, #T_1743a_row9_col11, #T_1743a_row10_col11, #T_1743a_row10_col12, #T_1743a_row10_col13, #T_1743a_row10_col14, #T_1743a_row10_col15, #T_1743a_row10_col16 {
  font-size: 6pt;
  background-color: #000000;
  color: #f1f1f1;
}
#T_1743a_row1_col11 {
  font-size: 6pt;
  background-color: #606060;
  color: #f1f1f1;
}
#T_1743a_row1_col12 {
  font-size: 6pt;
  background-color: #4d4d4d;
  color: #f1f1f1;
}
#T_1743a_row1_col14 {
  font-size: 6pt;
  background-color: #bbbbbb;
  color: #000000;
}
#T_1743a_row2_col3 {
  font-size: 6pt;
  background-color: #e4e4e4;
  color: #000000;
}
#T_1743a_row2_col4, #T_1743a_row8_col6 {
  font-size: 6pt;
  background-color: #6b6b6b;
  color: #f1f1f1;
}
#T_1743a_row2_col8, #T_1743a_row2_col14, #T_1743a_row3_col14 {
  font-size: 6pt;
  background-color: #171717;
  color: #f1f1f1;
}
#T_1743a_row2_col9, #T_1743a_row3_col11 {
  font-size: 6pt;
  background-color: #4b4b4b;
  color: #f1f1f1;
}
#T_1743a_row2_col10, #T_1743a_row7_col10, #T_1743a_row8_col8, #T_1743a_row8_col10, #T_1743a_row9_col8, #T_1743a_row9_col10 {
  font-size: 6pt;
  background-color: #010101;
  color: #f1f1f1;
}
#T_1743a_row3_col1 {
  font-size: 6pt;
  background-color: #272727;
  color: #f1f1f1;
}
#T_1743a_row3_col2 {
  font-size: 6pt;
  background-color: #0a0a0a;
  color: #f1f1f1;
}
#T_1743a_row3_col3 {
  font-size: 6pt;
  background-color: #050505;
  color: #f1f1f1;
}
#T_1743a_row3_col5 {
  font-size: 6pt;
  background-color: #333333;
  color: #f1f1f1;
}
#T_1743a_row3_col6 {
  font-size: 6pt;
  background-color: #e6e6e6;
  color: #000000;
}
#T_1743a_row3_col7, #T_1743a_row3_col10 {
  font-size: 6pt;
  background-color: #fafafa;
  color: #000000;
}
#T_1743a_row3_col8 {
  font-size: 6pt;
  background-color: #fbfbfb;
  color: #000000;
}
#T_1743a_row3_col9 {
  font-size: 6pt;
  background-color: #fdfdfd;
  color: #000000;
}
#T_1743a_row4_col4 {
  font-size: 6pt;
  background-color: #1b1b1b;
  color: #f1f1f1;
}
#T_1743a_row4_col5 {
  font-size: 6pt;
  background-color: #e0e0e0;
  color: #000000;
}
#T_1743a_row4_col11 {
  font-size: 6pt;
  background-color: #4e4e4e;
  color: #f1f1f1;
}
#T_1743a_row4_col14 {
  font-size: 6pt;
  background-color: #767676;
  color: #f1f1f1;
}
#T_1743a_row5_col1 {
  font-size: 6pt;
  background-color: #fcfcfc;
  color: #000000;
}
#T_1743a_row5_col2, #T_1743a_row5_col3 {
  font-size: 6pt;
  background-color: #f6f6f6;
  color: #000000;
}
#T_1743a_row5_col4, #T_1743a_row7_col7 {
  font-size: 6pt;
  background-color: #f8f8f8;
  color: #000000;
}
#T_1743a_row5_col10, #T_1743a_row10_col7 {
  font-size: 6pt;
  background-color: #e8e8e8;
  color: #000000;
}
#T_1743a_row5_col11 {
  font-size: 6pt;
  background-color: #222222;
  color: #f1f1f1;
}
#T_1743a_row5_col13, #T_1743a_row6_col12 {
  font-size: 6pt;
  background-color: #090909;
  color: #f1f1f1;
}
#T_1743a_row5_col14 {
  font-size: 6pt;
  background-color: #d0d0d0;
  color: #000000;
}
#T_1743a_row6_col10, #T_1743a_row7_col11, #T_1743a_row9_col6 {
  font-size: 6pt;
  background-color: #060606;
  color: #f1f1f1;
}
#T_1743a_row6_col13 {
  font-size: 6pt;
  background-color: #979797;
  color: #f1f1f1;
}
#T_1743a_row7_col8 {
  font-size: 6pt;
  background-color: #b6b6b6;
  color: #000000;
}
#T_1743a_row7_col9 {
  font-size: 6pt;
  background-color: #252525;
  color: #f1f1f1;
}
#T_1743a_row7_col12 {
  font-size: 6pt;
  background-color: #999999;
  color: #f1f1f1;
}
#T_1743a_row8_col5 {
  font-size: 6pt;
  background-color: #f9f9f9;
  color: #000000;
}
#T_1743a_row8_col7 {
  font-size: 6pt;
  background-color: #101010;
  color: #f1f1f1;
}
#T_1743a_row8_col9, #T_1743a_row9_col9 {
  font-size: 6pt;
  background-color: #020202;
  color: #f1f1f1;
}
#T_1743a_row8_col11 {
  font-size: 6pt;
  background-color: #545454;
  color: #f1f1f1;
}
#T_1743a_row8_col12 {
  font-size: 6pt;
  background-color: #f1f1f1;
  color: #000000;
}
#T_1743a_row9_col5 {
  font-size: 6pt;
  background-color: #f7f7f7;
  color: #000000;
}
#T_1743a_row9_col7 {
  font-size: 6pt;
  background-color: #030303;
  color: #f1f1f1;
}
#T_1743a_row9_col12 {
  font-size: 6pt;
  background-color: #181818;
  color: #f1f1f1;
}
#T_1743a_row9_col13 {
  font-size: 6pt;
  background-color: #303030;
  color: #f1f1f1;
}
#T_1743a_row9_col14 {
  font-size: 6pt;
  background-color: #a9a9a9;
  color: #f1f1f1;
}
#T_1743a_row9_col15 {
  font-size: 6pt;
  background-color: #fefefe;
  color: #000000;
}
#T_1743a_row10_col8, #T_1743a_row10_col9 {
  font-size: 6pt;
  background-color: #bababa;
  color: #000000;
}
#T_1743a_row10_col10 {
  font-size: 6pt;
  background-color: #393939;
  color: #f1f1f1;
}
</style>

<table id="T_1743a" class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_1743a_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">0</th>
<th id="T_1743a_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">1</th>
<th id="T_1743a_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">2</th>
<th id="T_1743a_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">3</th>
<th id="T_1743a_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">4</th>
<th id="T_1743a_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">5</th>
<th id="T_1743a_level0_col6" class="col_heading level0 col6" data-quarto-table-cell-role="th">6</th>
<th id="T_1743a_level0_col7" class="col_heading level0 col7" data-quarto-table-cell-role="th">7</th>
<th id="T_1743a_level0_col8" class="col_heading level0 col8" data-quarto-table-cell-role="th">8</th>
<th id="T_1743a_level0_col9" class="col_heading level0 col9" data-quarto-table-cell-role="th">9</th>
<th id="T_1743a_level0_col10" class="col_heading level0 col10" data-quarto-table-cell-role="th">10</th>
<th id="T_1743a_level0_col11" class="col_heading level0 col11" data-quarto-table-cell-role="th">11</th>
<th id="T_1743a_level0_col12" class="col_heading level0 col12" data-quarto-table-cell-role="th">12</th>
<th id="T_1743a_level0_col13" class="col_heading level0 col13" data-quarto-table-cell-role="th">13</th>
<th id="T_1743a_level0_col14" class="col_heading level0 col14" data-quarto-table-cell-role="th">14</th>
<th id="T_1743a_level0_col15" class="col_heading level0 col15" data-quarto-table-cell-role="th">15</th>
<th id="T_1743a_level0_col16" class="col_heading level0 col16" data-quarto-table-cell-role="th">16</th>
<th id="T_1743a_level0_col17" class="col_heading level0 col17" data-quarto-table-cell-role="th">17</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_1743a_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_1743a_row0_col0" class="data row0 col0">0</td>
<td id="T_1743a_row0_col1" class="data row0 col1">0</td>
<td id="T_1743a_row0_col2" class="data row0 col2">0</td>
<td id="T_1743a_row0_col3" class="data row0 col3">0</td>
<td id="T_1743a_row0_col4" class="data row0 col4">0</td>
<td id="T_1743a_row0_col5" class="data row0 col5">0</td>
<td id="T_1743a_row0_col6" class="data row0 col6">0</td>
<td id="T_1743a_row0_col7" class="data row0 col7">0</td>
<td id="T_1743a_row0_col8" class="data row0 col8">0</td>
<td id="T_1743a_row0_col9" class="data row0 col9">0</td>
<td id="T_1743a_row0_col10" class="data row0 col10">0</td>
<td id="T_1743a_row0_col11" class="data row0 col11">0</td>
<td id="T_1743a_row0_col12" class="data row0 col12">0</td>
<td id="T_1743a_row0_col13" class="data row0 col13">0</td>
<td id="T_1743a_row0_col14" class="data row0 col14">0</td>
<td id="T_1743a_row0_col15" class="data row0 col15">0</td>
<td id="T_1743a_row0_col16" class="data row0 col16">0</td>
<td id="T_1743a_row0_col17" class="data row0 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_1743a_row1_col0" class="data row1 col0">0</td>
<td id="T_1743a_row1_col1" class="data row1 col1">0</td>
<td id="T_1743a_row1_col2" class="data row1 col2">0</td>
<td id="T_1743a_row1_col3" class="data row1 col3">0</td>
<td id="T_1743a_row1_col4" class="data row1 col4">0</td>
<td id="T_1743a_row1_col5" class="data row1 col5">29</td>
<td id="T_1743a_row1_col6" class="data row1 col6">150</td>
<td id="T_1743a_row1_col7" class="data row1 col7">195</td>
<td id="T_1743a_row1_col8" class="data row1 col8">254</td>
<td id="T_1743a_row1_col9" class="data row1 col9">255</td>
<td id="T_1743a_row1_col10" class="data row1 col10">254</td>
<td id="T_1743a_row1_col11" class="data row1 col11">176</td>
<td id="T_1743a_row1_col12" class="data row1 col12">193</td>
<td id="T_1743a_row1_col13" class="data row1 col13">150</td>
<td id="T_1743a_row1_col14" class="data row1 col14">96</td>
<td id="T_1743a_row1_col15" class="data row1 col15">0</td>
<td id="T_1743a_row1_col16" class="data row1 col16">0</td>
<td id="T_1743a_row1_col17" class="data row1 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_1743a_row2_col0" class="data row2 col0">0</td>
<td id="T_1743a_row2_col1" class="data row2 col1">0</td>
<td id="T_1743a_row2_col2" class="data row2 col2">0</td>
<td id="T_1743a_row2_col3" class="data row2 col3">48</td>
<td id="T_1743a_row2_col4" class="data row2 col4">166</td>
<td id="T_1743a_row2_col5" class="data row2 col5">224</td>
<td id="T_1743a_row2_col6" class="data row2 col6">253</td>
<td id="T_1743a_row2_col7" class="data row2 col7">253</td>
<td id="T_1743a_row2_col8" class="data row2 col8">234</td>
<td id="T_1743a_row2_col9" class="data row2 col9">196</td>
<td id="T_1743a_row2_col10" class="data row2 col10">253</td>
<td id="T_1743a_row2_col11" class="data row2 col11">253</td>
<td id="T_1743a_row2_col12" class="data row2 col12">253</td>
<td id="T_1743a_row2_col13" class="data row2 col13">253</td>
<td id="T_1743a_row2_col14" class="data row2 col14">233</td>
<td id="T_1743a_row2_col15" class="data row2 col15">0</td>
<td id="T_1743a_row2_col16" class="data row2 col16">0</td>
<td id="T_1743a_row2_col17" class="data row2 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_1743a_row3_col0" class="data row3 col0">0</td>
<td id="T_1743a_row3_col1" class="data row3 col1">93</td>
<td id="T_1743a_row3_col2" class="data row3 col2">244</td>
<td id="T_1743a_row3_col3" class="data row3 col3">249</td>
<td id="T_1743a_row3_col4" class="data row3 col4">253</td>
<td id="T_1743a_row3_col5" class="data row3 col5">187</td>
<td id="T_1743a_row3_col6" class="data row3 col6">46</td>
<td id="T_1743a_row3_col7" class="data row3 col7">10</td>
<td id="T_1743a_row3_col8" class="data row3 col8">8</td>
<td id="T_1743a_row3_col9" class="data row3 col9">4</td>
<td id="T_1743a_row3_col10" class="data row3 col10">10</td>
<td id="T_1743a_row3_col11" class="data row3 col11">194</td>
<td id="T_1743a_row3_col12" class="data row3 col12">253</td>
<td id="T_1743a_row3_col13" class="data row3 col13">253</td>
<td id="T_1743a_row3_col14" class="data row3 col14">233</td>
<td id="T_1743a_row3_col15" class="data row3 col15">0</td>
<td id="T_1743a_row3_col16" class="data row3 col16">0</td>
<td id="T_1743a_row3_col17" class="data row3 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_1743a_row4_col0" class="data row4 col0">0</td>
<td id="T_1743a_row4_col1" class="data row4 col1">107</td>
<td id="T_1743a_row4_col2" class="data row4 col2">253</td>
<td id="T_1743a_row4_col3" class="data row4 col3">253</td>
<td id="T_1743a_row4_col4" class="data row4 col4">230</td>
<td id="T_1743a_row4_col5" class="data row4 col5">48</td>
<td id="T_1743a_row4_col6" class="data row4 col6">0</td>
<td id="T_1743a_row4_col7" class="data row4 col7">0</td>
<td id="T_1743a_row4_col8" class="data row4 col8">0</td>
<td id="T_1743a_row4_col9" class="data row4 col9">0</td>
<td id="T_1743a_row4_col10" class="data row4 col10">0</td>
<td id="T_1743a_row4_col11" class="data row4 col11">192</td>
<td id="T_1743a_row4_col12" class="data row4 col12">253</td>
<td id="T_1743a_row4_col13" class="data row4 col13">253</td>
<td id="T_1743a_row4_col14" class="data row4 col14">156</td>
<td id="T_1743a_row4_col15" class="data row4 col15">0</td>
<td id="T_1743a_row4_col16" class="data row4 col16">0</td>
<td id="T_1743a_row4_col17" class="data row4 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_1743a_row5_col0" class="data row5 col0">0</td>
<td id="T_1743a_row5_col1" class="data row5 col1">3</td>
<td id="T_1743a_row5_col2" class="data row5 col2">20</td>
<td id="T_1743a_row5_col3" class="data row5 col3">20</td>
<td id="T_1743a_row5_col4" class="data row5 col4">15</td>
<td id="T_1743a_row5_col5" class="data row5 col5">0</td>
<td id="T_1743a_row5_col6" class="data row5 col6">0</td>
<td id="T_1743a_row5_col7" class="data row5 col7">0</td>
<td id="T_1743a_row5_col8" class="data row5 col8">0</td>
<td id="T_1743a_row5_col9" class="data row5 col9">0</td>
<td id="T_1743a_row5_col10" class="data row5 col10">43</td>
<td id="T_1743a_row5_col11" class="data row5 col11">224</td>
<td id="T_1743a_row5_col12" class="data row5 col12">253</td>
<td id="T_1743a_row5_col13" class="data row5 col13">245</td>
<td id="T_1743a_row5_col14" class="data row5 col14">74</td>
<td id="T_1743a_row5_col15" class="data row5 col15">0</td>
<td id="T_1743a_row5_col16" class="data row5 col16">0</td>
<td id="T_1743a_row5_col17" class="data row5 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_1743a_row6_col0" class="data row6 col0">0</td>
<td id="T_1743a_row6_col1" class="data row6 col1">0</td>
<td id="T_1743a_row6_col2" class="data row6 col2">0</td>
<td id="T_1743a_row6_col3" class="data row6 col3">0</td>
<td id="T_1743a_row6_col4" class="data row6 col4">0</td>
<td id="T_1743a_row6_col5" class="data row6 col5">0</td>
<td id="T_1743a_row6_col6" class="data row6 col6">0</td>
<td id="T_1743a_row6_col7" class="data row6 col7">0</td>
<td id="T_1743a_row6_col8" class="data row6 col8">0</td>
<td id="T_1743a_row6_col9" class="data row6 col9">0</td>
<td id="T_1743a_row6_col10" class="data row6 col10">249</td>
<td id="T_1743a_row6_col11" class="data row6 col11">253</td>
<td id="T_1743a_row6_col12" class="data row6 col12">245</td>
<td id="T_1743a_row6_col13" class="data row6 col13">126</td>
<td id="T_1743a_row6_col14" class="data row6 col14">0</td>
<td id="T_1743a_row6_col15" class="data row6 col15">0</td>
<td id="T_1743a_row6_col16" class="data row6 col16">0</td>
<td id="T_1743a_row6_col17" class="data row6 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_1743a_row7_col0" class="data row7 col0">0</td>
<td id="T_1743a_row7_col1" class="data row7 col1">0</td>
<td id="T_1743a_row7_col2" class="data row7 col2">0</td>
<td id="T_1743a_row7_col3" class="data row7 col3">0</td>
<td id="T_1743a_row7_col4" class="data row7 col4">0</td>
<td id="T_1743a_row7_col5" class="data row7 col5">0</td>
<td id="T_1743a_row7_col6" class="data row7 col6">0</td>
<td id="T_1743a_row7_col7" class="data row7 col7">14</td>
<td id="T_1743a_row7_col8" class="data row7 col8">101</td>
<td id="T_1743a_row7_col9" class="data row7 col9">223</td>
<td id="T_1743a_row7_col10" class="data row7 col10">253</td>
<td id="T_1743a_row7_col11" class="data row7 col11">248</td>
<td id="T_1743a_row7_col12" class="data row7 col12">124</td>
<td id="T_1743a_row7_col13" class="data row7 col13">0</td>
<td id="T_1743a_row7_col14" class="data row7 col14">0</td>
<td id="T_1743a_row7_col15" class="data row7 col15">0</td>
<td id="T_1743a_row7_col16" class="data row7 col16">0</td>
<td id="T_1743a_row7_col17" class="data row7 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_1743a_row8_col0" class="data row8 col0">0</td>
<td id="T_1743a_row8_col1" class="data row8 col1">0</td>
<td id="T_1743a_row8_col2" class="data row8 col2">0</td>
<td id="T_1743a_row8_col3" class="data row8 col3">0</td>
<td id="T_1743a_row8_col4" class="data row8 col4">0</td>
<td id="T_1743a_row8_col5" class="data row8 col5">11</td>
<td id="T_1743a_row8_col6" class="data row8 col6">166</td>
<td id="T_1743a_row8_col7" class="data row8 col7">239</td>
<td id="T_1743a_row8_col8" class="data row8 col8">253</td>
<td id="T_1743a_row8_col9" class="data row8 col9">253</td>
<td id="T_1743a_row8_col10" class="data row8 col10">253</td>
<td id="T_1743a_row8_col11" class="data row8 col11">187</td>
<td id="T_1743a_row8_col12" class="data row8 col12">30</td>
<td id="T_1743a_row8_col13" class="data row8 col13">0</td>
<td id="T_1743a_row8_col14" class="data row8 col14">0</td>
<td id="T_1743a_row8_col15" class="data row8 col15">0</td>
<td id="T_1743a_row8_col16" class="data row8 col16">0</td>
<td id="T_1743a_row8_col17" class="data row8 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_1743a_row9_col0" class="data row9 col0">0</td>
<td id="T_1743a_row9_col1" class="data row9 col1">0</td>
<td id="T_1743a_row9_col2" class="data row9 col2">0</td>
<td id="T_1743a_row9_col3" class="data row9 col3">0</td>
<td id="T_1743a_row9_col4" class="data row9 col4">0</td>
<td id="T_1743a_row9_col5" class="data row9 col5">16</td>
<td id="T_1743a_row9_col6" class="data row9 col6">248</td>
<td id="T_1743a_row9_col7" class="data row9 col7">250</td>
<td id="T_1743a_row9_col8" class="data row9 col8">253</td>
<td id="T_1743a_row9_col9" class="data row9 col9">253</td>
<td id="T_1743a_row9_col10" class="data row9 col10">253</td>
<td id="T_1743a_row9_col11" class="data row9 col11">253</td>
<td id="T_1743a_row9_col12" class="data row9 col12">232</td>
<td id="T_1743a_row9_col13" class="data row9 col13">213</td>
<td id="T_1743a_row9_col14" class="data row9 col14">111</td>
<td id="T_1743a_row9_col15" class="data row9 col15">2</td>
<td id="T_1743a_row9_col16" class="data row9 col16">0</td>
<td id="T_1743a_row9_col17" class="data row9 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row10" class="row_heading level0 row10" data-quarto-table-cell-role="th">10</td>
<td id="T_1743a_row10_col0" class="data row10 col0">0</td>
<td id="T_1743a_row10_col1" class="data row10 col1">0</td>
<td id="T_1743a_row10_col2" class="data row10 col2">0</td>
<td id="T_1743a_row10_col3" class="data row10 col3">0</td>
<td id="T_1743a_row10_col4" class="data row10 col4">0</td>
<td id="T_1743a_row10_col5" class="data row10 col5">0</td>
<td id="T_1743a_row10_col6" class="data row10 col6">0</td>
<td id="T_1743a_row10_col7" class="data row10 col7">43</td>
<td id="T_1743a_row10_col8" class="data row10 col8">98</td>
<td id="T_1743a_row10_col9" class="data row10 col9">98</td>
<td id="T_1743a_row10_col10" class="data row10 col10">208</td>
<td id="T_1743a_row10_col11" class="data row10 col11">253</td>
<td id="T_1743a_row10_col12" class="data row10 col12">253</td>
<td id="T_1743a_row10_col13" class="data row10 col13">253</td>
<td id="T_1743a_row10_col14" class="data row10 col14">253</td>
<td id="T_1743a_row10_col15" class="data row10 col15">187</td>
<td id="T_1743a_row10_col16" class="data row10 col16">22</td>
<td id="T_1743a_row10_col17" class="data row10 col17">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="first-try-pixel-similarity" class="level2">
<h2 class="anchored" data-anchor-id="first-try-pixel-similarity">First Try: Pixel Similarity</h2>
<blockquote class="blockquote">
<p>jargon: Baseline: A simple model which you are confident should perform reasonably well. It should be very simple to implement, and very easy to test, so that you can then test each of your improved ideas, and make sure they are always better than your baseline. Without starting with a sensible baseline, it is very difficult to know whether your super-fancy models are actually any good. One good approach to creating a baseline is doing what we have done here: think of a simple, easy-to-implement model. Another good approach is to search around to find other people that have solved similar problems to yours, and download and run their code on your dataset. Ideally, try both of these!</p>
</blockquote>
<p><mark>&lt;mark&gt;I love this advice ^^^. I’ll try to follow it as much as possible.&lt;/mark&gt;</mark></p>
<div id="cell-18" class="cell" data-outputid="47a60c35-ed66-4f0b-abf6-542b983623dd" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">seven_tensors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sevens]</span>
<span id="cb14-2">three_tensors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> threes]</span>
<span id="cb14-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(three_tensors),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(seven_tensors)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(6131, 6265)</code></pre>
</div>
</div>
<div id="cell-19" class="cell" data-outputid="1ba29d9a-1c4b-498d-fcf2-86180c373e26" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">show_image(three_tensors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-20" class="cell" data-outputid="9d3597bf-f400-442f-c08b-cc87fd957abd" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">stacked_sevens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(seven_tensors).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb17-2">stacked_threes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(three_tensors).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb17-3">stacked_threes.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>torch.Size([6131, 28, 28])</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-outputid="0f11346d-4d8e-4d72-9621-4cec4ec8d573" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stacked_threes.shape)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>3</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-outputid="0ef247d5-310e-4005-ec38-c00f6641a7cc" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">stacked_threes.ndim</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>3</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-outputid="68ba5928-6201-451b-8388-0de3b3a4445c" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">mean3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_threes.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb23-2">show_image(mean3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-outputid="3882e076-28b2-400b-9dc7-6102000f1620" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">mean7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_sevens.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb24-2">show_image(mean7)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-25" class="cell" data-outputid="d890a751-9157-4e4a-f931-e78f7cb5fe3e" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_threes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb25-2">show_image(a_3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There are two main ways data scientists measure distance in this context:</p>
<ul>
<li>Take the mean of the <em>absolute value</em> of differences (absolute value is the function that replaces negative values with positive values). This is called the <em>mean absolute difference</em> or <em>L1 norm</em></li>
<li>Take the mean of the <em>square</em> of differences (which makes everything positive) and then take the <em>square root</em> (which undoes the squaring). This is called the <em>root mean squared error</em> (RMSE) or <em>L2 norm</em>.</li>
</ul>
<div id="cell-27" class="cell" data-outputid="63f93072-ee00-4fee-bef7-4a790d0f83f9" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">dist_3_abs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean3).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean()</span>
<span id="cb26-2">dist_3_sqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean().sqrt()</span>
<span id="cb26-3">dist_3_abs,dist_3_sqr</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tensor(0.1114), tensor(0.2021))</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-outputid="5e15a121-9740-41cc-fdbd-a55c043e9fc5" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">dist_7_abs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean()</span>
<span id="cb28-2">dist_7_sqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean().sqrt()</span>
<span id="cb28-3">dist_7_abs,dist_7_sqr</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(tensor(0.1586), tensor(0.3021))</code></pre>
</div>
</div>
<p>PyTorch already provides both of these as <em>loss functions</em>. You’ll find these inside <code>torch.nn.functional</code>, which the PyTorch team recommends importing as <code>F</code> (and is available by default under that name in fastai):</p>
<div id="cell-30" class="cell" data-outputid="5d615dff-0185-4bf8-a007-d1abf2b41b85" data-execution_count="20">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">F.l1_loss(a_3.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(),mean7), F.mse_loss(a_3,mean7).sqrt()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>(tensor(0.1586), tensor(0.3021))</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>S: Intuitively, the difference between L1 norm and mean squared error (MSE) is that the latter will penalize bigger mistakes more heavily than the former (and be more lenient with small mistakes).</p>
</blockquote>
</section>
<section id="computing-metrics-using-broadcasting" class="level2">
<h2 class="anchored" data-anchor-id="computing-metrics-using-broadcasting">Computing Metrics Using Broadcasting</h2>
<div id="cell-33" class="cell" data-outputid="ee76ded8-152e-4def-8160-e2f52e1b3202" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">valid_3_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o))</span>
<span id="cb32-2">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3'</span>).ls()])</span>
<span id="cb32-3">valid_3_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> valid_3_tens.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb32-4">valid_7_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o))</span>
<span id="cb32-5">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'7'</span>).ls()])</span>
<span id="cb32-6">valid_7_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> valid_7_tens.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb32-7">valid_3_tens.shape,valid_7_tens.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(torch.Size([1010, 28, 28]), torch.Size([1028, 28, 28]))</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-outputid="a538cb27-05b6-43e2-ca5f-032d0d7d8f96" data-execution_count="24">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mnist_distance(a,b): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>b).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb34-2">mnist_distance(a_3, mean3)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>tensor(0.1114)</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;This tuple <code>(-1,-2)</code> as an argument for the <code>mean()</code> method is not directly clear to me, so let’s have a look at the docs:&lt;/mark&gt;</mark></p>
<div id="cell-36" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">?torch.mean</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Docstring:</span>

mean(input, *, dtype=None) -&gt; Tensor



Returns the mean value of all elements in the :attr:`input` tensor.



Args:

    input (Tensor): the input tensor.



Keyword args:

    dtype (:class:`torch.dtype`, optional): the desired data type of returned tensor.

        If specified, the input tensor is casted to :attr:`dtype` before the operation

        is performed. This is useful for preventing data type overflows. Default: None.



Example::



    &gt;&gt;&gt; a = torch.randn(1, 3)

    &gt;&gt;&gt; a

    tensor([[ 0.2294, -0.5481,  1.3288]])

    &gt;&gt;&gt; torch.mean(a)

    tensor(0.3367)



.. function:: mean(input, dim, keepdim=False, *, dtype=None, out=None) -&gt; Tensor

   :noindex:



Returns the mean value of each row of the :attr:`input` tensor in the given

dimension :attr:`dim`. If :attr:`dim` is a list of dimensions,

reduce over all of them.





If :attr:`keepdim` is ``True``, the output tensor is of the same size

as :attr:`input` except in the dimension(s) :attr:`dim` where it is of size 1.

Otherwise, :attr:`dim` is squeezed (see :func:`torch.squeeze`), resulting in the

output tensor having 1 (or ``len(dim)``) fewer dimension(s).





Args:

    input (Tensor): the input tensor.

    dim (int or tuple of ints): the dimension or dimensions to reduce.

    keepdim (bool): whether the output tensor has :attr:`dim` retained or not.



Keyword args:

    dtype (:class:`torch.dtype`, optional): the desired data type of returned tensor.

        If specified, the input tensor is casted to :attr:`dtype` before the operation

        is performed. This is useful for preventing data type overflows. Default: None.

    out (Tensor, optional): the output tensor.



.. seealso::



    :func:`torch.nanmean` computes the mean value of `non-NaN` elements.



Example::



    &gt;&gt;&gt; a = torch.randn(4, 4)

    &gt;&gt;&gt; a

    tensor([[-0.3841,  0.6320,  0.4254, -0.7384],

            [-0.9644,  1.0131, -0.6549, -1.4279],

            [-0.2951, -1.3350, -0.7694,  0.5600],

            [ 1.0842, -0.9580,  0.3623,  0.2343]])

    &gt;&gt;&gt; torch.mean(a, 1)

    tensor([-0.0163, -0.5085, -0.4599,  0.1807])

    &gt;&gt;&gt; torch.mean(a, 1, True)

    tensor([[-0.0163],

            [-0.5085],

            [-0.4599],

            [ 0.1807]])

<span class="ansi-red-fg">Type:</span>      builtin_function_or_method</pre>
</div>
</div>
</div>
<p><mark>&lt;mark&gt;So the tuple represents a list of dimensions to reduce. In our case the last and second last dimension, which are the dimensions that contain the image pixel values (and the only two dimensions). In other words, this method calculates the average over all elements in the 24x24 matrix.&lt;/mark&gt;</mark></p>
<div id="cell-38" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">(a_3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>mean3).shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>torch.Size([28, 28])</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">sm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>mean3).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb39-2">avg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (a_3.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> a_3.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb39-3">avg</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>tensor(0.1114)</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;Same result!&lt;/mark&gt;</mark></p>
<div id="cell-41" class="cell" data-outputid="df75ce37-f441-4a3a-ae39-9a9b77a32f73" data-execution_count="38">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">valid_3_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mnist_distance(valid_3_tens, mean3)</span>
<span id="cb41-2">valid_3_dist, valid_3_dist.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(tensor([0.1634, 0.1145, 0.1363,  ..., 0.1105, 0.1111, 0.1640]),
 torch.Size([1010]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So here we did the same, but as the first argument we pass a whole stack of images from the validation set. What happened? This works because of a feature called broadcasting. Let’s dive into that:&lt;/mark&gt;</mark></p>
<div id="cell-43" class="cell" data-outputid="c0f521e0-b116-4039-9df5-561c6d140ed5">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"valid_3_tens.shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_3_tens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb43-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mean3.shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb43-3">diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (valid_3_tens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>mean3)</span>
<span id="cb43-4">diff.shape</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>valid_3_tens.shape: torch.Size([1010, 28, 28])
mean3.shape: torch.Size([28, 28])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>torch.Size([1010, 28, 28])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;<code>valid_3_tens</code> has shape <code>[1010, 28, 28]</code>, and <code>mean3</code> has shape <code>[28, 28]</code>. When we subtract them we don’t get an error, but a tensor with shape <code>[1010, 28, 28]</code>.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;So the broadcasting feature automatically expands the shape of <code>mean3</code> to <code>[1010, 28, 28]</code> so that it can be subtracted from <code>valid_3_tens</code>. There is a couple of conditions that need to be met for this to made possible. Time to experiment a bit with the help of Gemini:&lt;/mark&gt;</mark></p>
<blockquote class="blockquote">
<p>Broadcasting is PyTorch’s way of making operations work between tensors of different but compatible shapes. Instead of you writing explicit loops or manually reshaping/copying data, PyTorch does it conceptually (and efficiently in C++/CUDA).</p>
<p>The Core Idea: Pretend the smaller tensor is expanded (like stretching or copying) to match the shape of the larger tensor, then perform the operation elementwise. Crucially, no actual memory duplication happens.</p>
<p>Rules for Compatibility: PyTorch compares the shapes of two tensors elementwise, starting from the trailing dimensions (the rightmost ones) and working backward. Two dimensions are compatible if:</p>
<ol type="1">
<li>They are equal.</li>
<li>One of them is 1.</li>
</ol>
<p>If these conditions aren’t met for any dimension pair, the tensors are not broadcast-compatible, and you’ll get an error. If one tensor runs out of dimensions during the comparison (e.g., comparing a 3D tensor to a 2D tensor), dimensions of size 1 are assumed at the beginning of its shape.</p>
</blockquote>
<p><mark>&lt;mark&gt;Now that we know that, we can see that in our example, the two rightmost dimensions have the same size [28, 28], and then the mean3 tensor runs out of dimensions, so it is turned into [1, 28, 28], which makes it compatible for broadcasting. Subsequently the mean3 tensor is expanded into [1010, 28, 28], by repeating the same data 1010 times, so we can subtract the two tensors.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;Let’s play a bit with that…&lt;/mark&gt;</mark></p>
<div id="cell-47" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a tensor A with shape (5, 1, 4)</span></span>
<span id="cb46-2">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb46-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a tensor B with shape (5, 3, 1)</span></span>
<span id="cb46-4">B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb46-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a tensor C with shape (3, 4)</span></span>
<span id="cb46-6">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb46-7"></span>
<span id="cb46-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Can we add A and B?</span></span>
<span id="cb46-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb46-10">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> B</span>
<span id="cb46-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A + B result shape:"</span>, result.shape)</span>
<span id="cb46-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">RuntimeError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb46-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error adding A and B: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb46-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Can we add A and C?</span></span>
<span id="cb46-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb46-16">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> C</span>
<span id="cb46-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A + C result shape:"</span>, result.shape)</span>
<span id="cb46-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">RuntimeError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb46-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error adding A and C: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb46-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Can we add B and C?</span></span>
<span id="cb46-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb46-22">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> C</span>
<span id="cb46-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B + C result shape:"</span>, result.shape)</span>
<span id="cb46-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">RuntimeError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb46-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error adding B and C: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb46-26">    </span>
<span id="cb46-27">    </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A + B result shape: torch.Size([5, 3, 4])
A + C result shape: torch.Size([5, 3, 4])
B + C result shape: torch.Size([5, 3, 4])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;I think I’ve got that down now!&lt;/mark&gt;</mark></p>
<div id="cell-49" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> is_3(x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mnist_distance(x,mean3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> mnist_distance(x,mean7)</span></code></pre></div>
</div>
<div id="cell-50" class="cell" data-outputid="b5ac07c2-aa78-4a84-b0de-ed4d024e4341" data-execution_count="53">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">is_3(a_3), is_3(a_3).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(tensor(True), tensor(1.))</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-outputid="7db6134e-69ab-4850-8ed8-e76d4ec8b4f5" data-execution_count="54">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">is_3(valid_3_tens)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>tensor([True, True, True,  ..., True, True, True])</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-outputid="da9e6481-3dd3-476e-90ee-7e011bff1564" data-execution_count="55">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">accuracy_3s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>      is_3(valid_3_tens).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() .mean()</span>
<span id="cb53-2">accuracy_7s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> is_3(valid_7_tens).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()).mean()</span>
<span id="cb53-3"></span>
<span id="cb53-4">accuracy_3s,accuracy_7s,(accuracy_3s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>accuracy_7s)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(tensor(0.9168), tensor(0.9854), tensor(0.9511))</code></pre>
</div>
</div>
</section>
<section id="stochastic-gradient-descent-sgd" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-gradient-descent-sgd">Stochastic Gradient Descent (SGD)</h2>
<p>To be more specific, here are the steps that we are going to require, to turn this function into a machine learning classifier:</p>
<ol type="1">
<li><em>Initialize</em> the weights.</li>
<li>For each image, use these weights to <em>predict</em> whether it appears to be a 3 or a 7.</li>
<li>Based on these predictions, calculate how good the model is (its <em>loss</em>).</li>
<li>Calculate the <em>gradient</em>, which measures for each weight, how changing that weight would change the loss</li>
<li><em>Step</em> (that is, change) all the weights based on that calculation.</li>
<li>Go back to the step 2, and <em>repeat</em> the process.</li>
<li>Iterate until you decide to <em>stop</em> the training process (for instance, because the model is good enough or you don’t want to wait any longer).</li>
</ol>
<p>These seven steps, illustrated below, are the key to the training of all deep learning models. That deep learning turns out to rely entirely on these steps is extremely surprising and counterintuitive. It’s amazing that this process can solve such complex problems. But, as you’ll see, it really does!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/gradient-descent.png" class="img-fluid figure-img"></p>
<figcaption>Gradient descent</figcaption>
</figure>
</div>
<p>There are many different ways to do each of these seven steps, and we will be learning about them throughout the rest of this book. These are the details that make a big difference for deep learning practitioners, but it turns out that the general approach to each one generally follows some basic principles. Here are a few guidelines:</p>
<ul>
<li>Initialize:: We initialize the parameters to random values. This may sound surprising. There are certainly other choices we could make, such as initializing them to the percentage of times that pixel is activated for that category—but since we already know that we have a routine to improve these weights, it turns out that just starting with random weights works perfectly well.</li>
<li>Loss:: This is what Samuel referred to when he spoke of <em>testing the effectiveness of any current weight assignment in terms of actual performance</em>. We need some function that will return a number that is small if the performance of the model is good (the standard approach is to treat a small loss as good, and a large loss as bad, although this is just a convention).</li>
<li>Step:: A simple way to figure out whether a weight should be increased a bit, or decreased a bit, would be just to try it: increase the weight by a small amount, and see if the loss goes up or down. Once you find the correct direction, you could then change that amount by a bit more, and a bit less, until you find an amount that works well. However, this is slow! As we will see, the magic of calculus allows us to directly figure out in which direction, and by roughly how much, to change each weight, without having to try all these small changes. The way to do this is by calculating <em>gradients</em>. This is just a performance optimization, we would get exactly the same results by using the slower manual process as well.</li>
<li>Stop:: Once we’ve decided how many epochs to train the model for (a few suggestions for this were given in the earlier list), we apply that decision. This is where that decision is applied. For our digit classifier, we would keep training until the accuracy of the model started getting worse, or we ran out of time.</li>
</ul>
<div id="cell-57" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
</div>
<div id="cell-58" class="cell" data-outputid="d98e10a2-0307-41b6-ee92-2468fafdb63a">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">plot_function(f, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x**2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-59" class="cell" data-outputid="aa87d9be-88f4-4947-a5c7-60931453dd7f">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1">plot_function(f, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x**2'</span>)</span>
<span id="cb57-2">plt.scatter(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, f(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><img alt="A graph showing the squared function with the slope at one point" width="400" src="https://github.com/fastai/fastbook/blob/master/images/grad_illustration.svg?raw=1"></p>
<p><img alt="An illustration of gradient descent" width="400" src="https://github.com/fastai/fastbook/blob/master/images/chapter2_perfect.svg?raw=1"></p>
<section id="calculating-gradients" class="level3">
<h3 class="anchored" data-anchor-id="calculating-gradients">Calculating Gradients</h3>
<p>One important thing to be aware of is that our function has lots of weights that we need to adjust, so when we calculate the derivative we won’t get back one number, but lots of them—a gradient for every weight. But there is nothing mathematically tricky here; you can calculate the derivative with respect to one weight, and treat all the other ones as constant, then repeat that for each other weight. This is how all of the gradients are calculated, for every weight.</p>
<p>First, let’s pick a tensor value which we want gradients at:</p>
<div id="cell-64" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">xt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.</span>).requires_grad_()</span></code></pre></div>
</div>
<div id="cell-65" class="cell" data-outputid="4827e1c8-c423-467b-ecfb-a6b91491f734" data-execution_count="59">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">yt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(xt)</span>
<span id="cb59-2">yt</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>tensor(9., grad_fn=&lt;PowBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">yt.backward()</span></code></pre></div>
</div>
<div id="cell-67" class="cell" data-outputid="b06a9a97-7aec-4bb8-9928-30b9d198d740" data-execution_count="61">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">xt.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>tensor(6.)</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-outputid="d552e789-091e-4fbc-f162-198a3d98f605" data-execution_count="62">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">xt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.</span>]).requires_grad_()</span>
<span id="cb64-2">xt</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>tensor([ 3.,  4., 10.], requires_grad=True)</code></pre>
</div>
</div>
<div id="cell-69" class="cell" data-outputid="160d94d7-4469-4117-f974-40709a5820f4" data-execution_count="63">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb66-2"></span>
<span id="cb66-3">yt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(xt)</span>
<span id="cb66-4">yt</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>tensor(125., grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-outputid="502ca637-8d79-45db-9934-59239c3081ee" data-execution_count="64">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">yt.backward()</span>
<span id="cb68-2">xt.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>tensor([ 6.,  8., 20.])</code></pre>
</div>
</div>
</section>
<section id="stepping-with-a-learning-rate" class="level3">
<h3 class="anchored" data-anchor-id="stepping-with-a-learning-rate">Stepping With a Learning Rate</h3>
<p>w -= gradient(w) * lr</p>
</section>
<section id="an-end-to-end-sgd-example" class="level3">
<h3 class="anchored" data-anchor-id="an-end-to-end-sgd-example">An End-to-End SGD Example</h3>
<div id="cell-74" class="cell" data-outputid="8aa24e97-88ba-4625-d100-f809d8bb30f5" data-execution_count="65">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> time</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>tensor([ 0.,  1.,  2.,  3.,  4.,  5.,  6.,  7.,  8.,  9., 10., 11., 12., 13.,
        14., 15., 16., 17., 18., 19.])</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-outputid="da844c17-0939-46dc-fb2a-aef5159658cc" data-execution_count="66">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">speed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb72-2">plt.scatter(time,speed)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(t, params):</span>
<span id="cb73-2">    a,b,c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb73-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c</span></code></pre></div>
</div>
<div id="cell-77" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mse(preds, targets): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ((preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>targets)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean()</span></code></pre></div>
</div>
<section id="step-1-initialize-the-parameters" class="level4">
<h4 class="anchored" data-anchor-id="step-1-initialize-the-parameters">Step 1: Initialize the parameters</h4>
<div id="cell-79" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>).requires_grad_()</span></code></pre></div>
</div>
</section>
<section id="step-2-calculate-the-predictions" class="level4">
<h4 class="anchored" data-anchor-id="step-2-calculate-the-predictions">Step 2: Calculate the predictions</h4>
<div id="cell-81" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time, params)</span></code></pre></div>
</div>
<div id="cell-82" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> show_preds(preds, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb77-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>: ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>plt.subplots()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb77-3">    ax.scatter(time, speed)</span>
<span id="cb77-4">    ax.scatter(time, to_np(preds), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb77-5">    ax.set_ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</div>
<div id="cell-83" class="cell" data-outputid="ab42ec89-3091-45b3-a88b-6ff6afaef035" data-execution_count="74">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">show_preds(preds)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-3-calculate-the-loss" class="level4">
<h4 class="anchored" data-anchor-id="step-3-calculate-the-loss">Step 3: Calculate the loss</h4>
<div id="cell-85" class="cell" data-outputid="e3ad74c6-baa1-4e6d-9d39-d1c947517630" data-execution_count="75">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mse(preds, speed)</span>
<span id="cb79-2">loss</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor(82827.6641, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="step-4-calculate-the-gradients" class="level4">
<h4 class="anchored" data-anchor-id="step-4-calculate-the-gradients">Step 4: Calculate the gradients</h4>
<div id="cell-87" class="cell" data-outputid="ace11234-1204-49ce-cd09-512ea01378f2" data-execution_count="76">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">loss.backward()</span>
<span id="cb81-2">params.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>tensor([-96139.7500,  -6190.7744,   -445.6926])</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-outputid="3bf8436f-f151-4b43-e9dc-b7e4d8cae1f1" data-execution_count="77">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1">params.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>tensor([-0.9614, -0.0619, -0.0045])</code></pre>
</div>
</div>
<div id="cell-89" class="cell" data-outputid="eb25f1e0-bc91-4992-81f3-f96615d97b71" data-execution_count="78">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">params</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>tensor([-1.4608, -1.6226, -1.2073], requires_grad=True)</code></pre>
</div>
</div>
</section>
<section id="step-5-step-the-weights." class="level4">
<h4 class="anchored" data-anchor-id="step-5-step-the-weights.">Step 5: Step the weights.</h4>
<div id="cell-91" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span>
<span id="cb87-2">params.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> params.grad.data</span>
<span id="cb87-3">params.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<div id="cell-92" class="cell" data-outputid="0e37f27f-2abc-454e-f2fc-5c002544ebe7" data-execution_count="80">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time,params)</span>
<span id="cb88-2">mse(preds, speed)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>tensor(16233.4893, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<p>And take a look at the plot:</p>
<div id="cell-94" class="cell" data-outputid="f4739554-78b8-4ebf-aea0-c4cba04899fd" data-execution_count="81">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1">show_preds(preds)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-58-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-95" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> apply_step(params, prn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb91-2">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time, params)</span>
<span id="cb91-3">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mse(preds, speed)</span>
<span id="cb91-4">    loss.backward()</span>
<span id="cb91-5">    params.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> params.grad.data</span>
<span id="cb91-6">    params.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb91-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prn: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss.item())</span>
<span id="cb91-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> preds</span></code></pre></div>
</div>
<p><mark>&lt;mark&gt;Remember from my <a href="../how-does-a-neural-net-really-work/">previous post</a> that we had to do this: <code>with torch.no_grad(): abc -= abc.grad*0.01</code>, to make sure PyTorch won’t track this operation for calculating the gradient? So, why not here? Because it sets the result directly on the <code>data</code> property of <code>params</code>. That apparently prevents the gradient function tracker to ignore this operation.&lt;/mark&gt;</mark></p>
</section>
<section id="step-6-repeat-the-process" class="level4">
<h4 class="anchored" data-anchor-id="step-6-repeat-the-process">Step 6: Repeat the process</h4>
<div id="cell-98" class="cell" data-outputid="fc6a8e1c-fe18-4949-ee58-03846cf33b44" data-execution_count="83">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>): apply_step(params)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>16233.4892578125
3631.822265625
1247.1947021484375
795.9425659179688
710.5438842773438
694.3759765625
691.3086547851562
690.7203369140625
690.6011352539062
690.5706787109375</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-outputid="c3159e5a-c425-46cb-cddd-4f7c1f747636">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1">_,axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb94-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> axs: show_preds(apply_step(params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), ax)</span>
<span id="cb94-3">plt.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-61-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-7-stop" class="level4">
<h4 class="anchored" data-anchor-id="step-7-stop">Step 7: stop</h4>
</section>
</section>
<section id="summarizing-gradient-descent" class="level3">
<h3 class="anchored" data-anchor-id="summarizing-gradient-descent">Summarizing Gradient Descent</h3>
</section>
</section>
<section id="the-mnist-loss-function" class="level2">
<h2 class="anchored" data-anchor-id="the-mnist-loss-function">The MNIST Loss Function</h2>
<div id="cell-103" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1">stacked_sevens.shape, stacked_threes.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>(torch.Size([6265, 28, 28]), torch.Size([6131, 28, 28]))</code></pre>
</div>
</div>
<div id="cell-104" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1">train_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([stacked_threes, stacked_sevens]).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>)</span>
<span id="cb97-2">train_x.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>torch.Size([12396, 784])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;OK, so each image is now a vector of all 28*28 pixels, and dimension 0 basically points to each single image.&lt;/mark&gt;</mark></p>
<div id="cell-106" class="cell" data-outputid="315a6aee-59d4-4fa3-d94f-2dacbc5f4d1a" data-execution_count="94">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">train_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threes) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sevens)).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb99-2">train_x.shape,train_y.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(torch.Size([12396, 784]), torch.Size([12396, 1]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So, <code>[1]*len(threes) + [0]*len(sevens)</code> simply creates a vector with all the “labels” (dependent variables). Now what is this <code>unsqueeze(1)</code> doing? We have a row of labels, but if we want to match them up with <code>train_x</code> we need a column. That is exactly what <code>unsqueeze(1)</code> does. Let’s play a little bit with that:&lt;/mark&gt;</mark></p>
<div id="cell-108" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1">labels_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb101-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>labels_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb101-3">labels_list</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])</code></pre>
</div>
</div>
<div id="cell-109" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1">labels_list_unsqueezed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> labels_list.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb104-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>labels_list_unsqueezed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb104-3">labels_list_unsqueezed</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20, 1])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor([[1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0]])</code></pre>
</div>
</div>
<div id="cell-110" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">labels_list_unsqueezed0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> labels_list.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb107-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>labels_list_unsqueezed0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb107-3">labels_list_unsqueezed0</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([1, 20])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>tensor([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]])</code></pre>
</div>
</div>
<div id="cell-111" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb110" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1">labels_list_unsqueezed0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> labels_list[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb110-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>labels_list_unsqueezed0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb110-3">labels_list_unsqueezed0</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20, 1])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>tensor([[1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0]])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;Ah, look at that! It is the same as the <code>[:, None]</code> trick we saw in the previous post!&lt;/mark&gt;</mark></p>
<p>A <code>Dataset</code> in PyTorch is required to return a tuple of <code>(x,y)</code> when indexed. Python provides a <code>zip</code> function which, when combined with <code>list</code>, provides a simple way to get this functionality:</p>
<div id="cell-114" class="cell" data-outputid="8c1a9f7c-9215-45b2-8660-39bedfa43012" data-execution_count="95">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1">dset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(train_x,train_y))</span>
<span id="cb113-2">x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dset[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb113-3">x.shape,y</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>(torch.Size([784]), tensor([1]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So we now have a nice list of tuples of the form: (image vector, label)&lt;/mark&gt;</mark></p>
<div id="cell-116" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1">valid_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([valid_3_tens, valid_7_tens]).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>)</span>
<span id="cb115-2">valid_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_3_tens) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_7_tens)).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb115-3">valid_dset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(valid_x,valid_y))</span></code></pre></div>
</div>
<div id="cell-117" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init_params(size, std<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (torch.randn(size)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>std).requires_grad_()</span></code></pre></div>
</div>
<div id="cell-118" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1">weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div id="cell-119" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb118" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1">bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<blockquote class="blockquote">
<p>jargon: Parameters: The <em>weights</em> and <em>biases</em> of a model. The weights are the <code>w</code> in the equation <code>w*x+b</code>, and the biases are the <code>b</code> in that equation.</p>
</blockquote>
<div id="cell-121" class="cell" data-outputid="f6cce718-f766-45ca-83cc-73790f558ab4" data-execution_count="100">
<div class="sourceCode cell-code" id="cb119" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1">(train_x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>weights.T).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bias</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor([9.3344], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<p><img alt="Matrix multiplication" width="400" caption="Matrix multiplication" src="https://github.com/fastai/fastbook/blob/master/images/matmul2.svg?raw=1" id="matmul"></p>
<div id="cell-123" class="cell" data-outputid="ccc17977-b2ad-44cf-a96e-bd460bfa4e63" data-execution_count="101">
<div class="sourceCode cell-code" id="cb121" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> linear1(xb): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> xb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bias</span>
<span id="cb121-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear1(train_x)</span>
<span id="cb121-3">preds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>tensor([[ 9.3344],
        [ 0.8027],
        [ 7.0013],
        ...,
        [-1.8317],
        [ 3.5838],
        [-4.9083]], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-124" class="cell" data-outputid="93922ce2-b8ff-497e-d850-704f58e65d6d" data-execution_count="102">
<div class="sourceCode cell-code" id="cb123" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1">corrects <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> train_y</span>
<span id="cb123-2">corrects</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>tensor([[ True],
        [ True],
        [ True],
        ...,
        [ True],
        [False],
        [ True]])</code></pre>
</div>
</div>
<div id="cell-125" class="cell" data-outputid="fe59df8e-bf61-4e8d-9b65-1c7feea90df2" data-execution_count="103">
<div class="sourceCode cell-code" id="cb125" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1">corrects.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean().item()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>0.6630364656448364</code></pre>
</div>
</div>
<div id="cell-126" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad(): weights[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0001</span></span></code></pre></div>
</div>
<div id="cell-127" class="cell" data-outputid="13beb12e-c956-47b5-bc18-77f3acc0fc8a" data-execution_count="105">
<div class="sourceCode cell-code" id="cb128" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear1(train_x)</span>
<span id="cb128-2">((preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> train_y).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean().item()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>0.6630364656448364</code></pre>
</div>
</div>
<div id="cell-128" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb130" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1">trgts  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb130-2">prds   <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>])</span></code></pre></div>
</div>
<div id="cell-129" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb131" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mnist_loss(predictions, targets):</span>
<span id="cb131-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.where(targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>predictions, predictions).mean()</span></code></pre></div>
</div>
<div id="cell-130" class="cell" data-outputid="81242a2a-08af-41d9-cfe1-ba8daf9bd8f2" data-execution_count="108">
<div class="sourceCode cell-code" id="cb132" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1">torch.where(trgts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prds, prds)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>tensor([0.1000, 0.4000, 0.8000])</code></pre>
</div>
</div>
<div id="cell-131" class="cell" data-outputid="f5981d0d-e23f-461f-e6af-5abadb0958d6" data-execution_count="109">
<div class="sourceCode cell-code" id="cb134" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1">mnist_loss(prds,trgts)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>tensor(0.4333)</code></pre>
</div>
</div>
<div id="cell-132" class="cell" data-outputid="ef080630-a0be-4c5b-e695-aa31a542aff6" data-execution_count="110">
<div class="sourceCode cell-code" id="cb136" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1">mnist_loss(tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>]),trgts)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>tensor(0.2333)</code></pre>
</div>
</div>
<section id="sigmoid" class="level3">
<h3 class="anchored" data-anchor-id="sigmoid">Sigmoid</h3>
<div id="cell-134" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb138" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sigmoid(x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x))</span></code></pre></div>
</div>
<div id="cell-135" class="cell" data-outputid="cc8dad8b-0aa1-477a-818b-7d56750753c9">
<div class="sourceCode cell-code" id="cb139" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1">plot_function(torch.sigmoid, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sigmoid'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-86-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-136" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb140" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mnist_loss(predictions, targets):</span>
<span id="cb140-2">    predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predictions.sigmoid()</span>
<span id="cb140-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.where(targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>predictions, predictions).mean()</span></code></pre></div>
</div>
</section>
<section id="sgd-and-mini-batches" class="level3">
<h3 class="anchored" data-anchor-id="sgd-and-mini-batches">SGD and Mini-Batches</h3>
<div id="cell-138" class="cell" data-outputid="5508d8af-e61c-43a1-c93d-c8a479c75ad6" data-execution_count="113">
<div class="sourceCode cell-code" id="cb141" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1">coll <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb141-2">dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(coll, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb141-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(dl)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>[tensor([11,  4,  8,  9, 10]),
 tensor([13,  1,  5,  0, 14]),
 tensor([ 3, 12,  7,  2,  6])]</code></pre>
</div>
</div>
<div id="cell-139" class="cell" data-outputid="89a1da5b-c69c-414a-b981-d6a27db53159" data-execution_count="114">
<div class="sourceCode cell-code" id="cb143" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1">ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(string.ascii_lowercase))</span>
<span id="cb143-2">ds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>(#26) [(0, 'a'),(1, 'b'),(2, 'c'),(3, 'd'),(4, 'e'),(5, 'f'),(6, 'g'),(7, 'h'),(8, 'i'),(9, 'j')...]</code></pre>
</div>
</div>
<div id="cell-140" class="cell" data-outputid="278fb0fb-95f2-4be6-e540-46675a3c325b" data-execution_count="115">
<div class="sourceCode cell-code" id="cb145" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1">dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(ds, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb145-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(dl)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>[(tensor([17, 22, 12, 20,  9,  6]), ('r', 'w', 'm', 'u', 'j', 'g')),
 (tensor([21,  7, 14, 13,  0, 24]), ('v', 'h', 'o', 'n', 'a', 'y')),
 (tensor([ 3,  8,  4, 16, 19,  5]), ('d', 'i', 'e', 'q', 't', 'f')),
 (tensor([18, 11, 25, 23,  2,  1]), ('s', 'l', 'z', 'x', 'c', 'b')),
 (tensor([10, 15]), ('k', 'p'))]</code></pre>
</div>
</div>
</section>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting It All Together</h2>
<div id="cell-142" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb147" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1">weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb147-2">bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div id="cell-143" class="cell" data-outputid="b0303e03-745c-4651-cc8f-20a0e0dc5c2a" data-execution_count="117">
<div class="sourceCode cell-code" id="cb148" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1">dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(dset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb148-2">xb,yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first(dl)</span>
<span id="cb148-3">xb.shape,yb.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<div id="cell-144" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb150" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1">valid_dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(valid_dset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
</div>
<div id="cell-145" class="cell" data-outputid="75c7aa4b-f081-4778-bffb-c95f17e773d7" data-execution_count="119">
<div class="sourceCode cell-code" id="cb151" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1">batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb151-2">batch.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>torch.Size([4, 784])</code></pre>
</div>
</div>
<div id="cell-146" class="cell" data-outputid="850a3219-4492-4765-f05f-c1a423fefdde" data-execution_count="120">
<div class="sourceCode cell-code" id="cb153" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear1(batch)</span>
<span id="cb153-2">preds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>tensor([[0.7288],
        [2.3106],
        [2.0486],
        [1.4359]], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-147" class="cell" data-outputid="bb093d1b-adaf-4016-eaf1-3a776bf0756c" data-execution_count="121">
<div class="sourceCode cell-code" id="cb155" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mnist_loss(preds, train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb155-2">loss</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>tensor(0.1805, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-148" class="cell" data-outputid="f0548fc4-89c2-4855-a7ee-af6a838ea2bd" data-execution_count="122">
<div class="sourceCode cell-code" id="cb157" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1">loss.backward()</span>
<span id="cb157-2">weights.grad.shape,weights.grad.mean(),bias.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>(torch.Size([784, 1]), tensor(-0.0212), tensor([-0.1395]))</code></pre>
</div>
</div>
<div id="cell-149" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb159" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> calc_grad(xb, yb, model):</span>
<span id="cb159-2">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(xb)</span>
<span id="cb159-3">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mnist_loss(preds, yb)</span>
<span id="cb159-4">    loss.backward()</span></code></pre></div>
</div>
<div id="cell-150" class="cell" data-outputid="416d15a8-9438-436b-85b9-dd40a8295537" data-execution_count="124">
<div class="sourceCode cell-code" id="cb160" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1">calc_grad(batch, train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], linear1)</span>
<span id="cb160-2">weights.grad.mean(),bias.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">
<pre><code>(tensor(-0.0424), tensor([-0.2790]))</code></pre>
</div>
</div>
<div id="cell-151" class="cell" data-outputid="b4cb86b6-ddc4-4702-b8eb-b37b90ef52a5" data-execution_count="125">
<div class="sourceCode cell-code" id="cb162" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1">calc_grad(batch, train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], linear1)</span>
<span id="cb162-2">weights.grad.mean(),bias.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>(tensor(-0.0636), tensor([-0.4185]))</code></pre>
</div>
</div>
<div id="cell-152" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb164" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1">weights.grad.zero_()</span>
<span id="cb164-2">bias.grad.zero_()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</div>
<div id="cell-153" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb165" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> train_epoch(model, lr, params):</span>
<span id="cb165-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dl:</span>
<span id="cb165-3">        calc_grad(xb, yb, model)</span>
<span id="cb165-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> params:</span>
<span id="cb165-5">            p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> p.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>lr</span>
<span id="cb165-6">            p.grad.zero_()</span></code></pre></div>
</div>
<div id="cell-154" class="cell" data-outputid="7b48f81b-ccc5-42ec-d093-a813424506cb" data-execution_count="128">
<div class="sourceCode cell-code" id="cb166" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1">(preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>tensor([[True],
        [True],
        [True],
        [True]])</code></pre>
</div>
</div>
<div id="cell-155" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb168" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> batch_accuracy(xb, yb):</span>
<span id="cb168-2">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xb.sigmoid()</span>
<span id="cb168-3">    correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> yb</span>
<span id="cb168-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> correct.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span></code></pre></div>
</div>
<div id="cell-156" class="cell" data-outputid="218d0407-3016-48e7-df52-53b24dfa6a19" data-execution_count="130">
<div class="sourceCode cell-code" id="cb169" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1">batch_accuracy(linear1(batch), train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>tensor(1.)</code></pre>
</div>
</div>
<div id="cell-157" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb171" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_epoch(model):</span>
<span id="cb171-2">    accs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [batch_accuracy(model(xb), yb) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> valid_dl]</span>
<span id="cb171-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(torch.stack(accs).mean().item(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
</div>
<div id="cell-158" class="cell" data-outputid="d7b15398-25cb-419a-8fbd-586ce3241b7c" data-execution_count="132">
<div class="sourceCode cell-code" id="cb172" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1">validate_epoch(linear1)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>0.7649</code></pre>
</div>
</div>
<div id="cell-159" class="cell" data-outputid="b1f8023e-593d-4bc3-ae60-08cecf07e809" data-execution_count="133">
<div class="sourceCode cell-code" id="cb174" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span></span>
<span id="cb174-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights,bias</span>
<span id="cb174-3">train_epoch(linear1, lr, params)</span>
<span id="cb174-4">validate_epoch(linear1)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>0.8446</code></pre>
</div>
</div>
<div id="cell-160" class="cell" data-outputid="9bb7d42a-4c9c-4a6f-8cb5-898a9aec1615" data-execution_count="134">
<div class="sourceCode cell-code" id="cb176" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb176-2">    train_epoch(linear1, lr, params)</span>
<span id="cb176-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validate_epoch(linear1), end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.9144 0.9369 0.9462 0.9545 0.9589 0.9603 0.9628 0.9638 0.9638 0.9643 0.9657 0.9652 0.9657 0.9677 0.9681 0.9681 0.9696 0.9696 0.9706 0.972 </code></pre>
</div>
</div>
<section id="creating-an-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="creating-an-optimizer">Creating an Optimizer</h3>
<div id="cell-162" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb178" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1">linear_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div id="cell-163" class="cell" data-outputid="bbe3cce1-6ac7-4a60-9641-7aec07409b7e" data-execution_count="136">
<div class="sourceCode cell-code" id="cb179" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1">w,b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear_model.parameters()</span>
<span id="cb179-2">w.shape,b.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>(torch.Size([1, 784]), torch.Size([1]))</code></pre>
</div>
</div>
<div id="cell-164" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb181" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> BasicOptim:</span>
<span id="cb181-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,params,lr): <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(params),lr</span>
<span id="cb181-3"></span>
<span id="cb181-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> step(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb181-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params: p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> p.grad.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lr</span>
<span id="cb181-6"></span>
<span id="cb181-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> zero_grad(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb181-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params: p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<div id="cell-165" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb182" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BasicOptim(linear_model.parameters(), lr)</span></code></pre></div>
</div>
<div id="cell-166" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb183" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> train_epoch(model):</span>
<span id="cb183-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dl:</span>
<span id="cb183-3">        calc_grad(xb, yb, model)</span>
<span id="cb183-4">        opt.step()</span>
<span id="cb183-5">        opt.zero_grad()</span></code></pre></div>
</div>
<div id="cell-167" class="cell" data-outputid="7eb5a6bd-adef-4f94-d464-6f41ada4492b" data-execution_count="140">
<div class="sourceCode cell-code" id="cb184" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1">validate_epoch(linear_model)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>0.6292</code></pre>
</div>
</div>
<div id="cell-168" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb186" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> train_model(model, epochs):</span>
<span id="cb186-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(epochs):</span>
<span id="cb186-3">        train_epoch(model)</span>
<span id="cb186-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validate_epoch(model), end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)</span></code></pre></div>
</div>
<div id="cell-169" class="cell" data-outputid="7fa40c27-a23c-4181-e616-e489f28c5b01" data-execution_count="142">
<div class="sourceCode cell-code" id="cb187" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1">train_model(linear_model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4932 0.8052 0.8525 0.917 0.9346 0.9487 0.957 0.9624 0.9658 0.9678 0.9692 0.9717 0.9736 0.9746 0.9761 0.9765 0.9775 0.978 0.978 0.979 </code></pre>
</div>
</div>
<div id="cell-170" class="cell" data-outputid="bc32f893-4ad0-4dc3-8ede-0f23dea4355a" data-execution_count="143">
<div class="sourceCode cell-code" id="cb189" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1">linear_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb189-2">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SGD(linear_model.parameters(), lr)</span>
<span id="cb189-3">train_model(linear_model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4932 0.7759 0.8603 0.9179 0.9346 0.9516 0.957 0.9634 0.9658 0.9673 0.9697 0.9717 0.9746 0.9751 0.9761 0.977 0.9775 0.978 0.978 0.9785 </code></pre>
</div>
</div>
<div id="cell-171" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb191" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoaders(dl, valid_dl)</span></code></pre></div>
</div>
<div id="cell-172" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb192" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), opt_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SGD,</span>
<span id="cb192-2">                loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mnist_loss, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_accuracy)</span></code></pre></div>
</div>
<div id="cell-173" class="cell" data-outputid="7c61af77-bdc5-4360-d785-14e65c6895b1" data-execution_count="146">
<div class="sourceCode cell-code" id="cb193" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1">learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.636803</td>
<td>0.503571</td>
<td>0.495584</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.569794</td>
<td>0.217214</td>
<td>0.807655</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.208501</td>
<td>0.165452</td>
<td>0.851816</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.090031</td>
<td>0.101155</td>
<td>0.914622</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.046536</td>
<td>0.074791</td>
<td>0.935231</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.029671</td>
<td>0.060303</td>
<td>0.948970</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.022822</td>
<td>0.051260</td>
<td>0.956330</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.019821</td>
<td>0.045237</td>
<td>0.962218</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.018322</td>
<td>0.040985</td>
<td>0.965653</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.017435</td>
<td>0.037833</td>
<td>0.968106</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="adding-a-nonlinearity" class="level2">
<h2 class="anchored" data-anchor-id="adding-a-nonlinearity">Adding a Nonlinearity</h2>
<div id="cell-175" class="cell">
<div class="sourceCode cell-code" id="cb194" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simple_net(xb):</span>
<span id="cb194-2">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>w1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb194-3">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(tensor(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>))</span>
<span id="cb194-4">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>w2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb194-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> res</span></code></pre></div>
</div>
<div id="cell-176" class="cell">
<div class="sourceCode cell-code" id="cb195" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1">w1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span>
<span id="cb195-2">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb195-3">w2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb195-4">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<p>The key point about this is that <code>w1</code> has 30 output activations (which means that <code>w2</code> must have 30 input activations, so they match). That means that the first layer can construct 30 different features, each representing some different mix of pixels. You can change that <code>30</code> to anything you like, to make the model more or less complex.</p>
<p><mark>&lt;mark&gt;So, the <code>w1</code> matrix has 30 rows and 784 columns, which means that it can take a vector of 784 pixel values as input (the image we want to classify), and return a vector of 30 values. The <code>w2</code> matrix has 1 row and 30 columns, which means that it can take a vector of 30 values as input, and return a scalar (which is the probability).&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;These 30 output activations are synonym to a layer of 30 nodes. Each of these 30 nodes has it’s own set of 784 weights that we try to optimize. So more nodes means more possible feature detectors or pattern recognizers that our model can learn. We can think of each of those 30 nodes as becoming specialized in detecting different aspects of what makes a digit look like a “3” versus a “7”.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;I like how Claude said it while explaining this to me:&lt;/mark&gt;</mark></p>
<blockquote class="blockquote">
<p>Here’s a helpful way to think about it: imagine you’re trying to distinguish between cats and dogs, and you have 30 friends helping you. Each friend specializes in looking for different features - one focuses on ear shape, another on tail length, another on fur texture, and so on. Each friend gives you their opinion (a number between, say, -10 and +10), and then you have to weigh all 30 opinions to make your final decision. That’s essentially what your two-layer network is doing.</p>
<p>The beauty is that during training, the network automatically figures out what each of those 30 “friends” should specialize in looking for. You don’t have to tell it “node 1, you focus on curves” - it discovers these useful features on its own through the optimization process.</p>
</blockquote>
<p><mark>&lt;mark&gt;I was then wondering: what if some or all nodes try to specialize in the same feature? There are two reasons why this is not likely:</mark></p>
<p><mark>1. We initialize the weights randomly, so each node starts with a different perspective.</mark></p>
<p><mark>2. The optimization process will adjust the weights in such a way that it minimizes the loss function, which means that if two nodes try to learn the same feature, one of them will end up being less effective and will be encouraged to learn something else.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;I still have to think hard to get the matrix juggling down, so let’s create a super-tiny net:&lt;/mark&gt;</mark></p>
<div id="cell-178" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb196" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Our tiny network layer</span></span>
<span id="cb196-2">layer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4 inputs (2x2 image flattened), 3 outputs</span></span>
<span id="cb196-3"></span>
<span id="cb196-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample 2x2 image</span></span>
<span id="cb196-5">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>],</span>
<span id="cb196-6">                [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span>]])</span>
<span id="cb196-7"></span>
<span id="cb196-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the image to a column vector</span></span>
<span id="cb196-9">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.flatten()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x = [1.0, 2.0, 3.0, 4.0] with shape [4]</span></span>
<span id="cb196-10"></span>
<span id="cb196-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The weights and biases are already initialized by nn.Linear</span></span>
<span id="cb196-12">w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer.weight  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape [3, 4]</span></span>
<span id="cb196-13">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer.bias      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape [3]</span></span>
<span id="cb196-14"></span>
<span id="cb196-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Weights </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Bias </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb196-16"></span>
<span id="cb196-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiplication: w @ x (shape [3,4] @ [4] = [3])</span></span>
<span id="cb196-18">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb196-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Output shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Output: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb196-20"></span>
<span id="cb196-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now apply ReLU activation</span></span>
<span id="cb196-22">output2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.relu(output)</span>
<span id="cb196-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Output after ReLU shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Output: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb196-24"></span>
<span id="cb196-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Last layer</span></span>
<span id="cb196-26">layer2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 inputs, 1 output</span></span>
<span id="cb196-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weights and biases for the last layer</span></span>
<span id="cb196-28">w2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer2.weight  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape [1, 3]</span></span>
<span id="cb196-29">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer2.bias      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape [1]</span></span>
<span id="cb196-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Final output</span></span>
<span id="cb196-31">final_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> w2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> output2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb196-32"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Final output shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>final_output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Final output: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>final_output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb196-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Final output after sigmoid activation</span></span>
<span id="cb196-34">final_output_sigmoid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sigmoid(final_output)</span>
<span id="cb196-35"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Final output after sigmoid shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>final_output_sigmoid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Final output: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>final_output_sigmoid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weights torch.Size([3, 4]): tensor([[ 0.0777,  0.2776,  0.4277,  0.0007],
        [-0.4654, -0.0821,  0.1229,  0.2742],
        [ 0.1707, -0.2651,  0.3052,  0.1164]]), Bias torch.Size([3]): tensor([-0.1928, -0.2575,  0.3110])
Output shape: torch.Size([3]), Output: tensor([1.7258, 0.5783, 1.3328])
Output after ReLU shape: torch.Size([3]), Output: tensor([1.7258, 0.5783, 1.3328])
Final output shape: torch.Size([1]), Final output: tensor([-0.2682])
Final output after sigmoid shape: torch.Size([1]), Final output: tensor([0.4333])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;This tiny model is visualized below. The first layer has 3 nodes and the second linear layer has 1 node.&lt;/mark&gt;</mark></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/super-tiny.png" class="img-fluid figure-img"></p>
<figcaption>Super-tiny net. Made with <a href="https://alexlenail.me/NN-SVG/index.html" target="_blank">NN-SVG</a></figcaption>
</figure>
</div>
<div id="cell-181" class="cell" data-outputid="11c5fd28-a441-4c5a-da21-67cf34e6fd23">
<div class="sourceCode cell-code" id="cb198" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1">plot_function(F.relu)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-125-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-182" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb199" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1">simple_net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Sequential(</span>
<span id="cb199-2">    nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>),</span>
<span id="cb199-3">    nn.ReLU(),</span>
<span id="cb199-4">    nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb199-5">)</span></code></pre></div>
</div>
<div id="cell-183" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb200" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, simple_net, opt_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SGD,</span>
<span id="cb200-2">                loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mnist_loss, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_accuracy)</span></code></pre></div>
</div>
<div id="cell-184" class="cell" data-outputid="985cd0b9-576f-4ff4-8467-d0be68ef488d">
<div class="sourceCode cell-code" id="cb201" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1">learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.325859</td>
<td>0.411601</td>
<td>0.504907</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.150409</td>
<td>0.233516</td>
<td>0.798332</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.082649</td>
<td>0.116558</td>
<td>0.913150</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.054023</td>
<td>0.078485</td>
<td>0.940628</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.040843</td>
<td>0.061257</td>
<td>0.954858</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.034143</td>
<td>0.051604</td>
<td>0.963199</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.030300</td>
<td>0.045509</td>
<td>0.965653</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.027805</td>
<td>0.041319</td>
<td>0.967615</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.026009</td>
<td>0.038248</td>
<td>0.968597</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.024617</td>
<td>0.035891</td>
<td>0.969578</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.023491</td>
<td>0.034015</td>
<td>0.972031</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.022551</td>
<td>0.032479</td>
<td>0.973994</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.021751</td>
<td>0.031189</td>
<td>0.974485</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.021059</td>
<td>0.030088</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.020454</td>
<td>0.029132</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.019918</td>
<td>0.028290</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.019438</td>
<td>0.027543</td>
<td>0.976938</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.019006</td>
<td>0.026874</td>
<td>0.977920</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.018614</td>
<td>0.026271</td>
<td>0.978410</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.018255</td>
<td>0.025726</td>
<td>0.978901</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.017924</td>
<td>0.025230</td>
<td>0.979392</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.017619</td>
<td>0.024777</td>
<td>0.979882</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.017335</td>
<td>0.024363</td>
<td>0.980373</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.017070</td>
<td>0.023981</td>
<td>0.980864</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.016821</td>
<td>0.023629</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>25</td>
<td>0.016588</td>
<td>0.023304</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>26</td>
<td>0.016368</td>
<td>0.023003</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>27</td>
<td>0.016160</td>
<td>0.022723</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>28</td>
<td>0.015963</td>
<td>0.022462</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>29</td>
<td>0.015775</td>
<td>0.022220</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>30</td>
<td>0.015597</td>
<td>0.021993</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>31</td>
<td>0.015427</td>
<td>0.021782</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>32</td>
<td>0.015265</td>
<td>0.021584</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>33</td>
<td>0.015110</td>
<td>0.021398</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>34</td>
<td>0.014961</td>
<td>0.021224</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>35</td>
<td>0.014819</td>
<td>0.021060</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>36</td>
<td>0.014682</td>
<td>0.020906</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>37</td>
<td>0.014550</td>
<td>0.020760</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>38</td>
<td>0.014423</td>
<td>0.020622</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>39</td>
<td>0.014301</td>
<td>0.020492</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-185" class="cell" data-outputid="fbd769f0-d426-456a-b942-d67e25f8f185" data-execution_count="163">
<div class="sourceCode cell-code" id="cb202" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1">plt.plot(L(learn.recorder.values).itemgot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/mnist-basics/index_files/figure-html/cell-129-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-186" class="cell" data-outputid="b6acc6c6-dbbb-4da9-9a90-b5ce50073eb2" data-execution_count="164">
<div class="sourceCode cell-code" id="cb203" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1">learn.recorder.values[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>0.981844961643219</code></pre>
</div>
</div>
<section id="going-deeper" class="level3">
<h3 class="anchored" data-anchor-id="going-deeper">Going Deeper</h3>
<div id="cell-188" class="cell" data-outputid="978109c2-b940-4993-d4c1-1ac86504fda6">
<div class="sourceCode cell-code" id="cb205" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(path)</span>
<span id="cb205-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, pretrained<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb205-3">                    loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>F.cross_entropy, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accuracy)</span>
<span id="cb205-4">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
</div>
<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
0.082135
</td>
<td>
0.014342
</td>
<td>
0.996565
</td>
<td>
02:26
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="jargon-recap" class="level2">
<h2 class="anchored" data-anchor-id="jargon-recap">Jargon Recap</h2>
<p>Congratulations: you now know how to create and train a deep neural network from scratch! We’ve gone through quite a few steps to get to this point, but you might be surprised at how simple it really is.</p>
<p>Now that we are at this point, it is a good opportunity to define, and review, some jargon and key concepts.</p>
<p>A neural network contains a lot of numbers, but they are only of two types: numbers that are calculated, and the parameters that these numbers are calculated from. This gives us the two most important pieces of jargon to learn:</p>
<ul>
<li><mark>Activations: Numbers that are calculated (both by linear and nonlinear layers)</mark></li>
<li><mark>Parameters: Numbers that are randomly initialized, and optimized (that is, the numbers that define the model)</mark></li>
</ul>
<p>We will often talk in this book about activations and parameters. Remember that they have very specific meanings. They are numbers. They are not abstract concepts, but they are actual specific numbers that are in your model. Part of becoming a good deep learning practitioner is getting used to the idea of actually looking at your activations and parameters, and plotting them and testing whether they are behaving correctly.</p>
<p>Our activations and parameters are all contained in <em>tensors</em>. These are simply regularly shaped arrays—for example, a matrix. Matrices have rows and columns; we call these the <em>axes</em> or <em>dimensions</em>. The number of dimensions of a tensor is its <em>rank</em>. There are some special tensors:</p>
<ul>
<li>Rank zero: scalar</li>
<li>Rank one: vector</li>
<li>Rank two: matrix</li>
</ul>
<p>A neural network contains a number of layers. Each layer is either <em>linear</em> or <em>nonlinear</em>. We generally alternate between these two kinds of layers in a neural network. Sometimes people refer to both a linear layer and its subsequent nonlinearity together as a single layer. Yes, this is confusing. Sometimes a nonlinearity is referred to as an <em>activation function</em>.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ReLU</td>
<td>Function that returns 0 for negative numbers and doesn’t change positive numbers.</td>
</tr>
<tr class="even">
<td>Mini-batch</td>
<td>A small group of inputs and labels gathered together in two arrays. A gradient descent step is updated on this batch (rather than a whole epoch).</td>
</tr>
<tr class="odd">
<td>Forward pass</td>
<td>Applying the model to some input and computing the predictions.</td>
</tr>
<tr class="even">
<td>Loss</td>
<td>A value that represents how well (or badly) our model is doing.</td>
</tr>
<tr class="odd">
<td>Gradient</td>
<td>The derivative of the loss with respect to some parameter of the model.</td>
</tr>
<tr class="even">
<td>Backward pass</td>
<td>Computing the gradients of the loss with respect to all model parameters.</td>
</tr>
<tr class="odd">
<td>Gradient descent</td>
<td>Taking a step in the directions opposite to the gradients to make the model parameters a little bit better.</td>
</tr>
<tr class="even">
<td>Learning rate</td>
<td>The size of the step we take when applying SGD to update the parameters of the model.</td>
</tr>
</tbody>
</table>
<p><mark>&lt;mark&gt;And that concludes lesson 3 of the course (and chapter 4 of the book) for me. I’ll move on with chapter 5 of the book instead of lesson 4 of the course. Let’s get all the computer vision stuff done before moving to NLP.&lt;/mark&gt;</mark></p>


</section>
</section>

 ]]></description>
  <category>machine learning</category>
  <category>fast.ai</category>
  <guid>https://dronelab.dev/posts/mnist-basics/</guid>
  <pubDate>Tue, 10 Jun 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/mnist-basics/MNIST.png" medium="image" type="image/png" height="75" width="144"/>
</item>
<item>
  <title>How does a neural net really work?</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/how-does-a-neural-net-really-work/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-06-08</p>
</header>


<p><a href="https://colab.research.google.com/github/pors/dronelab/blob/main/posts/how-does-a-neural-net-really-work/index.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="fitting-a-function-with-gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="fitting-a-function-with-gradient-descent">Fitting a function with gradient descent</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook is a copy of <a href="https://www.kaggle.com/code/jhoward/how-does-a-neural-net-really-work" target="_blank">How does a neural net really work?</a> by Jeremy Howard as part of the Fast.ai course <a href="https://course.fast.ai/" target="_blank">Practical Deep Learning for Coders</a>.</p>
<p>I added and removed code and markdown here and there reflecting my own understanding of the topic. Not very interesting (aka boring) for 99+% of you, it is mostly for my own reference. My comments are marked with <mark>&lt;mark&gt;…&lt;/mark&gt;</mark> <sup>1</sup>.</p>
<p>For drone related stuff, see the <a href="../../series/index.html">Code, Fly &amp; AI Series</a>.</p>
</div>
</div>
<p>A neural network is just a mathematical function. In the most standard kind of neural network, the function:</p>
<ol type="1">
<li>Multiplies each input by a number of values. These values are known as <em>parameters</em></li>
<li>Adds them up for each group of values</li>
<li>Replaces the negative numbers with zeros</li>
</ol>
<p>This represents one “layer”. Then these three steps are repeated, using the outputs of the previous layer as the inputs to the next layer. Initially, the parameters in this function are selected randomly. Therefore a newly created neural network doesn’t do anything useful at all – it’s just random!</p>
<p><mark>&lt;mark&gt;If you don’t use random parameters, but the same number for each parameter, the function won’t be able to learn anything, because each node in the layer will be the same, and the output will be the same for all inputs.&lt;/mark&gt;</mark></p>
<p>To get the function to “learn” to do something useful, we have to change the parameters to make them “better” in some way. We do this using <em>gradient descent</em>. Let’s see how this works…</p>
<div id="cell-4" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ipywidgets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> interact</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.basics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-3"></span>
<span id="cb1-4">plt.rc(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'figure'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_function(f, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb1-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb1-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ylim: plt.ylim(ylim)</span>
<span id="cb1-9">    plt.plot(x, f(x), color)</span>
<span id="cb1-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> title <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>: plt.title(title)</span></code></pre></div>
</div>
<p>To learn how gradient descent works, we’re going to start by fitting a quadratic, since that’s a function most of us are probably more familiar with than a neural network. Here’s the quadratic we’re going to try to fit:</p>
<div id="cell-6" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-2"></span>
<span id="cb2-3">plot_function(f, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"$3x^2 + 2x + 1$"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/how-does-a-neural-net-really-work/index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This quadratic is of the form <img src="https://latex.codecogs.com/png.latex?ax%5E2+bx+c">, with parameters <img src="https://latex.codecogs.com/png.latex?a=3">, <img src="https://latex.codecogs.com/png.latex?b=2">, <img src="https://latex.codecogs.com/png.latex?c=1">. To make it easier to try out different quadratics for fitting a model to the data we’ll create, let’s create a function that calculates the value of a point on any quadratic:</p>
<div id="cell-8" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> quad(a, b, c, x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c</span></code></pre></div>
</div>
<p>If we fix some particular values of a, b, and c, then we’ll have made a quadratic. To fix values passed to a function in python, we use the <code>partial</code> function, like so:</p>
<div id="cell-10" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mk_quad(a,b,c): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> partial(quad, a,b,c)</span></code></pre></div>
</div>
<p><mark>&lt;mark&gt;So what we did here is freeze the function for a set of fixed parameters. We can now use this function to calculate the value of the quadratic for any x we pass to it. It is like we stored a model to use for inference.&lt;/mark&gt;</mark></p>
<p>So for instance, we can recreate our previous quadratic:</p>
<div id="cell-13" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-2">plot_function(f2)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/how-does-a-neural-net-really-work/index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s simulate making some noisy measurements of our quadratic <code>f</code>. We’ll then use gradient descent to see if we can recreate the original function from the data.</p>
<p>Here’s a couple of functions to add some random noise to data:</p>
<div id="cell-15" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> noise(x, scale): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.random.normal(scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.shape)</span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> add_noise(x, mult, add): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>noise(x,mult)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise(x,add)</span></code></pre></div>
</div>
<p>Let’s use the now to create our noisy measurements based on the quadratic above:</p>
<div id="cell-17" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb7-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> add_noise(f(x), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span></code></pre></div>
</div>
<p><mark>&lt;mark&gt;What is that <code>[:,None]</code> doing there? Let’s inspect what is happening…&lt;/mark&gt;</mark></p>
<div id="cell-19" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb8-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original tensor:"</span>, a)</span>
<span id="cb8-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shape:"</span>, a.shape)</span>
<span id="cb8-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of dimensions:"</span>, a.ndim)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original tensor: tensor([-2.0000, -0.6667,  0.6667,  2.0000])
Shape: torch.Size([4])
Number of dimensions: 1</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb10-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shape after [:, None]:"</span>, b.shape)</span>
<span id="cb10-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of dimensions now:"</span>, b.ndim)</span>
<span id="cb10-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The actual tensor looks like:"</span>)</span>
<span id="cb10-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(b)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape after [:, None]: torch.Size([4, 1])
Number of dimensions now: 2
The actual tensor looks like:
tensor([[-2.0000],
        [-0.6667],
        [ 0.6667],
        [ 2.0000]])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;[:] after a list is typically a slice. In PyTorch and Numpy you can actually use commas to address multiple dimensions of the array/tensor. Apparently, if you use <code>[:, None]</code>, it adds a new axis to the array. In this case, it is reshaping the 1D array of four values into a 2D array with one column.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;The reason this is done is that the <code>np.random.normal</code> function expects a 2D array as input, where each row represents a sample and each column represents a feature. By reshaping the array to have one column, we ensure that the input meets this requirement.&lt;/mark&gt;</mark></p>
<p>Here’s the first few values of each of <code>x</code> and <code>y</code>:</p>
<div id="cell-23" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>],y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>(tensor([[-2.0000],
         [-1.7895],
         [-1.5789],
         [-1.3684],
         [-1.1579]]),
 tensor([[11.8690],
         [ 6.5433],
         [ 5.9396],
         [ 2.6304],
         [ 1.7947]], dtype=torch.float64))</code></pre>
</div>
</div>
<p>As you can see, they’re <em>tensors</em>. A tensor is just like an <code>array</code> in numpy. A tensor can be a single number (a <em>scalar</em> or <em>rank-0 tensor</em>), a list of numbers (a <em>vector</em> or <em>rank-1 tensor</em>), a table of numbers (a <em>matrix</em> or <em>rank-0 tensor</em>), a table of tables of numbers (a <em>rank-3 tensor</em>), and so forth.</p>
<p>We’re not going to learn much about our data by just looking at the raw numbers, so let’s draw a picture:</p>
<div id="cell-25" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">plt.scatter(x,y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/how-does-a-neural-net-really-work/index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>How do we find values of a, b, and c which fit this data? One approach is to try a few values and see what fits. Here’s a function which overlays a quadratic on top of our data, along with some sliders to change a, b, and c, and see how it looks:</p>
<div id="cell-27" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>)</span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_quad(a, b, c):</span>
<span id="cb15-3">    plt.scatter(x,y)</span>
<span id="cb15-4">    plot_function(mk_quad(a,b,c), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2337997712e048de82cc224dae5d59f3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p><mark>&lt;mark&gt;The widget with sliders doesn’t work here in the blog, but it does in the notebook. You can try it out in the notebook on Colab.&lt;/mark&gt;</mark></p>
<p>Try moving slider <code>a</code> a bit to the left. Does that look better or worse? How about if you move it a bit to the right? Find out which direction seems to improve the fit of the quadratic to the data, and move the slider a bit in that direction. Next, do the same for slider <code>b</code>: first figure out which direction improves the fit, then move it a bit in that direction. Then do the same for <code>c</code>.</p>
<p>OK, now go back to slider <code>a</code> and repeat the process. Do it again for <code>b</code> and <code>c</code> as well.</p>
<p>Did you notice that by going back and doing the sliders a second time that you were able to improve things a bit further? That’s an important insight – it’s only after changing <code>b</code> and <code>c</code>, for instance, that you realise that <code>a</code> actually needs some adjustment based on those new values.</p>
<p>One thing that’s making this tricky is that we don’t really have a great sense of whether our fit is really better or worse. It would be easier if we had a numeric measure of that. On easy metric we could use is <em>mean absolute error</em> – which is the distance from each data point to the curve:</p>
<div id="cell-30" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mae(preds, acts): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>acts)).mean()</span></code></pre></div>
</div>
<p><mark>&lt;mark&gt;Let’s see how this works. We use the <code>torch.abs</code> function to calculate the absolute value of each element in a tensor, and then we can use the <code>mean</code> tensor method to calculate the mean of those absolute values. The error is reduced to a single number as this is an easy way to see how the model is doing so far.&lt;/mark&gt;</mark></p>
<div id="cell-32" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span></span>
<span id="cb17-2">b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span></span>
<span id="cb17-3">c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span></span>
<span id="cb17-4">f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(a,b,c)</span>
<span id="cb17-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Function parameters:"</span>, a, b, c)</span>
<span id="cb17-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Function output for x[:5]:"</span>, f(x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]))</span>
<span id="cb17-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual values for y[:5]:"</span>, y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])</span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(f(x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]))</span>
<span id="cb17-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean Absolute Error:"</span>, mae(f(x), y))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function parameters: 1.1 1.1 1.1
Function output for x[:5]: tensor([[3.3000],
        [2.6540],
        [2.1055],
        [1.6546],
        [1.3011]])
Actual values for y[:5]: tensor([[11.8690],
        [ 6.5433],
        [ 5.9396],
        [ 2.6304],
        [ 1.7947]], dtype=torch.float64)
tensor([[8.5690],
        [3.8893],
        [3.8341],
        [0.9758],
        [0.4936]], dtype=torch.float64)
Mean Absolute Error: tensor(2.4219, dtype=torch.float64)</code></pre>
</div>
</div>
<p>We’ll update our interactive function to print this at the top for us.</p>
<p>Use this to repeat the approach we took before to try to find the best fit, but this time just use the value of the metric to decide which direction to move each slider, and how far to move it.</p>
<p>This time around, try doing it in the opposite order: <code>c</code>, then <code>b</code>, then <code>a</code>.</p>
<p>You’ll probably find that you have to go through the set of sliders a couple of times to get the best fit.</p>
<div id="cell-34" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>)</span>
<span id="cb19-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_quad(a, b, c):</span>
<span id="cb19-3">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(a,b,c)</span>
<span id="cb19-4">    plt.scatter(x,y)</span>
<span id="cb19-5">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mae(f(x), y)</span>
<span id="cb19-6">    plot_function(f, ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MAE: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4228530deebc4ff3a7ff729f1761d561","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>In a modern neural network we’ll often have tens of millions of parameters to fit, or more, and thousands or millions of data points to fit them to. We’re not going to be able to do that by moving sliders around! We’ll need to automate this process.</p>
<p>Thankfully, that turns out to be pretty straightforward. We can use calculus to figure out, for each parameter, whether we should increase or decrease it.</p>
</section>
<section id="automating-gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="automating-gradient-descent">Automating gradient descent</h2>
<p>The basic idea is this: if we know the <em>gradient</em> of our <code>mae()</code> function <em>with respect to</em> our parameters, <code>a</code>, <code>b</code>, and <code>c</code>, then that means we know how adjusting (for instance) <code>a</code> will change the value of <code>mae()</code>. If, say, <code>a</code> has a <em>negative</em> gradient, then we know that increasing <code>a</code> will decrease <code>mae()</code>. Then we know that’s what we need to do, since we trying to make <code>mae()</code> as low as possible.</p>
<p>So, we find the gradient of <code>mae()</code> for each of our parameters, and then adjust our parameters a bit in the <em>opposite</em> direction to the sign of the gradient.</p>
<p>To do this, first we need a function that takes all the parameters <code>a</code>, <code>b</code>, and <code>c</code> as a single vector input, and returns the value <code>mae()</code> based on those parameters:</p>
<div id="cell-38" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> quad_mae(params):</span>
<span id="cb20-2">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>params)</span>
<span id="cb20-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mae(f(x), y)</span></code></pre></div>
</div>
<p>Let’s try it:</p>
<div id="cell-40" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">quad_mae([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>tensor(2.4219, dtype=torch.float64)</code></pre>
</div>
</div>
<p>Yup, that’s the same as the starting <code>mae()</code> we had in our plot before.</p>
<p>We’re first going to do exactly the same thing as we did manually – pick some arbritrary starting point for our parameters. We’ll put them all into a single tensor:</p>
<div id="cell-42" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>])</span></code></pre></div>
</div>
<p>To tell PyTorch that we want it to calculate gradients for these parameters, we need to call <code>requires_grad_()</code>:</p>
<div id="cell-44" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">abc.requires_grad_()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>tensor([1.1000, 1.1000, 1.1000], requires_grad=True)</code></pre>
</div>
</div>
<p>We can now calculate <code>mae()</code>. Generally, when doing gradient descent, the thing we’re trying to minimise is called the <em>loss</em>:</p>
<div id="cell-46" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb26-2">loss</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>tensor(2.4219, dtype=torch.float64, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<p>To get PyTorch to now calculate the gradients, we need to call <code>backward()</code></p>
<div id="cell-48" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">loss.backward()</span></code></pre></div>
</div>
<p>The gradients will be stored for us in an attribute called <code>grad</code>:</p>
<div id="cell-50" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">abc.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>tensor([-1.3529, -0.0316, -0.5000])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;The <code>backward()</code> function calculates the gradient of the loss with respect to the parameters. The gradients are stored in the <code>grad</code> attribute of each parameter tensor. But what do these actual values represent? Jeremy answered this question in the <a href="https://youtu.be/hBBOjCiFcuo?si=NVXP2q4xaDbz-FxP&amp;t=3296" target="_blank">video lesson</a>: the numbers represent the change of the loss when the parameters increase by a value of one (if the slope stayed constant, which is not the case obviously).&lt;/mark&gt;</mark></p>
<p>According to these gradients, all our parameters are a little low. So let’s increase them a bit. If we subtract the gradient, multiplied by a small number, that should improve them a bit:</p>
<div id="cell-53" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb31-2">    abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> abc.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb31-3">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb31-4"></span>
<span id="cb31-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'loss=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>loss=2.40</code></pre>
</div>
</div>
<p>Yes, our loss has gone down!</p>
<p>The “small number” we multiply is called the <em>learning rate</em>, and is the most important <em>hyper-parameter</em> to set when training a neural network.</p>
<p>BTW, you’ll see we had to wrap our calculation of the new parameters in <code>with torch.no_grad()</code>. That disables the calculation of gradients for any operations inside that context manager. We have to do that, because <code>abc -= abc.grad*0.01</code> isn’t actually part of our quadratic model, so we don’t want derivatives to include that calculation.</p>
<p><mark>&lt;mark&gt;To understand this, I had to go back to the part where the loss was calculated the first time, which resulted in <code>tensor(2.4219, dtype=torch.float64, grad_fn=&lt;MeanBackward0&gt;)</code>. This <code>grad_fn</code> is a graph of mathematical functions that have been applied to our tensor <code>abc</code>. When <code>loss.backward()</code> is called, this graph of functions is the basis for the calculation of the derivative of it. The resulting values are assigned to <code>abc.grad</code>.</mark></p>
<p><mark>&lt;mark&gt;So PyTorch keeps track of all operations that are applied to this tensor, but we don’t want to apply it to the step function (<code>abc -= abc.grad*0.01</code>), because that is not part of the loss function, but rather a step in the optimization process. So we use <code>with torch.no_grad()</code> to tell PyTorch not to track this operation. &lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;The fact that <code>loss = quad_mae(abc)</code> is also under the <code>no_grad()</code> context is because the loss was already calculated in a previous cell. Yeah, that makes it a bit confusing. Normally we would’t do that, as can be seen below in the loop.&lt;/mark&gt;</mark></p>
<p>We can use a loop to do a few more iterations of this:</p>
<div id="cell-56" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb33-2">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb33-3">    loss.backward()</span>
<span id="cb33-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad(): abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> abc.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb33-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'step=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; loss=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>step=0; loss=2.40
step=1; loss=2.36
step=2; loss=2.30
step=3; loss=2.21
step=4; loss=2.11
step=5; loss=1.98
step=6; loss=1.85
step=7; loss=1.72
step=8; loss=1.58
step=9; loss=1.46</code></pre>
</div>
</div>
<p>As you can see, our loss keeps going down!</p>
<p>If you keep running this loop for long enough however, you’ll see that the loss eventually starts increasing for a while. That’s because once the parameters get close to the correct answer, our parameter updates will jump right over the correct answer! To avoid this, we need to decrease our learning rate as we train. This is done using a <em>learning rate schedule</em>, and can be automated in most deep learning frameworks, such as fastai and PyTorch.</p>
<p><mark>&lt;mark&gt;This might be the case (overshooting), but the code above also contains a bug: the value of <code>abc.grad</code> is accumulated for each iteration of the loop. We therefore need to reset the gradient each iteration:&lt;/mark&gt;</mark></p>
<div id="cell-59" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>])</span>
<span id="cb35-2">abc.requires_grad_()</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb35-5">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb35-6">    loss.backward()</span>
<span id="cb35-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad(): abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> abc.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I used a larger learning rate here</span></span>
<span id="cb35-8">    abc.grad.zero_()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reset gradients to zero</span></span>
<span id="cb35-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'step=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; loss=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>step=0; loss=2.42
step=1; loss=2.21
step=2; loss=2.01
step=3; loss=1.82
step=4; loss=1.67
step=5; loss=1.55
step=6; loss=1.46
step=7; loss=1.38
step=8; loss=1.31
step=9; loss=1.24
step=10; loss=1.19
step=11; loss=1.17
step=12; loss=1.14
step=13; loss=1.12
step=14; loss=1.10
step=15; loss=1.10
step=16; loss=1.10
step=17; loss=1.09
step=18; loss=1.09
step=19; loss=1.09
step=20; loss=1.09
step=21; loss=1.08
step=22; loss=1.08
step=23; loss=1.08
step=24; loss=1.07
step=25; loss=1.07
step=26; loss=1.07
step=27; loss=1.07
step=28; loss=1.06
step=29; loss=1.06
step=30; loss=1.06
step=31; loss=1.05
step=32; loss=1.05
step=33; loss=1.05
step=34; loss=1.05
step=35; loss=1.04
step=36; loss=1.04
step=37; loss=1.04
step=38; loss=1.03
step=39; loss=1.03
step=40; loss=1.03
step=41; loss=1.04
step=42; loss=1.03
step=43; loss=1.03
step=44; loss=1.03
step=45; loss=1.03
step=46; loss=1.02
step=47; loss=1.03
step=48; loss=1.02
step=49; loss=1.02
step=50; loss=1.02
step=51; loss=1.02
step=52; loss=1.01
step=53; loss=1.01
step=54; loss=1.02
step=55; loss=1.01
step=56; loss=1.01
step=57; loss=1.01
step=58; loss=1.01
step=59; loss=1.01
step=60; loss=1.01
step=61; loss=1.01
step=62; loss=1.01
step=63; loss=1.01
step=64; loss=1.01
step=65; loss=1.00
step=66; loss=1.01
step=67; loss=1.01
step=68; loss=1.01
step=69; loss=1.01
step=70; loss=1.00
step=71; loss=1.01
step=72; loss=1.00
step=73; loss=1.00
step=74; loss=1.00
step=75; loss=0.99
step=76; loss=1.00
step=77; loss=1.00
step=78; loss=1.01
step=79; loss=1.00
step=80; loss=1.00
step=81; loss=0.99
step=82; loss=1.00
step=83; loss=1.00
step=84; loss=1.00
step=85; loss=1.00
step=86; loss=1.00
step=87; loss=0.99
step=88; loss=0.99
step=89; loss=0.99
step=90; loss=1.00
step=91; loss=0.99
step=92; loss=0.99
step=93; loss=0.99
step=94; loss=0.99
step=95; loss=0.99
step=96; loss=1.00
step=97; loss=0.99
step=98; loss=0.99
step=99; loss=0.99</code></pre>
</div>
</div>
</section>
<section id="how-a-neural-network-approximates-any-given-function" class="level2">
<h2 class="anchored" data-anchor-id="how-a-neural-network-approximates-any-given-function">How a neural network approximates any given function</h2>
<p>But neural nets are much more convenient and powerful than this example showed, because we can learn much more than just a quadratic with them. How does <em>that</em> work?</p>
<p>The trick is that a neural network is a very expressive function. In fact – it’s <a href="https://en.wikipedia.org/wiki/Universal_approximation_theorem">infinitely expressive</a>. A neural network can approximate any computable function, given enough parameters. A “computable function” can cover just about anything you can imagine: understand and translate human speech; paint a picture; diagnose a disease from medical imaging; write an essay; etc…</p>
<p>The way a neural network approximates a function actually turns out to be very simple. The key trick is to combine two extremely basic steps:</p>
<ol type="1">
<li>Matrix multiplication, which is just multiplying things together and then adding them up</li>
<li>The function <img src="https://latex.codecogs.com/png.latex?max(x,0)">, which simply replaces all negative numbers with zero.</li>
</ol>
<p>In PyTorch, the function <img src="https://latex.codecogs.com/png.latex?max(x,0)"> is written as <code>np.clip(x,0)</code>. The combination of a linear function and this <em>max()</em> is called a <em>rectified linear function</em>, and it can be implemented like this:</p>
<div id="cell-62" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> rectified_linear(m,b,x):</span>
<span id="cb37-2">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b</span>
<span id="cb37-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.clip(y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span>)</span></code></pre></div>
</div>
<p>Here’s what it looks like:</p>
<div id="cell-64" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">plot_function(partial(rectified_linear, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/how-does-a-neural-net-really-work/index_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>BTW, instead of <code>torch.clip(y, 0.)</code>, we can instead use <code>F.relu(x)</code>, which does exactly the same thing. In PyTorch, <code>F</code> refers to the <code>torch.nn.functional</code> module.</p>
<div id="cell-66" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb39-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> rectified_linear2(m,b,x): <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> F.relu(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b)</span>
<span id="cb39-3">plot_function(partial(rectified_linear2, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dronelab.dev/posts/how-does-a-neural-net-really-work/index_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To understand how this function works, try using this interactive version to play around with the parameters <code>m</code> and <code>b</code>:</p>
<div id="cell-68" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb40-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_relu(m, b):</span>
<span id="cb40-3">    plot_function(partial(rectified_linear, m,b), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f3afb19605bd4e6487a62045859946af","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>As you see, <code>m</code> changes the slope, and <code>b</code> changes where the “hook” appears. This function doesn’t do much on its own, but look what happens when we add two of them together:</p>
<div id="cell-70" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> double_relu(m1,b1,m2,b2,x):</span>
<span id="cb41-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rectified_linear(m1,b1,x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rectified_linear(m2,b2,x)</span>
<span id="cb41-3"></span>
<span id="cb41-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(m1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, m2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb41-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_double_relu(m1, b1, m2, b2):</span>
<span id="cb41-6">    plot_function(partial(double_relu, m1,b1,m2,b2), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dfe6583dfc6d4dca8dd96fd1840748c9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>If you play around with that for a while, you notice something quite profound: with enough of these rectified linear functions added together, you could approximate any function with a single input, to whatever accuracy you like! Any time the function doesn’t quite match, you can just add a few more additions to the mix to make it a bit closer. As an experiment, perhaps you’d like to try creating your own <code>plot_triple_relu</code> interactive function, and maybe even include the scatter plot of our data from before, to see how close you can get?</p>
<p>This exact same approach can be expanded to functions of 2, 3, or more parameters.</p>
<p><mark>&lt;mark&gt;And here ends Jeremy’s notebook. We know that the trick to create a neural net is to add these two concepts together by connecting linear functions with a ReLU function in between. That will be something for the next lesson (chapter four of the book). See you then!&lt;/mark&gt;</mark></p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Did you know I used the &lt;mark&gt; tag for that? I’m so grateful they named it like that!↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>machine learning</category>
  <category>fast.ai</category>
  <guid>https://dronelab.dev/posts/how-does-a-neural-net-really-work/</guid>
  <pubDate>Sat, 07 Jun 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/how-does-a-neural-net-really-work/how-does-a-neural-net-work.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>Interlude: Getting reproducible training results with Fast.ai + PyTorch</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/getting-reproducible-results/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-25</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Getting reproducible PyTorch/Fast.ai training results requires more than just seeding random number generators. Reproducibility is affected by three factors:</p>
<ol type="1">
<li>seeding RNGs,</li>
<li>using deterministic algorithms, and</li>
<li>recreating an identical starting state.</li>
</ol>
<p><strong>Key insights</strong>:</p>
<ul>
<li>DataLoaders maintain internal state that persists between training runs. You must recreate DataLoaders before each training run, not just reseed.</li>
<li>DataLoader workers need to be seeded before each run.</li>
</ul>
<p><strong>Minimal setup for reproducibility:</strong></p>
<ul>
<li>Set <code>torch.backends.cudnn.deterministic = True</code></li>
<li>Recreate DataLoaders between runs</li>
<li>Basic RNG seeding <em>and</em> DataLoader worker seeding</li>
</ul>
</div>
</div>
</div>
<p>While training an <a href="../fly-drone-with-image-classification/">image classifier</a>, I became a bit annoyed by the fact that subsequent runs have different results, even though I didn’t change anything.</p>
<p>How can we conduct experiments if we don’t know whether the one parameter I modified caused the change, or if something else was responsible, under the hood?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why this matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>This cost me days of debugging. When you’re tuning hyperparameters or comparing model architectures, you need to know whether that 2% accuracy improvement is real or just random variance. Without reproducibility, you’re flying blind.</p>
</div>
</div>
<p>Jump to Conclusion</p>
<section id="what-have-i-tried" class="level2">
<h2 class="anchored" data-anchor-id="what-have-i-tried">What have I tried?</h2>
<p>When I did my experiments, I used this at the start of my notebooks:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> seed_everything(seed):</span>
<span id="cb1-2">    random.seed(seed)</span>
<span id="cb1-3">    os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PYTHONHASHSEED'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(seed)</span>
<span id="cb1-4">    np.random.seed(seed)</span>
<span id="cb1-5">    torch.manual_seed(seed)</span>
<span id="cb1-6">    torch.cuda.manual_seed_all(seed)</span>
<span id="cb1-7">    torch.cuda.manual_seed(seed)</span>
<span id="cb1-8">    torch.backends.cudnn.deterministic <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-9"></span>
<span id="cb1-10">seed_everything(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
<p>And in the <code>DataBlock</code>, I provided a seed for the splitter like:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">    splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>),</span></code></pre></div>
<p>I picked up these snippets in the Fast.ai course, but I don’t really know what each of these statements does in detail. I understand the general idea: ensure that when a random number is generated, it starts from the same seed, so that the random number is consistent each time. Like:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Without seed:"</span>, random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb3-4">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb3-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"With seed 42:"</span>, random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb3-6">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb3-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"With seed 42 again:"</span>, random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre class="text"><code>Without seed: 15 60 38
With seed 42: 81 14 3
With seed 42 again: 81 14 3</code></pre>
</div>
<p>Unfortunately, it is not that simple, proven by the fact that it didn’t work for me. Here is an experiment that shows that loss numbers are not reproducible despite seeding “everything”: <a href="https://colab.research.google.com/drive/1BDCNvpn7MFiTE0k-q21A-YKoYAiGypug?usp=sharing" target="_blank">Getting reproducible results with Fast.ai / PyTorch - Attempt #1</a>.</p>
<p>Perhaps a good time to read the documentation.</p>
</section>
<section id="rtfm" class="level2">
<h2 class="anchored" data-anchor-id="rtfm">RTFM</h2>
<section id="fast.ai-docs" class="level3">
<h3 class="anchored" data-anchor-id="fast.ai-docs">Fast.ai docs</h3>
<p>There is currently no section to be found in the Fast.ai docs covering reproducibility, but there was in version one (deprecated): <a href="https://fastai1.fast.ai/dev/test.html#getting-reproducible-results" target="_blank">Getting reproducible results</a>:</p>
<blockquote class="blockquote">
<p>In some situations you may want to remove randomness for your tests. To get identical reproducible results set, you’ll need to set num_workers=1 (or 0) in your DataLoader/DataBunch, and depending on whether you are using torch’s random functions, or python’s (numpy) or both:</p>
</blockquote>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># python RNG</span></span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb5-5">random.seed(seed)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pytorch RNGs</span></span>
<span id="cb5-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb5-9">torch.manual_seed(seed)</span>
<span id="cb5-10">torch.backends.cudnn.deterministic <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb5-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available(): torch.cuda.manual_seed_all(seed)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy RNG</span></span>
<span id="cb5-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb5-15">np.random.seed(seed)</span></code></pre></div>
<p>The Python and numpy parts speak for themselves. I will dive into the PyTorch statements in a moment.</p>
<p>If we compare this code with what I did in my first attempt, the only thing that is new is <code>num_workers=1</code> for dataloaders.</p>
<p>I tried that, and nope: still not reproducible.</p>
<p>The current docs don’t have a section like the one above, but there is a function <a href="https://docs.fast.ai/torch_core.html#set_seed" target="_blank">set_seed</a> (only available in Fast.ai). Let’s have a look at the <a href="https://github.com/fastai/fastai/blob/main/fastai/torch_core.py#L161" target="_blank">source code</a>:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> set_seed(s, reproducible<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"Set random seed for `random`, `torch`, and `numpy` (where available)"</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: torch.manual_seed(s)</span>
<span id="cb6-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NameError</span>: <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: torch.cuda.manual_seed_all(s)</span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NameError</span>: <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: np.random.seed(s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NameError</span>: <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb6-9">    random.seed(s)</span>
<span id="cb6-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> reproducible:</span>
<span id="cb6-11">        torch.backends.cudnn.deterministic <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb6-12">        torch.backends.cudnn.benchmark <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span></code></pre></div>
<p>So, mostly the same stuff, except: <code>torch.backends.cudnn.benchmark = False</code>. Which leads us to the PyTorch docs…</p>
</section>
<section id="pytorch-docs" class="level3">
<h3 class="anchored" data-anchor-id="pytorch-docs">PyTorch docs</h3>
<p>Luckily, there is a note about reproducibility in the PyTorch docs: <a href="https://docs.pytorch.org/docs/stable/notes/randomness.html" target="_blank">Reproducibility</a>.</p>
<p>There is a warning at the top of the document that I will repeat here.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Deterministic operations are often slower than nondeterministic operations, so single-run performance may decrease for your model. However, determinism may save time in development by facilitating experimentation, debugging, and regression testing.</p>
</div>
</div>
<p>So it might be worth trying to make everything deterministic during our early experiments (with a smaller dataset and smaller base model), and when we are confident we are on the right track, we switch to nondeterministic.</p>
<p>Sounds great! But first we have to get the deterministic part working in the first place…</p>
<p>The PyTorch doc consists of three sections. Let’s go through them one by one.</p>
<section id="controlling-sources-of-randomness" class="level4">
<h4 class="anchored" data-anchor-id="controlling-sources-of-randomness">1. Controlling sources of randomness</h4>
<p>Apart from reiterating the assignment of a fixed seed for Python, NumPy, and PyTorch, it also discusses the <code>cudnn.benchmark</code> feature we saw earlier. <code>cudnn</code> is a library built on top of CUDA that accelerates the training of neural networks. Apparently, it starts by trying out a couple of approaches (that’s the benchmarking), and picks the winner for the rest of the training. There is randomness involved in this benchmarking, so setting it to <code>False</code> should make the process deterministic.</p>
<p>What happened when I tried this?</p>
<p>-&gt; Still no reproducible results!</p>
</section>
<section id="avoiding-nondeterministic-algorithms" class="level4">
<h4 class="anchored" data-anchor-id="avoiding-nondeterministic-algorithms">2. Avoiding nondeterministic algorithms</h4>
<p>Now it gets interesting! PyTorch provides a method that might solve our problems: <a href="https://docs.pytorch.org/docs/stable/generated/torch.use_deterministic_algorithms.html#torch.use_deterministic_algorithms" target="_blank">torch.use_deterministic_algorithms(True)</a>.</p>
<p>This statement instructs all other Torch code to use the deterministic variant of its algorithms, and if this is not possible, to throw an exception.</p>
<p>And that is exactly what I got, an exception:</p>
<div class="cell-output cell-output-stdout">
<pre class="text"><code>RuntimeError                              Traceback (most recent call last)
&lt;ipython-input-12-25c053374517&gt; in &lt;cell line: 0&gt;()
      1 learn = vision_learner(dls, resnet18, metrics=error_rate)
----&gt; 2 learn.fine_tune(3)

21 frames
/usr/local/lib/python3.11/dist-packages/torch/nn/modules/linear.py in forward(self, input)
    123 
    124     def forward(self, input: Tensor) -&gt; Tensor:
--&gt; 125         return F.linear(input, self.weight, self.bias)
    126 
    127     def extra_repr(self) -&gt; str:

RuntimeError: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</code></pre>
</div>
<p>It didn’t happen in some exotic part of the library, but at the most elemental level that even I understand: <code>return F.linear(input, self.weight, self.bias)</code>.</p>
<p>The error message is super specific and helpful:</p>
<p><code class="wrap">Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</code></p>
<p>Let’s see what version of CUDA we are using on Colab:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(torch.version.cuda)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre class="text"><code>12.4</code></pre>
</div>
<p>Following the advice and setting this at the top of the notebook</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CUBLAS_WORKSPACE_CONFIG'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">':4096:8'</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or ':16:8'</span></span></code></pre></div>
<p>got me over this hurdle!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Just a “Restart session and run all” is not enough after introducing this environment var. You have to actually disconnect from the colab runtime, connect again, and run all.</p>
</div>
</div>
<p>We got a step further, but another error pops up, now in the backward pass:</p>
<div class="cell-output cell-output-stdout">
<pre class="text"><code>RuntimeError                              Traceback (most recent call last)
&lt;ipython-input-11-af2d886d9870&gt; in &lt;cell line: 0&gt;()
      1 print(os.environ['CUBLAS_WORKSPACE_CONFIG'])
      2 learn = vision_learner(dls, resnet18, metrics=error_rate)
----&gt; 3 learn.fine_tune(3)

22 frames
/usr/local/lib/python3.11/dist-packages/torch/autograd/graph.py in _engine_run_backward(t_outputs, *args, **kwargs)
    821         unregister_hooks = _register_logging_hooks_on_whole_graph(t_outputs)
    822     try:
--&gt; 823         return Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
    824             t_outputs, *args, **kwargs
    825         )  # Calls into the C++ engine to run the backward pass

RuntimeError: adaptive_max_pool2d_backward_cuda does not have a deterministic implementation, but you set 'torch.use_deterministic_algorithms(True)'. You can turn off determinism just for this operation, or you can use the 'warn_only=True' option, if that's acceptable for your application. You can also file an issue at https://github.com/pytorch/pytorch/issues to help us prioritize adding deterministic support for this operation.</code></pre>
</div>
<p>Oh, oh, bad news. We have no other choice now to set the <code>warn_only</code> flag to <code>True</code> on the <code>use_deterministic_algorithms</code> call. This indeed allows the fine-tuning run to finish, but still not reproducible :(</p>
</section>
<section id="dataloader" class="level4">
<h4 class="anchored" data-anchor-id="dataloader">3. DataLoader</h4>
<p>Finally, the PyTorch doc about reproducibility mentions the possibility of seeding dataloader workers identically. As we previously used only one worker, I assume this won’t have any impact on our case. And guess what: it doesn’t <sup>1</sup>!</p>
<p>Here is the notebook where I did all the experiments as recommended in the docs: <a href="https://colab.research.google.com/drive/1b2F6J_-FhG37odYyrJPxBdjPtyTzJGkn?usp=sharing" target="_blank">Getting reproducible results with Fast.ai / PyTorch - Attempt #2</a>. BTW the Colab GPU was of type L4.</p>
<p>Speaking of GPUs: would we get reproducible results if we run it on a CPU? The answer is NO (I tried) <sup>2</sup>.</p>
</section>
</section>
</section>
<section id="lets-get-some-help-hello-claude" class="level2">
<h2 class="anchored" data-anchor-id="lets-get-some-help-hello-claude">Let’s get some help (hello Claude)</h2>
<p>The documentation didn’t really help. All the tricks to keep everything deterministic failed. It could be the backward pass, in which case we don’t have much hope of resolving it. But how do people train their models if you can’t do any experiments where just one meta-parameter changes?</p>
<p>Anyway, we are not giving up! Let’s ask our friend the LLM.</p>
<p>Claude speaks:</p>
<blockquote class="blockquote">
<p>When you create a DataLoader in PyTorch, it establishes its own internal random state that becomes decoupled from the global random seed. The DataLoader contains several stateful components that persist between training runs:</p>
<p>The DataLoader’s internal random number generator gets initialized when you first create it, and this generator maintains its own state independently of any subsequent global seed resets. Even though you call seed_everything(42) before each run, the DataLoader’s internal RNG has already advanced its state from the previous run and won’t reset back to its initial position.</p>
<p>The data shuffling mechanism also maintains state. Even with a fixed seed in your RandomSplitter, the underlying shuffling operations within the DataLoader can accumulate state changes that persist across runs, leading to subtle differences in the exact order that batches are presented to your model.</p>
</blockquote>
<p>Ah, of course, state is the key thing here! Random generators can start nicely with the same seed again, but if the state is not the same as it was before, that has no impact!</p>
<p>So let’s apply that wisdom by setting the seeds <em>and</em> recreate the <code>DataLoader</code> before starting a new training run…</p>
<p>Victory, we have reproducible results now! Have a look at this winning notebook: <a href="https://colab.research.google.com/drive/1yphkoDvcmb67JGXXCFK_dRN74VEY72lm?usp=sharing" target="_blank">Getting reproducible results with Fast.ai / PyTorch - Attempt #3</a>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even with the most conservative setup, like in this notebook, there can be small differences between runs. I noticed this when changing the GPU model from L4 to A100. This is acknowledged in the PyTorch documentation.</p>
</div>
</div>
<p>There is just one problem with it: it has become really slow.</p>
</section>
<section id="hhhhh" class="level2">
<h2 class="anchored" data-anchor-id="hhhhh">^H^H^H^H^H</h2>
<p>For you younger kids: ^H is the backspace character in Unix-type terminals. In other words, let’s delete some of the things we have done to increase reproducibility at the cost of performance.</p>
<section id="observations" class="level3">
<h3 class="anchored" data-anchor-id="observations">Observations</h3>
<section id="num_workers" class="level4">
<h4 class="anchored" data-anchor-id="num_workers">num_workers:</h4>
<p>Changing from <code>num_workers=0</code> to <code>num_workers=12</code> <sup>3</sup> maintains reproducibility, but only if the workers are seeded as follows (from the PyTorch docs):</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> seed_worker(worker_id):</span>
<span id="cb12-2">    worker_seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.initial_seed() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb12-3">    numpy.random.seed(worker_seed)</span>
<span id="cb12-4">    random.seed(worker_seed)</span>
<span id="cb12-5"></span>
<span id="cb12-6">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator()</span>
<span id="cb12-7">g.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb12-8"></span>
<span id="cb12-9">DataLoader(</span>
<span id="cb12-10">    train_dataset,</span>
<span id="cb12-11">    batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_size,</span>
<span id="cb12-12">    num_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_workers,</span>
<span id="cb12-13">    worker_init_fn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed_worker,</span>
<span id="cb12-14">    generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g,</span>
<span id="cb12-15">)</span></code></pre></div>
<p>This also maintains reproducibility across sessions.</p>
<p>I’m very happy this works as it speeds up things significantly!</p>
</section>
<section id="use_deterministic_algorithms" class="level4">
<h4 class="anchored" data-anchor-id="use_deterministic_algorithms">use_deterministic_algorithms:</h4>
<p>Removing <code>torch.use_deterministic_algorithms(True)</code> also maintains reproducibility, both in the notebook and across sessions <sup>4</sup>.</p>
</section>
<section id="set_seed" class="level4">
<h4 class="anchored" data-anchor-id="set_seed">set_seed:</h4>
<p>Setting the second parameter of <code>set_seed</code>, <code>reproducible</code> to <code>False</code> (which is the default) basically sets <code>torch.backends.cudnn.benchmark = False</code> in our case. This also maintains reproducibility, both in the notebook and across sessions.</p>
</section>
<section id="cudnn.deterministic" class="level4">
<h4 class="anchored" data-anchor-id="cudnn.deterministic">cudnn.deterministic:</h4>
<p>Setting <code>torch.backends.cudnn.deterministic = False</code> breaks reproducibility, so it is essential when running meaningful experiments. I hardly saw any performance degradation by setting this to <code>True</code>, but that might be different for other use cases.</p>
<p><strong>Key findings</strong>: as long as you seed every DataLoader worker and keep <code>torch.backends.cudnn.deterministic = True</code>, you can crank <code>num_workers</code> back up, drop <code>torch.use_deterministic_algorithms(True)</code>, and rely on the default <code>set_seed(..., reproducible=False)</code>: reproducibility still holds across notebook sessions while you recover full training speed.</p>
<p>The notebook that has applied the above, and is fast and reproducible, is here: <a href="https://colab.research.google.com/drive/1fOHcdEDja9OzmIBLkGqTiRf6gknVJGy-?usp=sharing" target="_blank">Getting reproducible results with Fast.ai / PyTorch - Attempt #4</a></p>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>These conclusions are probably not generic for all training pipelines and base models, but they probably are for convolutional networks like Resnet18. It might be different for transformer-based models, who knows. At least we know what knobs we can turn to get reproducible results.</p>
</div>
</div>
<p>Reproducible training comes down to three levers:</p>
<ol type="1">
<li>Seed every RNG – Python random, NumPy, and each DataLoader worker (worker_init_fn + torch.Generator).</li>
<li>Force deterministic kernels <code>torch.backends.cudnn.deterministic = True</code> (leave benchmarking off while you experiment).</li>
<li>Start from the same state: rebuild the DataLoader before each fresh run so its internal sampler is reset.</li>
</ol>
<p>If you are using Fast.ai, use the <a href="https://colab.research.google.com/drive/1fOHcdEDja9OzmIBLkGqTiRf6gknVJGy-?usp=sharing" target="_blank">Fast.ai notebook</a> as a reference for reproducible training.</p>
<p>In the end it comes down to:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First run</span></span>
<span id="cb13-2">seed_everything(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb13-3">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator()</span>
<span id="cb13-4">g.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb13-5">torch.backends.cudnn.deterministic <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb13-6">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_dataloaders(g)</span>
<span id="cb13-7">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate)</span>
<span id="cb13-8">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb13-9"></span>
<span id="cb13-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Next run(s)</span></span>
<span id="cb13-11">seed_everything(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb13-12">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator()</span>
<span id="cb13-13">g.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb13-14">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_dataloaders(g)</span>
<span id="cb13-15">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate)</span>
<span id="cb13-16">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<p>If you prefer to just use PyTorch, use the <a href="https://colab.research.google.com/drive/1DB--1tnAOGdc5wgHNFc0KE5xhcJFRXgh?usp=sharing" target="_blank">PyTorch notebook</a> (Claude generated this based on the Fast.ai version) <sup>5</sup>.</p>
<p>Once you move from experimentation to full-scale training, you can flip <code>torch.backends.cudnn.deterministic = False</code> to potentially regain speed. Just remember that it will sacrifice strict repeatability.</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next</h2>
<p>Another interlude that got a bit out of hand. Time to go back to our <a href="../fly-drone-with-image-classification/">image classifier</a> and see if we can improve it. Read on…</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>As I found out later, it certainly does matter when using more than one worker, which is what you always want in order to have acceptable performance.↩︎</p></li>
<li id="fn2"><p>With what I know now, this is because I didn’t recreate the dataloaders between runs. If we did that and used a CPU, the results would be reproducible.↩︎</p></li>
<li id="fn3"><p>This is the default in my case; it is calculated as <code>min(16, os.cpu_count())</code>.↩︎</p></li>
<li id="fn4"><p>This stays repeatable unless your model calls a layer that can’t guarantee identical results on the GPU; in that case, the numbers may shift a bit between runs, or PyTorch will throw a warning.↩︎</p></li>
<li id="fn5"><p>I found a few excellent blog posts mainly focused on reproducibility with PyTorch: <a href="https://darinabal.medium.com/deep-learning-reproducible-results-using-pytorch-42034da5ad7">Reproducible Deep Learning Using PyTorch</a>, and <a href="https://medium.com/@heyamit10/pytorch-reproducibility-a-practical-guide-d6f573cba679">PyTorch Reproducibility: A Practical Guide</a>.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>machine learning</category>
  <category>colab</category>
  <category>computer vision</category>
  <category>fast.ai</category>
  <category>pytorch</category>
  <guid>https://dronelab.dev/posts/getting-reproducible-results/</guid>
  <pubDate>Sat, 24 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/getting-reproducible-results/reproducible.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>Interlude: Which image models are best? UPDATED</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/which-image-models-are-best-updated/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-19</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to choose the best image classification models using updated data and tools.</li>
<li>See how the popular “Which image models are best?” notebook was revived with new sources and recent models.</li>
<li>Get links to interactive notebooks and a Gradio app for hands-on model comparison.</li>
</ul>
</div>
</div>
</div>
<p>In <a href="../fly-drone-with-image-classification/">my attempts to create an image classifier</a>, following the Fast.ai method as learned in lesson 2, I wanted to try other base-models. A way to help pick the most suitable model was presented in <a href="https://course.fast.ai/Lessons/lesson3.html" target="_blank">lesson 3</a>.</p>
<p>Jeremy Howard created this amazing notebook that helps selecting a model for your use case: <a href="https://www.kaggle.com/code/jhoward/which-image-models-are-best/notebook" target="_blank">Which image models are best?</a>. Unfortunately the notebook is two years old and is no longer working.</p>
<p>The notebook gets its data from the <code>timm</code> computer vision library. It is currently part of Huggingface <a href="https://huggingface.co/docs/timm/index" target="_blank">here</a>.</p>
<section id="what-is-timm" class="level2">
<h2 class="anchored" data-anchor-id="what-is-timm">What is timm?</h2>
<p>As far as I understand it, <code>timm</code> is a collection of PyTorch compatible models focussed on computer vision, so all about images: classification, segmentation and more. Apart from a lot of models (old and new, small and large) it has other helpful stuff (helpful for people who know what this all about, not me…, yet! :)).</p>
<p>From the Huggingface docs:</p>
<blockquote class="blockquote">
<p><code>timm</code> is a library containing SOTA computer vision models, layers, utilities, optimizers, schedulers, data-loaders, augmentations, and training/evaluation scripts.</p>
<p>It comes packaged with &gt;700 pretrained models, and is designed to be flexible and easy to use.</p>
</blockquote>
<p>It started as <a href="https://huggingface.co/rwightman" target="_blank">Ross Wightman</a>’s solo project, but now it’s part of the Hugging Face ecosystem.</p>
<p>For me <code>timm</code> is relevant, because it allows me to try different models that can improve the <a href="../fly-drone-with-image-classification/">is there a lamp classifier</a>, and in the future, for more advanced stuff we will do.</p>
</section>
<section id="great-visualization-outdated" class="level2">
<h2 class="anchored" data-anchor-id="great-visualization-outdated">Great visualization (outdated)</h2>
<p>Jeremy Howard used the <code>timm</code> data to make is easier to select models to try out. He created a <a href="https://www.kaggle.com/code/jhoward/which-image-models-are-best/notebook" target="_blank">notebook</a> that includes graphs like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/which-image-models-are-best-updated/timm2.png" class="img-fluid figure-img"></p>
<figcaption>Screenshot: Inference top1 accuracy / speed scatter</figcaption>
</figure>
</div>
<p>As said, unfortunately it no longer works if you copy it to your own account (the data sources have moved to Huggingface), and worst: it doesn’t contain information from more recent models.</p>
<p>The <a href="https://huggingface.co/spaces/timm/leaderboard" target="_blank">timm leaderboard</a> is meant to replace it, but it is not as clear IMO. I want the same happy colorful interactive bubbles!</p>
<p>Should be easy to fix, so let’s get to it!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why not use an LLM?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Yeah, great question! We could also dump all data into an LLM and ask it to create some useful visualizations. It has the advantage that you can chat about the data as well to make the right choice.</p>
<p>Sometimes, however, it feels just easier to play around in a notebook IMO. Also, in this specific case, it is not so easy to get the same results: you are basically describing to the LLM in text what we (Jeremy) did here with code.</p>
</div>
</div>
</section>
<section id="visualization-repaired" class="level2">
<h2 class="anchored" data-anchor-id="visualization-repaired">Visualization repaired</h2>
<p>As said, it was mostly a matter of pointing to the new data sources and to include a couple of newer models that are SOTA (I asked ChatGPT DeepSearch which ones are). I also found the original data sources and recreated the original charts next to the new ones.</p>
<p>The notebook I used for my experiments, with both the new and the old data sources, is here: <a href="https://colab.research.google.com/drive/1ImwK73r2Pjc2qpDb2Ov5Gn8y-ZEHyQPZ?usp=sharing" target="_blank">Which image models are best? (updated)</a>.</p>
<p>I also created a copy <a href="https://www.kaggle.com/code/mapors/which-image-models-are-best/" target="_blank">on Kaggle here</a>. Kaggle has some problems rendering the plotly charts (which I fixed in part): they don’t show up unless in edit mode…</p>
<p>Finally I created a version with less text, and more flexibility:</p>
<ul>
<li>you can select the benchmark file</li>
<li>limit the included model families</li>
<li>change what charts will display on x- and y-axis</li>
<li>when new benchmarks are published, they wil be included</li>
</ul>
<p>It can be found here: <a href="https://colab.research.google.com/drive/1yhjNeqneaBAb_uyIYNVYI24pSBZQdUt3?usp=sharing" target="_blank">Which image models are best? (improved)</a>.</p>
</section>
<section id="deploying-it-on-huggingface-with-gradio" class="level2">
<h2 class="anchored" data-anchor-id="deploying-it-on-huggingface-with-gradio">Deploying it on Huggingface with Gradio</h2>
<p>I asked Claude to port the notebook to a Gradio app, and after some tweaks it seems to work just fine:</p>
<p><a href="https://huggingface.co/spaces/pors/Which-image-models-are-best" target="_blank">Image Model Performance Analysis</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/which-image-models-are-best-updated/gradio-app.png" class="img-fluid figure-img"></p>
<figcaption>The Gradio app on Huggingface</figcaption>
</figure>
</div>
<p>Pretty cool, no?</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next</h2>
<p>This interlude got a bit out of hand. Time to go back to our <a href="../fly-drone-with-image-classification/">image classifier</a> and pick a better model. Read on…</p>


</section>

 ]]></description>
  <category>machine learning</category>
  <category>timm</category>
  <category>computer vision</category>
  <category>fast.ai</category>
  <category>open-source</category>
  <guid>https://dronelab.dev/posts/which-image-models-are-best-updated/</guid>
  <pubDate>Sun, 18 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/which-image-models-are-best-updated/timm.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Fly a drone with: Image classification</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/fly-drone-with-image-classification/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-15</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to build a simple image classifier to help a drone detect obstacles (like lamps) using fast.ai.</li>
<li>See the real-world challenges of collecting and cleaning training data for image classification.</li>
<li>Discover the impact of label noise, data imbalance, and augmentation on model performance.</li>
<li>Get practical tips on improving results: manual data cleaning, trying different resizing/augmentation, tuning batch size, and testing better base models.</li>
<li>Understand the importance of reproducibility and the limits of small datasets.</li>
<li>Follow a step-by-step, experiment-driven approach—ideal for beginners like myself wanting to apply machine learning to robotics.</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/tello-controller-navigation-part-2/">← Previous: Tello controller navigation - Part 2</a>
</div>
</div>
</div>
</div>
</div>
<section id="the-path-to-autonomous-flying" class="level2">
<h2 class="anchored" data-anchor-id="the-path-to-autonomous-flying">The path to autonomous flying</h2>
<p>Now that we have the Tello / RoboMaster TT under control with a mobile app, a keyboard, and a game controller we can make the first steps to remove control all together.</p>
<p>I’m sure there have been written many books about this subject and there is loads of scientific research:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/fly-drone-with-image-classification/papers-autonomous-drones.png" class="img-fluid figure-img"></p>
<figcaption>Google scholar search for “autonomous drones”</figcaption>
</figure>
</div>
<p>Over 17k results since 2024; OMG! Good thing that LLM’s have read all that :)</p>
<p>I’m not going to do anything with it for now, let’s just try out a couple of naive ideas and see were we end up.</p>
</section>
<section id="naive-approach-1-image-classification" class="level2">
<h2 class="anchored" data-anchor-id="naive-approach-1-image-classification">Naive approach #1: Image classification</h2>
<p>No, of course image classification is not the solution to autonomous flying, but probably it is in there somewhere, and I am following the <a href="https://course.fast.ai/">Fast.ai course</a> which starts off with image classification.</p>
<p>Jeremy Howard is the man behind both the <a href="https://github.com/fastai/fastai">Fast.ai library</a> and the course, and his approach is to create a simple baseline model first:</p>
<blockquote class="blockquote">
<p>Baseline: A simple model which you are confident should perform reasonably well. It should be very simple to implement, and very easy to test, so that you can then test each of your improved ideas, and make sure they are always better than your baseline. Without starting with a sensible baseline, it is very difficult to know whether your super-fancy models are actually any good.</p>
</blockquote>
<p>So, that’s what I am going to do: fine-tune an image classifier with a limited amount of data and with a simple base model.</p>
<p>The testing ground for my drone has a couple of very obvious obstacles: lamps hanging from the ceiling. So this is going to be a lamp or no-lamp in the room image classifier.</p>
</section>
<section id="lamp-or-no-lamp-image-classifier" class="level2">
<h2 class="anchored" data-anchor-id="lamp-or-no-lamp-image-classifier">Lamp or no-lamp image classifier 😞 → 😐 → 🙂 → 😊 → 😃 → 😁</h2>
<section id="first-attempt" class="level3">
<h3 class="anchored" data-anchor-id="first-attempt">First attempt 😞</h3>
<p>My first attempt can be seen here: <a href="https://colab.research.google.com/drive/1QaIn0EaqsohlFDD6tXMaGLoD9nCyskHC?usp=sharing">Baseline model: Is there a lamp?</a>.</p>
<p>Not a great result (understatement), it over-fits from the start, and the reason is obvious: label noise (jargon for have data labelled wrong).</p>
<p>Here are some wonderful samples from the training set:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/fly-drone-with-image-classification/label-noise.png" class="img-fluid figure-img"></p>
<figcaption>label noise</figcaption>
</figure>
</div>
<p>It is a bit hard to Google/DDG for interior <em>without</em> hanging lamps, so let’s try training the model another time after manual cleanup.</p>
</section>
<section id="cleanup-of-the-image-labels" class="level3">
<h3 class="anchored" data-anchor-id="cleanup-of-the-image-labels">Cleanup of the image labels</h3>
<p>I said <em>manual</em> cleanup, but I’m going to cheat and use some advanced AI model (CLIP) to be able to train a very simple model.</p>
<p>Code is written by chatgpt: <a href="https://colab.research.google.com/drive/1HoUSkMwQqKWJ10-YCpIMq3sVACpVAUwl?usp=sharing">Lamp Dataset Cleaner (CLIP-based)</a>.</p>
<p>And the result is…. MEH! Not much better than what I started with.</p>
<p>So, back to manual cleaning. I’ll be back soon…</p>
<p>One hour later: DONE!</p>
<p>The result is a huge amount of images with a lamp, and very few without it. Reason being: if you use <code>ceiling</code> in a search term, lamps will show up very often. The query <code>home interior wall  -lamp</code> was quite a bit better, not as many lamps! :)</p>
<p>More manual cleaning to do…</p>
<p>Another hour later: DONE!</p>
</section>
<section id="second-attempt" class="level3">
<h3 class="anchored" data-anchor-id="second-attempt">Second attempt 😐</h3>
<p>With the cleaned up data I did another run, see: <a href="https://colab.research.google.com/drive/10pxEfb82zvp99F98Bjg0gCND8v_eC-AT?usp=sharing">Baseline model: Is there a lamp? Second attempt</a>.</p>
<p>The result I quite a bit better with a ~10% error rate, but there still is over-fitting starting at epoch 2. The 16 top losses look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/fly-drone-with-image-classification/top-losses.png" class="img-fluid figure-img"></p>
<figcaption>Top losses: Prediction/Actual/Loss/Probability</figcaption>
</figure>
</div>
<p>To be fair, some of these images are pretty tough to classify IMO. Anyway, let’s see if we can do better.</p>
</section>
<section id="third-attempt-better-resizing-and-augmentation" class="level3">
<h3 class="anchored" data-anchor-id="third-attempt-better-resizing-and-augmentation">Third attempt 😐: Better resizing and Augmentation</h3>
<p>There’s a couple of things we can try, here is what I did try:</p>
<p>Resizing with different methods:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">Resize(400, ResizeMethod.Pad, pad_mode='zeros')</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">Resize(400, ResizeMethod.Squish)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-3"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">Resize(400)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-4"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">RandomResizedCrop(400, min_scale=0.6)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-5"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">RandomResizedCrop(400, min_scale=0.3)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-6"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">RandomResizedCrop(400, min_scale=0.8)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>Augmentation:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode md code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>item_tfms=<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">Resize(400, ResizeMethod.Pad, pad_mode='zeros')</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>,</span>
<span id="cb2-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">* </span>batch_tfms=aug_transforms()</span></code></pre></div>
<p>The runs can be seen here: <a href="https://colab.research.google.com/drive/1PqKdYnMIHn4KQLDXepr71AH3YdlbuYsf?usp=sharing">Baseline model: Is there a lamp? Third attempt</a>.</p>
<p>Something very annoying is that subsequent runs - without changing anything - have different results, which makes doing experiments impossible. I asked Gemini about it and it said:</p>
<blockquote class="blockquote">
<p>You’ve done a good job providing a seed for reproducibility with seed_everything(42). However, even with careful seeding, variations in results can sometimes occur in deep learning training for a few reasons, especially within an environment like Colab:</p>
<ul>
<li><p>GPU Non-Determinism: While you’ve set torch.backends.cudnn.deterministic = True, not all operations on the GPU are guaranteed to be completely deterministic across different runs or hardware configurations. Some highly optimized kernels might involve non-deterministic algorithms for performance reasons.</p></li>
<li><p>Background Processes in Colab: Colab is a shared environment. While unlikely to cause significant variations, very minor background processes or resource allocation differences could theoretically have a minuscule impact on timing and execution flow, though this is generally not the primary cause of noticeable differences.</p></li>
</ul>
</blockquote>
<p>Hmm, not great. What <em>is</em> great, is that Gemini can see the notebook you are working with, so it can be very helpful when needed. Not this time though :)</p>
<p>Conclusion: nothing really helps. The error rate stays around 10%.</p>
<p>Probably we got everything out of the data we have? Let’s try a couple more things.</p>
</section>
<section id="fourth-attempt-smaller-batch-size" class="level3">
<h3 class="anchored" data-anchor-id="fourth-attempt-smaller-batch-size">Fourth attempt 🙂: smaller batch size</h3>
<p>So far we had a mini-batch size of 32. Let’s have look what happens when we decrease that:</p>
<ul>
<li>No more over-fitting with 3 epochs.</li>
<li>Error-rate goes down to 6-8%!</li>
</ul>
<p>Maybe I am over-fitting with my hyper-parameters? It feels a bit like it, but I don’t have a test set to confirm that… Let’s try that later, when we have a bit more data.</p>
<p>Here is the notebook: <a href="https://colab.research.google.com/drive/1Kj7HL-IXfRC2DOqlaTPbCwafY32X1_kF?usp=sharing">Baseline model: Is there a lamp? Fourth attempt</a>.</p>
<p>I think we have a good baseline here. So let’s go and throw some more power behind it:</p>
<ol type="1">
<li>Use a better base model</li>
<li>Use more training data</li>
</ol>
</section>
<section id="fifth-attempt-use-a-better-base-model" class="level3">
<h3 class="anchored" data-anchor-id="fifth-attempt-use-a-better-base-model">Fifth attempt 😊: use a better base model</h3>
<p>I tried a larger resnet model: <code>resnet34</code>, which (with a smaller mini-batch size of 8) resulted in a 4% error rate, without over-fitting for the first few epochs.</p>
<p>I also had a look here: <a href="https://www.kaggle.com/code/jhoward/which-image-models-are-best/notebook">Which image models are best?</a>, and picked <code>convnext_tiny</code>. This model resulted in a 3% error rate, but is significantly slower. Because we want speedy inference later on, we might want to stick with the resnet models.</p>
<p>Notebook for this experiment: <a href="https://colab.research.google.com/drive/1vHMKQxVliGhaJ90D-JaTx4IrDzdqkYnB?usp=sharing">Is there a lamp? Fifth attempt</a>. I removed the phrase <code>Baseline model</code>, because we are now starting to ramp up the actual base model. Not sure if this is the way, but so far it seems to work. Still a bit worried about the test set that is coming up though…</p>
</section>
<section id="sixth-attempt-collect-more-data" class="level3">
<h3 class="anchored" data-anchor-id="sixth-attempt-collect-more-data">Sixth attempt 🤨: collect more data</h3>
<p>My plan was to now collect more data and do some of the previous steps again, but I changed my mind. The possibility that I am over-fitting by trying different hyper-parameters and picking the winners is substantial.</p>
<p>The logical next step would then be to use a test set and see what is going on.</p>
<p>Also: I don’t need to create the best lamp classifier in the world, we are here to learn!</p>
</section>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>As said, in the next post I will create a test set (from drone frames), figure out test-set best practices, and finalize our classifier. Read on…</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/tello-controller-navigation-part-2/">← Previous: Tello controller navigation - Part 2</a>
</div>
</div>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>tello</category>
  <category>machine learning</category>
  <category>image classification</category>
  <category>fast.ai</category>
  <guid>https://dronelab.dev/posts/fly-drone-with-image-classification/</guid>
  <pubDate>Wed, 14 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/fly-drone-with-image-classification/image-classification-lamps.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Tello controller navigation - Part 2</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/tello-controller-navigation-part-2/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-11</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to connect a physical GameSir T1d controller to a real Tello drone using Python and djitellopy, moving beyond simulation.</li>
<li>See how to integrate live video streaming from the Tello into your Pygame app, including handling frames and displaying them in real time.</li>
<li>Get practical code examples for replacing the simulator with a real drone interface, managing video streams, and troubleshooting common issues.</li>
<li>Understand the structure needed to glue together controller input, drone commands, and video feedback for a seamless flying experience.</li>
<li>Prepare for the next step: using this setup as a foundation for future machine learning and autonomous drone experiments.</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/tello-controller-navigation-part-1/">← Previous: Tello controller navigation - Part 1</a>
</div>
<div>
<a href="../../posts/fly-drone-with-image-classification/">Next: Fly a drone with: Image classification →</a>
</div>
</div>
</div>
</div>
</div>
<section id="time-to-fly" class="level2">
<h2 class="anchored" data-anchor-id="time-to-fly">Time to fly</h2>
<p>This blog is supposed to show my progress with machine learning, but we haven’t touched that yet at all! That will still be the case in this post, but we are close to wrapping up the drone control.</p>
<p>It is time to combine our previous efforts and connect the drone interface (djitellopy) with the controller interface (gamesir-t1d).</p>
<div style="text-align: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/tello-controller-navigation-part-2/tello-gamesir-t1d-photo.png" class="img-fluid figure-img"></p>
<figcaption>GameSir T1d controlling the Tello / RoboMaster TT</figcaption>
</figure>
</div>
</div>
</section>
<section id="from-simulator-to-tello" class="level2">
<h2 class="anchored" data-anchor-id="from-simulator-to-tello">From simulator to Tello</h2>
<p>Let’s start with the most bare approach and replace the <code>TelloSimulator</code> with a new class <code>TelloDrone</code>, with a similar interface, but driving the Tello via <code>djitellopy</code>.</p>
<p>The <code>FlightController</code> stays as it was, so we have all the deadbanding and smoothing goodies there.</p>
<p>Finally, we need to glue these classes together in a similar way we did with the simulator, but without the “fancy” visualization.</p>
<p>The code looks like this at this stage: <a href="https://github.com/pors/tello-play/tree/245ad32d260e0f178c7deb4f6fe4bec322780508/tt-fly">tt-fly WIP</a>.</p>
<p>And yes, it flies!</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/ITfSsa7b3aQ" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="add-video-streaming" class="level2">
<h2 class="anchored" data-anchor-id="add-video-streaming">Add video streaming</h2>
<p>We accomplished what we were set out to do! At least, I was :) Now that we have some momentum, let’s add the video stream.</p>
<p>The <code>djitellopy</code> library makes it straightforward. In the <code>TelloDrone</code> class we initialize video streaming:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make sure stream is off before turning it on</span></span>
<span id="cb1-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-3">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.streamoff()</span>
<span id="cb1-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stopped any existing video stream"</span>)</span>
<span id="cb1-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb1-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Note: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize frame reading with low quality settings</span></span>
<span id="cb1-9"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.set_video_resolution(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.RESOLUTION_480P)</span>
<span id="cb1-10"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.set_video_fps(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.FPS_30)</span>
<span id="cb1-11"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.set_video_bitrate(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.BITRATE_4MBPS)</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now turn on the stream</span></span>
<span id="cb1-14"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.streamon()</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the frame reader</span></span>
<span id="cb1-17"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_read <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.get_frame_read()</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Video stream initialized successfully"</span>)</span></code></pre></div>
<p>Also, we add a method to expose the frame reader to the main app:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_video_frame(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb2-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the current video frame from the drone."""</span></span>
<span id="cb2-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_read <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb2-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb2-7">        frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_read.frame</span>
<span id="cb2-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> frame.size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb2-9">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Warning: Received empty frame"</span>)</span>
<span id="cb2-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> frame</span>
<span id="cb2-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb2-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error getting video frame: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<p>Finally, we read frames from the main app and display it in the pygame window:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display video frame if available</span></span>
<span id="cb3-2">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.drone.get_video_frame()</span>
<span id="cb3-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb3-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Track FPS</span></span>
<span id="cb3-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-6">    now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last_frame_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate FPS every second</span></span>
<span id="cb3-8">        fps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last_frame_time)</span>
<span id="cb3-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fps_stats.append(fps)</span>
<span id="cb3-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fps_stats) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb3-11">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fps_stats.pop(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.frame_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last_frame_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> now</span>
<span id="cb3-14"></span>
<span id="cb3-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert numpy array to pygame surface</span></span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure frame has the right format for pygame</span></span>
<span id="cb3-18">        frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb3-19"></span>
<span id="cb3-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyGame surface</span></span>
<span id="cb3-21">        h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> frame.shape[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-22">        pygame_frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.Surface((w, h))</span>
<span id="cb3-23">        pygame.surfarray.blit_array(pygame_frame, np.swapaxes(frame, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb3-24"></span>
<span id="cb3-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scale if needed</span></span>
<span id="cb3-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pygame_frame.get_size() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> (</span>
<span id="cb3-27">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect.width,</span>
<span id="cb3-28">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect.height,</span>
<span id="cb3-29">        ):</span>
<span id="cb3-30">            pygame_frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.transform.scale(</span>
<span id="cb3-31">                pygame_frame, (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect.width, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect.height)</span>
<span id="cb3-32">            )</span>
<span id="cb3-33"></span>
<span id="cb3-34">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.screen.blit(pygame_frame, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect)</span>
<span id="cb3-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb3-36">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error displaying frame: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw a red border to indicate error</span></span>
<span id="cb3-38">        pygame.draw.rect(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-39"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw a placeholder for video</span></span>
<span id="cb3-41">    pygame.draw.rect(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect)</span>
<span id="cb3-42">    no_video <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.font.render(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No Video Feed"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>))</span>
<span id="cb3-43">    text_rect <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> no_video.get_rect(center<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.video_rect.center)</span>
<span id="cb3-44">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.screen.blit(no_video, text_rect)</span></code></pre></div>
<p>Source for the complete code base: <a href="https://github.com/pors/tello-play/tree/main/tt-fly">tt-fly</a></p>
</section>
<section id="test-flight" class="level2">
<h2 class="anchored" data-anchor-id="test-flight">Test flight!</h2>
<p>Time to try it out with an audience:</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/DKT5b044EuY" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>I think I worked on this more than enough, and I have a plenty of experience with remote controlling a drone now. Time to move on…</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>It is about time to introduce some machine learning. If the goal is to work towards an autonomous drone, at some point I have to get my feet wet. I have plenty of ideas on what to experiment with. Read on for the first one…</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/tello-controller-navigation-part-1/">← Previous: Tello controller navigation - Part 1</a>
</div>
<div>
<a href="../../posts/fly-drone-with-image-classification/">Next: Fly a drone with: Image classification →</a>
</div>
</div>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>pygame</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/tello-controller-navigation-part-2/</guid>
  <pubDate>Sat, 10 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/tello-controller-navigation-part-2/tello-gamesir-t1d-photo.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Tello controller navigation - Part 1</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/tello-controller-navigation-part-1/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-07</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to simulate a Tello drone using Python and pygame—no real drone required</li>
<li>See how to connect and control the simulator with a GameSir T1d controller</li>
<li>Discover practical code architecture for drone control, easily swappable with a real Tello/TT</li>
<li>Get insights into input smoothing, command mapping, and realistic flight physics</li>
<li>Find out how simulation helps debug controller issues and speeds up development</li>
<li>Includes code walkthroughs and a live demo video for hands-on understanding</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/gamesir-t1d-controller/">← Previous: GameSir T1d controller &amp; pygame</a>
</div>
<div>
<a href="../../posts/tello-controller-navigation-part-2/">Next: Tello controller navigation - Part 2 →</a>
</div>
</div>
</div>
</div>
</div>
<section id="what-happened-with-the-tello" class="level2">
<h2 class="anchored" data-anchor-id="what-happened-with-the-tello">What happened with the Tello?</h2>
<p>The whole point was to hook up the controller with the Tello/TT, but it was <a href="../../posts/gamesir-t1d-controller/">not as simple</a> as I thought. Now that is behind us we can again focus on our original goal: control the RoboMaster TT with the GameSir T1d through a Python script running on a computer.</p>
<div style="text-align: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/tello-controller-navigation-part-1/tello-gamesir-t1d.png" class="img-fluid figure-img"></p>
<figcaption>GameSir T1d controlling the Tello (simulation)</figcaption>
</figure>
</div>
</div>
</section>
<section id="simulation-first" class="level2">
<h2 class="anchored" data-anchor-id="simulation-first">Simulation first</h2>
<p>I am traveling right now, and didn’t bring my drone, but I did bring the controller so I could at least get some work done. What can we do without the Tello drone? We ask Claude.ai to whip up a simple simulator!</p>
<p>I am interested in the using simulators anyway. The software/model development cycle with an actual drone in the loop is a bit of a hassle. Especially later on with a larger drone. So, in the style of this blog, we start very simple with the most basic of simulators.</p>
</section>
<section id="the-end-result" class="level2">
<h2 class="anchored" data-anchor-id="the-end-result">The end result</h2>
<p>Before we dive into some of the code, let’s see how it looks like:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/tello-controller-navigation-part-1/tello-simulation.png" class="img-fluid figure-img"></p>
<figcaption>Tello simulation</figcaption>
</figure>
</div>
<p>And you can see it in action here: <a href="https://www.youtube.com/watch?v=w1m1eZZjHrk">Gamesir T1d controller with Tello drone simulation demo</a></p>
<p>It all looks a bit lame, but it has already been very useful!</p>
<p>First of all there was a nasty bug in the controller package that periodically told the drone to land (it pressed the A key out of nowhere every now and then).</p>
<p>Secondly, I needed to think about the architecture of the code, which doesn’t really change when we connect the actual drone.</p>
<p>The code is here: <a href="https://github.com/pors/tello-play/blob/main/tello_controller_sim.py">tello_controller_sim.py</a>.</p>
</section>
<section id="how-does-it-work" class="level2">
<h2 class="anchored" data-anchor-id="how-does-it-work">How does it work?</h2>
<p>The application simulates a Tello drone’s physics and behavior, providing a visual interface that shows:</p>
<ul>
<li>Top-down and side views of the drone</li>
<li>Telemetry data (position, rotation, battery)</li>
<li>Controller state visualization</li>
<li>Flight path trail</li>
</ul>
<p>The simulation includes realistic features like:</p>
<ul>
<li>Gradual takeoff and landing sequences</li>
<li>Battery consumption</li>
<li>Physical constraints (can’t go below ground)</li>
<li>Input filtering for smoother control</li>
</ul>
<p>The code consists of three classes:</p>
<ol type="1">
<li>TelloSimulator - Simulates the physics and state of a virtual drone</li>
<li>FlightController - Handles controller input and sends commands to the drone</li>
<li>DroneSimulatorApp - Main app that integrates everything with visualization</li>
</ol>
<p>Let’s have a look at each class in detail:</p>
<section id="tellosimulator" class="level3">
<h3 class="anchored" data-anchor-id="tellosimulator">TelloSimulator</h3>
<p>This class creates a virtual model of a Tello drone with (more or less) realistic physics. This will be swapped out with the actual drone through the <code>djitellopy</code> library in my next post.</p>
<section id="key-properties" class="level4">
<h4 class="anchored" data-anchor-id="key-properties">Key Properties:</h4>
<ul>
<li><code>position</code> - 3D position vector [x, y, z] in meters</li>
<li><code>rotation</code> - Yaw rotation in degrees (0-360°)</li>
<li><code>velocity</code> - 4D vector [left/right, forward/back, up/down, yaw]</li>
<li><code>is_connected</code>, <code>is_flying</code>, <code>battery</code> - Drone state tracking</li>
<li><code>is_taking_off</code>, <code>is_landing</code> - Transitional states</li>
</ul>
</section>
<section id="key-methods" class="level4">
<h4 class="anchored" data-anchor-id="key-methods">Key Methods:</h4>
<ul>
<li><code>update(dt)</code> - Updates position and state based on time delta</li>
<li><code>takeoff()</code> - Initiates gradual ascent to target height</li>
<li><code>land()</code> - Initiates gradual descent to ground</li>
<li><code>emergency()</code> - Immediately stops motors (safety feature)</li>
<li><code>send_rc_control()</code> - Accepts control values and updates velocity</li>
</ul>
<p>The <code>update()</code> method handles all physics calculations:</p>
<ul>
<li>Different behavior during takeoff/landing phases</li>
<li>Velocity-based position updates with proper trigonometry for directional movement</li>
<li>Battery drain simulation</li>
<li>Prevents clipping through the ground</li>
</ul>
</section>
</section>
<section id="flightcontroller" class="level3">
<h3 class="anchored" data-anchor-id="flightcontroller">FlightController</h3>
<p>This class processes raw controller inputs and translates them into drone commands.</p>
<section id="key-features" class="level4">
<h4 class="anchored" data-anchor-id="key-features">Key Features:</h4>
<ul>
<li>Input smoothing with <code>filter_strength</code> (0.8 = heavy smoothing)</li>
<li><code>deadband</code> (0.03) to ignore tiny accidental joystick movements</li>
<li>Speed control with <code>speed_multiplier</code> (adjustable via L1/R1 buttons)</li>
<li>Fixed rate command sending (20Hz)</li>
<li>Button edge detection (reacts to press, not hold)</li>
<li>Mapping follows “European style” (right stick for primary movement)</li>
</ul>
</section>
<section id="methods" class="level4">
<h4 class="anchored" data-anchor-id="methods">Methods:</h4>
<ul>
<li><code>process_input()</code> - Processes controller inputs with filtering</li>
<li><code>process_buttons()</code> - Handles button presses with edge detection</li>
</ul>
<p>The control flow works like this:</p>
<ol type="1">
<li>Read raw joystick values</li>
<li>Apply deadband (zero out very small inputs)</li>
<li>Apply smoothing filter</li>
<li>Convert to integer values (-100 to 100)</li>
<li>Send commands to drone at fixed intervals</li>
</ol>
</section>
</section>
<section id="dronesimulatorapp" class="level3">
<h3 class="anchored" data-anchor-id="dronesimulatorapp">DroneSimulatorApp</h3>
<p>The main application class that brings everything together. It is more or less a pygame application that takes care of the control loop and visualization. The details are not too interesting.</p>
</section>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>In Part 2 of the Tello controller navigation I will replace the simulator with my RoboMaster TT. Read on…</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/gamesir-t1d-controller/">← Previous: GameSir T1d controller &amp; pygame</a>
</div>
<div>
<a href="../../posts/tello-controller-navigation-part-2/">Next: Tello controller navigation - Part 2 →</a>
</div>
</div>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>pygame</category>
  <category>simulator</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/tello-controller-navigation-part-1/</guid>
  <pubDate>Tue, 06 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/tello-controller-navigation-part-1/tello-gamesir-t1d.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Interlude: GameSir T1d Python package</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/gamesir-t1d-package/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-04</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to package and publish a Python library to PyPI using the modern uv toolchain.</li>
<li>See how to wrap the GameSir T1d Bluetooth controller for use with Python and pygame.</li>
<li>Discover how to scan for your controller, connect, and read inputs using a pygame-compatible API.</li>
<li>Get practical, step-by-step instructions for project setup, dependency management, and testing.</li>
<li>Access example scripts and source code to quickly integrate the controller into your own projects.</li>
</ul>
</div>
</div>
</div>
<section id="lets-package-up-the-gamesir-t1d-wrapper" class="level2">
<h2 class="anchored" data-anchor-id="lets-package-up-the-gamesir-t1d-wrapper">Let’s package up the Gamesir T1d wrapper</h2>
<p>For some context: this post is a tangent on this article about <a href="../../posts/gamesir-t1d-controller/">making the GameSir T1d controller work with pygame</a>.</p>
<p>I know, no one is ever going to use it apart from me. The Gamesir T1d is ancient, and the use case (using it with pygame to control a Tello) is also not very common. But I’m here to learn and try things out, and this gives me the opportunity to play with:</p>
<ul>
<li><a href="https://docs.astral.sh/uv/">uv</a>: this “new” package manager is pretty great, and I need to use it more often to get rid of old habits (pip, venv, pyenv, etc.).</li>
<li>Create a <a href="https://pypi.org/">pypi</a> package: I have never created and published a pypi package, so fun to give that a shot.</li>
<li><a href="https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/overview">Claude code</a>: I have used this in the past and it seems promising, so let’s vibe-code our way to a package.</li>
</ul>
<p>But first, a logo! :P</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/gamesir-t1d-package/gamesir-t1d-pypy.png" class="img-fluid figure-img"></p>
<figcaption>GameSir T1d Python package</figcaption>
</figure>
</div>
</section>
<section id="six-steps-to-a-published-package" class="level2">
<h2 class="anchored" data-anchor-id="six-steps-to-a-published-package">Six steps to a published package</h2>
<section id="step-1-ditch-claude-code" class="level3">
<h3 class="anchored" data-anchor-id="step-1-ditch-claude-code">Step 1: Ditch Claude code</h3>
<p>It is really very easy to create a pypi package, but Claude code overcomplicated things, and in the end it got stuck. So the first step: ditch Claude code. I’m not a big fan of vibe coding (at least not today), and this confirms again why.</p>
</section>
<section id="step-2-create-a-project" class="level3">
<h3 class="anchored" data-anchor-id="step-2-create-a-project">Step 2: Create a project</h3>
<p><code>uv</code> has a built-in way to create projects we want to publish as a package, using the <code>--lib</code> switch:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--lib</span> gamesir-t1d</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> gamesir-t1d</span></code></pre></div>
<p>Next, we need to add <code>bleak</code> as a dependency:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add bleak</span></code></pre></div>
<p>For the example code to work we also need to add <code>pygame</code>.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add pygame</span></code></pre></div>
<p>It creates the files (and virtual env) we need as a starting point:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> pyproject.toml</span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> README.md</span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> src</span>
<span id="cb4-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span> └── gamesir_t1d</span>
<span id="cb4-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     └── __init__.py</span>
<span id="cb4-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> uv.lock</span></code></pre></div>
</section>
<section id="step-3-add-modules" class="level3">
<h3 class="anchored" data-anchor-id="step-3-add-modules">Step 3: Add modules</h3>
<p>This is simply moving the code we created in the <a href="../../posts/gamesir-t1d-controller/">previous post</a> post into the right spots. Which results in:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> LICENSE</span>
<span id="cb5-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> pyproject.toml</span>
<span id="cb5-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> README.md</span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> src</span>
<span id="cb5-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span> └── gamesir_t1d</span>
<span id="cb5-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     ├── __init__.py</span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     ├── controller.py</span>
<span id="cb5-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     ├── examples</span>
<span id="cb5-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     │&nbsp;&nbsp; └── pygame_example.py</span>
<span id="cb5-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>     └── tools</span>
<span id="cb5-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>         ├── __init__.py</span>
<span id="cb5-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│&nbsp;&nbsp;</span>         └── ble_scanner.py</span>
<span id="cb5-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> uv.lock</span></code></pre></div>
<p>Make sure the pyproject.toml has the right metadata. The latest version is here: <a href="https://github.com/pors/gamesir_t1d/blob/main/pyproject.toml">pyproject.toml</a>.</p>
<p>An interesting feature is to include scripts in a package. After installing a package you can run these scripts on the command line. This is done in the pyproject.toml as:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">project.scripts</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb6-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamesir-scan = "gamesir_t1d.tools.ble_scanner:run_scanner"</span></span></code></pre></div>
<p>This is perfect for us to make the BLE scanner available, so users can figure out the name of their controller.</p>
</section>
<section id="step-4-build-and-publish" class="level3">
<h3 class="anchored" data-anchor-id="step-4-build-and-publish">Step 4: Build and publish</h3>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> build</span></code></pre></div>
<p>This creates two files in the /dist directory:</p>
<ul>
<li>gamesir_t1d-0.1.1-py3-none-any.whl</li>
<li>gamesir_t1d-0.1.1.tar.gz</li>
</ul>
<p>which are the binary and the source version of the package.</p>
<p>Let’s publish it to <a href="https://test.pypi.org">test.pypi.org</a> first:</p>
<ol type="1">
<li>Create an account on test.pypi.org</li>
<li>Obtain an API token</li>
<li>Run this command:</li>
</ol>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> uv publish <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--token</span> pypi-TEST_TOKEN_HERE <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--publish-url</span> https://test.pypi.org/legacy/</span></code></pre></div>
</section>
<section id="step-5-test" class="level3">
<h3 class="anchored" data-anchor-id="step-5-test">Step 5: Test</h3>
<p>To test it, we create a new project and install the package there.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init gstest</span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> gstest</span>
<span id="cb9-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--index-url</span> https://test.pypi.org/simple/ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--extra-index-url</span> https://pypi.org/simple gamesir-t1d</span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import gamesir_t1d; print(gamesir_t1d.__version__)"</span></span></code></pre></div>
<p>If that prints the version number, it all works!</p>
<p>Now, let’s try the scanner (make sure the controller is switched on):</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> gamesir-scan</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Make</span> sure the GameSir-T1d controller is turned on and in pairing mode.</span>
<span id="cb10-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Typically</span> hold power button until LEDs flash rapidly<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb10-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Press</span> Enter to start scanning...</span>
<span id="cb10-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Starting</span> BLE scan for GameSir-T1d controller...</span>
<span id="cb10-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Scanning</span> for BLE devices <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">timeout:</span> 3.0s<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb10-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Found</span> 14 Bluetooth devices:</span>
<span id="cb10-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1.</span> Name: None, Address: E6682D99-DC5A-EE5A-9E95-DAC5BF163FC1</span>
<span id="cb10-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb10-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">6.</span> Name: Gamesir-T1d-39BD, Address: FDF00BC3-1DEE-1525-0B34-7E2D3391C401</span>
<span id="cb10-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb10-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">13.</span> Name: None, Address: 19EC6BCE-BE63-CD90-E9D6-9C91EA838008</span>
<span id="cb10-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">14.</span> Name: None, Address: 3222F9B7-2970-77BF-6814-9FB82F843839</span>
<span id="cb10-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Found</span> controller: Gamesir-T1d-39BD, Address: FDF00BC3-1DEE-1525-0B34-7E2D3391C401</span>
<span id="cb10-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Attempting</span> to connect to Gamesir-T1d-39BD...</span>
<span id="cb10-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Successfully</span> connected to Gamesir-T1d-39BD!</span>
<span id="cb10-18"></span>
<span id="cb10-19"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Available</span> services and characteristics:</span>
<span id="cb10-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Service:</span> 00008650-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-21">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00008651-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-22">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'write'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'notify'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicate'</span>]</span>
<span id="cb10-23">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00008655-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-24">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'write'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'notify'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicate'</span>]</span>
<span id="cb10-25">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 0000865f-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-26">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'write'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'notify'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicate'</span>]</span>
<span id="cb10-27"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Service:</span> 0000180a-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-28">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00002a24-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-29">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb10-30">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00002a25-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-31">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb10-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assuming you've installed the package with the [examples] extra</span></span>
<span id="cb10-33">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00002a27-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-34">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb10-35">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00002a26-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-36">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb10-37">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Characteristic:</span> 00002a50-0000-1000-8000-00805f9b34fb</span>
<span id="cb10-38">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Properties:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'read'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb10-39"></span>
<span id="cb10-40"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Connection</span> successful. Press Ctrl+C to exit...</span></code></pre></div>
<p>Now we have the controller ID, let’s run a basic script:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gamesir_t1d <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GameSirT1dPygame</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the controller object with your controller's name</span></span>
<span id="cb11-4">controller <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GameSirT1dPygame(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-39BD"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace XXXX with your controller ID</span></span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the controller (starts BLE connection)</span></span>
<span id="cb11-7">controller.init()</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read axes and buttons using the pygame-compatible interface</span></span>
<span id="cb11-10">left_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Range: -1.0 to 1.0</span></span>
<span id="cb11-11">left_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Range: -1.0 to 1.0</span></span>
<span id="cb11-12">a_button <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_button(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 for pressed, 0 for not pressed</span></span>
<span id="cb11-13"></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the controller is connected</span></span>
<span id="cb11-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> controller.is_connected():</span>
<span id="cb11-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Controller is connected!"</span>)</span>
<span id="cb11-17"></span>
<span id="cb11-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean up when done</span></span>
<span id="cb11-19">controller.quit()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb12-1">Scanning for Gamesir-T1d-39BD...</span>
<span id="cb12-2">Found Gamesir-T1d-39BD at FDF00BC3-1DEE-1525-0B34-7E2D3391C401</span>
<span id="cb12-3">Connecting...</span>
<span id="cb12-4">Connected!</span>
<span id="cb12-5">Controller is connected!</span></code></pre></div>
</div>
</section>
<section id="step-6-publish-for-real" class="level3">
<h3 class="anchored" data-anchor-id="step-6-publish-for-real">Step 6: Publish for real!</h3>
<p>It all seems to work, so now we can publish the package on pypi.org! Again, create an account and generate an API token first, then:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> publish <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--token</span> pypi-YourToken</span></code></pre></div>
<p>And there we have it, our package: <a href="https://pypi.org/project/gamesir-t1d/">pypi.org/project/gamesir-t1d/</a>!</p>
<p>We repeat the same steps as before for testing:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init gstest2</span>
<span id="cb14-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> gstest2</span>
<span id="cb14-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add gamesir-t1d</span>
<span id="cb14-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import gamesir_t1d; print(gamesir_t1d.__version__)"</span></span></code></pre></div>
<p>No need to run the scanner, the controller ID is still what is was :)</p>
<p>Now, run the examples included in the package:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gamesir_t1d.examples.pygame_example <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> test_without_pygame</span>
<span id="cb15-2"></span>
<span id="cb15-3">test_without_pygame(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-XXXX"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace XXXX with your controller ID</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gamesir_t1d.examples <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> run</span>
<span id="cb16-2"></span>
<span id="cb16-3">run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-XXXX"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace XXXX with your controller ID</span></span></code></pre></div>
<p>This will run the test as shown in this <a href="https://www.youtube.com/watch?v=7sMoOxHOOcM">video</a>.</p>
<p>The source code can be found <a href="https://github.com/pors/gamesir_t1d">here</a>.</p>
</section>
</section>
<section id="wrapping-it-up" class="level2">
<h2 class="anchored" data-anchor-id="wrapping-it-up">Wrapping it up!</h2>
<p>Haha, dad joke there.</p>
<p>There is nothing to wrap up anyway.</p>
<p>If you are interested in reading more about drones, coding, and machine learning (soon), start here: <a href="../../series/index.html">Code, Fly &amp; AI</a>.</p>


</section>

 ]]></description>
  <category>pygame</category>
  <category>code</category>
  <category>open-source</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/gamesir-t1d-package/</guid>
  <pubDate>Sat, 03 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/gamesir-t1d-package/gamesir-t1d-pypy.png" medium="image" type="image/png" height="122" width="144"/>
</item>
<item>
  <title>GameSir T1d controller &amp; pygame</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/gamesir-t1d-controller/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-05-02</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Connect a GameSir T1d controller to your computer via Bluetooth using a BLE hacking approach (the controller normally only works with the Tello app)</li>
<li>Parse controller input data for all buttons, joysticks, and triggers using Python and bleak</li>
<li>Create a pygame-compatible wrapper that lets you use the controller in any Python application</li>
<li>Control your Tello drone with precise analog joysticks instead of keyboard keys</li>
<li>Complete working code provided with step-by-step explanation of the controller hacking process</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/key-navigation-video-snapshots/">← Previous: Key navigation &amp; video snapshots</a>
</div>
<div>
<a href="../../posts/tello-controller-navigation-part-1/">Next: Tello controller navigation - Part 1 →</a>
</div>
</div>
</div>
</div>
</div>
<p>Controlling a drone with a keyboard is not great, neither is using the touch-screen of a phone. That’s why I bought the recommended controller for the Tello: the <a href="https://www.manualpdf.in/dji/tello-gamesir-t1d/manual">GameSir T1d</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/gamesir-t1d-controller/GameSir-T1d.png" class="img-fluid figure-img"></p>
<figcaption>GameSir T1d controller</figcaption>
</figure>
</div>
<section id="hook-up-the-gamesir-t1d" class="level2">
<h2 class="anchored" data-anchor-id="hook-up-the-gamesir-t1d">Hook up the GameSir T1d</h2>
<p>Initially this seemed like a no-brainer, and I was surprised why no-one else hadn’t done it yet: replace the keyboard strokes with signals from the GameSir T1d controller. It turns out that this controller was specifically modified to connect ONLY through the Tello app.</p>
<p>Normally the code below is enough to connect to a game controller from a python script:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pygame</span>
<span id="cb1-2"></span>
<span id="cb1-3">pygame.init()</span>
<span id="cb1-4">pygame.joystick.init()</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for connected controllers</span></span>
<span id="cb1-7">joystick_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.joystick.get_count()</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> joystick_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb1-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No controller detected. Please connect your GameSir T1d controller."</span>)</span>
<span id="cb1-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the first controller detected</span></span>
<span id="cb1-14">joystick <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.joystick.Joystick(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-15">joystick.init()</span></code></pre></div>
<p>In our case the output was:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb2-1">No controller detected. Please connect your GameSir T1d controller.</span></code></pre></div>
<p>Oh oh, problem!</p>
</section>
<section id="hack-it" class="level2">
<h2 class="anchored" data-anchor-id="hack-it">Hack it!</h2>
<p>After some searching and LLM’ing it became clear that there <em>is</em> a way to make it work.</p>
<p><strong>Pfew!</strong></p>
<p>For Internet historians, here is the evolution of the hack:</p>
<ol type="1">
<li><a href="https://cloud.tencent.com/developer/article/1756298">original Python 2 script</a></li>
<li><a href="https://github.com/Diallomm/hack_GamesirT1d/tree/main">ported to Python 3</a></li>
<li><a href="https://gist.github.com/ElishaAz/a83dfa8f2d53497d7d1d0bca03bfced2">using bleak</a></li>
<li><a href="https://gist.github.com/Cacti-Master/89f0f397a13f28ada046ec42477bc9fd">refactor</a></li>
</ol>
</section>
<section id="gamesir-t1d-hack-version-5" class="level2">
<h2 class="anchored" data-anchor-id="gamesir-t1d-hack-version-5">GameSir T1D hack version 5</h2>
<p>I’m honored to step in the footsteps of these four hackers and try to get iteration five to work!</p>
<p>First we need to get the controller to connect. Simply pairing via Bluetooth won’t work.</p>
<p>The GameSir T1d gets into pairing mode by simply powering it on. The four blue power LEDs start blinking when trying to connect. At that state we run the script below (on github: <a href="https://github.com/pors/tello-play/blob/main/gamesirT1d-connect.py">gamesirT1d-connect.py</a>).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>There is a tiny button labeled <code>pair</code> above another tiny button labeled <code>C1</code>. This <code>pair</code> button can be used to pair a new device (great UX!). Clicking it while connected, will cause the Bluetooth connection to be dropped. So don’t click it while controlling a drone!</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">BLE Controller Connection Preview</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Full script</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">Output</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bleak <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BleakClient, BleakScanner</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The name our controller should broadcast as</span></span>
<span id="cb3-5">CONTROLLER_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d"</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb3-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Starting BLE scan for GameSir-T1d controller..."</span>)</span></code></pre></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bleak <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BleakClient, BleakScanner</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The name our controller should broadcast as</span></span>
<span id="cb4-5">CONTROLLER_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d"</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb4-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Starting BLE scan for GameSir-T1d controller..."</span>)</span>
<span id="cb4-9"></span>
<span id="cb4-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First, scan for all available BLE devices</span></span>
<span id="cb4-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scanning for BLE devices..."</span>)</span>
<span id="cb4-12">    devices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> BleakScanner.discover()</span>
<span id="cb4-13"></span>
<span id="cb4-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print all found devices to help with debugging</span></span>
<span id="cb4-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Found </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(devices)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Bluetooth devices:"</span>)</span>
<span id="cb4-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, device <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(devices):</span>
<span id="cb4-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. Name: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Address: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>address<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-18"></span>
<span id="cb4-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try to find our controller</span></span>
<span id="cb4-20">    target_device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> device <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> devices:</span>
<span id="cb4-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> device.name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> CONTROLLER_NAME.lower() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> device.name.lower():</span>
<span id="cb4-23">            target_device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> device</span>
<span id="cb4-24">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Found controller: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Address: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>address<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-25">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb4-26"></span>
<span id="cb4-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> target_device:</span>
<span id="cb4-28">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"No device found with name containing '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>CONTROLLER_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb4-29">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Is the controller turned on and in pairing mode?"</span>)</span>
<span id="cb4-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb4-31"></span>
<span id="cb4-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try to connect to the controller</span></span>
<span id="cb4-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Attempting to connect to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>target_device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">..."</span>)</span>
<span id="cb4-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> BleakClient(target_device.address, timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> client:</span>
<span id="cb4-36">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> client.is_connected:</span>
<span id="cb4-37">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Successfully connected to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>target_device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">!"</span>)</span>
<span id="cb4-38"></span>
<span id="cb4-39">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List available services and characteristics</span></span>
<span id="cb4-40">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Available services and characteristics:"</span>)</span>
<span id="cb4-41">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> service <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> client.services:</span>
<span id="cb4-42">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Service: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>service<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>uuid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-43">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> char <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> service.characteristics:</span>
<span id="cb4-44">                        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Characteristic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>char<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>uuid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-45">                        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Properties: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>char<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>properties<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-46"></span>
<span id="cb4-47">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wait a moment so we can see the connection is established</span></span>
<span id="cb4-48">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Connection successful. Press Ctrl+C to exit..."</span>)</span>
<span id="cb4-49">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb4-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-51">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to connect"</span>)</span>
<span id="cb4-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-53">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error connecting to device: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-54"></span>
<span id="cb4-55"></span>
<span id="cb4-56"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb4-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make sure controller is in pairing mode before running this</span></span>
<span id="cb4-58">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Make sure the GameSir-T1d controller is turned on and in pairing mode."</span>)</span>
<span id="cb4-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Typically hold power button until LEDs flash rapidly)"</span>)</span>
<span id="cb4-60">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Press Enter to start scanning..."</span>)</span>
<span id="cb4-61"></span>
<span id="cb4-62">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the async main function</span></span>
<span id="cb4-63">    asyncio.run(main())</span></code></pre></div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<pre class="text"><code>Make sure the GameSir-T1d controller is turned on and in pairing mode.
(Typically hold power button until LEDs flash rapidly)
Press Enter to start scanning...
Starting BLE scan for GameSir-T1d controller...
Scanning for BLE devices...
Found 11 Bluetooth devices:
1. Name: Gamesir-T1d-39BD, Address: FDF00BC3-1DEE-1525-0B34-7E2D3391C401
2. Name: None, Address: 3A2C8191-D3F5-F471-BC81-75AFE2DB0D60
3. Name: None, Address: 772F5433-AAE9-D456-209C-DEA32D192E10
...
11. Name: None, Address: 80334171-1943-B3DE-7DDD-773753B852C3
Found controller: Gamesir-T1d-39BD, Address: FDF00BC3-1DEE-1525-0B34-7E2D3391C401
Attempting to connect to Gamesir-T1d-39BD...
Successfully connected to Gamesir-T1d-39BD!

Available services and characteristics:
Service: 00008650-0000-1000-8000-00805f9b34fb
  Characteristic: 00008651-0000-1000-8000-00805f9b34fb
    Properties: ['read', 'write', 'notify', 'indicate']
  Characteristic: 00008655-0000-1000-8000-00805f9b34fb
    Properties: ['read', 'write', 'notify', 'indicate']
  Characteristic: 0000865f-0000-1000-8000-00805f9b34fb
    Properties: ['read', 'write', 'notify', 'indicate']
Service: 0000180a-0000-1000-8000-00805f9b34fb
  Characteristic: 00002a24-0000-1000-8000-00805f9b34fb
    Properties: ['read']
  Characteristic: 00002a25-0000-1000-8000-00805f9b34fb
    Properties: ['read']
  Characteristic: 00002a27-0000-1000-8000-00805f9b34fb
    Properties: ['read']
  Characteristic: 00002a26-0000-1000-8000-00805f9b34fb
    Properties: ['read']
  Characteristic: 00002a50-0000-1000-8000-00805f9b34fb
    Properties: ['read']

Connection successful. Press Ctrl+C to exit...</code></pre>
</div>
</div>
</div>
<p>If you have inspected the output tab, you see we succeeded! Yay, let’s move on.</p>
</section>
<section id="read-the-t1d-controller-state" class="level2">
<h2 class="anchored" data-anchor-id="read-the-t1d-controller-state">Read the T1d controller state</h2>
<p>Now the controller is connected to the computer, let’s see if we can read joystick and button changes.</p>
<p>There’s a heap of input elements that need to be read and made compatible with gamepy:</p>
<ul>
<li>Both joysticks (LX, LY, RX, RY)</li>
<li>Analog triggers (L2, R2)</li>
<li>Buttons (A, B, X, Y, L1, R1, C1, C2, Menu)</li>
<li>D-pad (Up, Down, Left, Right)</li>
</ul>
<p>The script below prints the real-time value of each of these inputs while using the controller (on github: <a href="https://github.com/pors/tello-play/blob/main/gamesirT1d-read.py">gamesirT1d-read.py</a>).</p>
<p>From here on we don’t need to pair the controller, we just use the device name that was identified in the previous step.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">Read Controller State Preview</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Full script</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false">Output</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bleak <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BleakClient, BleakScanner</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The exact name our controller showed up as</span></span>
<span id="cb6-5">CONTROLLER_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-39BD"</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The characteristic we want to read</span></span>
<span id="cb6-7">CHARACTERISTIC_UUID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"00008651-0000-1000-8000-00805f9b34fb"</span></span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> GameSirT1d:</span></code></pre></div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bleak <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BleakClient, BleakScanner</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The exact name our controller showed up as</span></span>
<span id="cb7-5">CONTROLLER_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-39BD"</span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The characteristic we want to read</span></span>
<span id="cb7-7">CHARACTERISTIC_UUID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"00008651-0000-1000-8000-00805f9b34fb"</span></span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> GameSirT1d:</span>
<span id="cb7-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Joystick values (0-1023, with 512 as center)</span></span>
<span id="cb7-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb7-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb7-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.rx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb7-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span></span>
<span id="cb7-16">        </span>
<span id="cb7-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Analog triggers (0-255)</span></span>
<span id="cb7-18">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.l2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-20">        </span>
<span id="cb7-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Digital buttons (0 or 1)</span></span>
<span id="cb7-22">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-23">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-24">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-25">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-26">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.l1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-28">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-29">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.menu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-31">        </span>
<span id="cb7-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># D-pad</span></span>
<span id="cb7-33">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_up <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-34">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_down <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-35">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-36">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-37">        </span>
<span id="cb7-38">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Connection state</span></span>
<span id="cb7-39">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb7-40">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb7-41">    </span>
<span id="cb7-42">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> parse_data(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data):</span>
<span id="cb7-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Parse the raw data from the controller"""</span></span>
<span id="cb7-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:</span>
<span id="cb7-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb7-46">        </span>
<span id="cb7-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse joysticks</span></span>
<span id="cb7-48">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb7-49">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x3f</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb7-50">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.rx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-51">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x3</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ((data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]))</span>
<span id="cb7-52">        </span>
<span id="cb7-53">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse triggers</span></span>
<span id="cb7-54">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.l2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]</span>
<span id="cb7-55">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]</span>
<span id="cb7-56">        </span>
<span id="cb7-57">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse buttons from byte 9</span></span>
<span id="cb7-58">        buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>]</span>
<span id="cb7-59">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x01</span>))</span>
<span id="cb7-60">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x02</span>))</span>
<span id="cb7-61">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.menu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x04</span>))</span>
<span id="cb7-62">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x08</span>))</span>
<span id="cb7-63">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x10</span>))</span>
<span id="cb7-64">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.l1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x40</span>))</span>
<span id="cb7-65">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x80</span>))</span>
<span id="cb7-66">        </span>
<span id="cb7-67">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse more buttons from byte 10</span></span>
<span id="cb7-68">        buttons2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb7-69">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x04</span>))</span>
<span id="cb7-70">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(buttons2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x08</span>))</span>
<span id="cb7-71">        </span>
<span id="cb7-72">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse D-pad from byte 11</span></span>
<span id="cb7-73">        dpad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>]</span>
<span id="cb7-74">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_up <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(dpad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x01</span>)</span>
<span id="cb7-75">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_right <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(dpad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x03</span>)</span>
<span id="cb7-76">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_down <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(dpad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x05</span>)</span>
<span id="cb7-77">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dpad_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(dpad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x07</span>)</span>
<span id="cb7-78">        </span>
<span id="cb7-79">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb7-80">    </span>
<span id="cb7-81">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__str__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-82">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return a string representation of the controller state"""</span></span>
<span id="cb7-83">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (</span>
<span id="cb7-84">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Joysticks: LX=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>lx<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, LY=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ly<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, RX=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rx<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, RY=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ry<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb7-85">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Triggers: L2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, R2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>r2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb7-86">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Buttons: A=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, B=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, X=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Y=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, "</span></span>
<span id="cb7-87">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"L1=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, R1=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>r1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, C1=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>c1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, C2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>c2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Menu=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>menu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb7-88">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"D-pad: Up=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dpad_up<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Down=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dpad_down<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Left=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dpad_left<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Right=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dpad_right<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb7-89">        )</span>
<span id="cb7-90">    </span>
<span id="cb7-91">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add methods to get normalized values (-1.0 to 1.0) for joysticks</span></span>
<span id="cb7-92">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_left_stick(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-93">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get normalized values for left stick (-1.0 to 1.0)"""</span></span>
<span id="cb7-94">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1.0 to 1.0</span></span>
<span id="cb7-95">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1.0 to 1.0</span></span>
<span id="cb7-96">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (x, y)</span>
<span id="cb7-97">    </span>
<span id="cb7-98">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_right_stick(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-99">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get normalized values for right stick (-1.0 to 1.0)"""</span></span>
<span id="cb7-100">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.rx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1.0 to 1.0</span></span>
<span id="cb7-101">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1.0 to 1.0</span></span>
<span id="cb7-102">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (x, y)</span>
<span id="cb7-103"></span>
<span id="cb7-104"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb7-105">    controller <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GameSirT1d()</span>
<span id="cb7-106">    </span>
<span id="cb7-107">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Scanning for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>CONTROLLER_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">..."</span>)</span>
<span id="cb7-108">    device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> BleakScanner.find_device_by_name(CONTROLLER_NAME)</span>
<span id="cb7-109">    </span>
<span id="cb7-110">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> device:</span>
<span id="cb7-111">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Could not find </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>CONTROLLER_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. Is it turned on?"</span>)</span>
<span id="cb7-112">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb7-113">    </span>
<span id="cb7-114">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Found </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>CONTROLLER_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> at </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>address<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-115">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connecting..."</span>)</span>
<span id="cb7-116">    </span>
<span id="cb7-117">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb7-118">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> BleakClient(device.address) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> client:</span>
<span id="cb7-119">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connected!"</span>)</span>
<span id="cb7-120">            controller.connected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb7-121">            controller._client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client</span>
<span id="cb7-122">            </span>
<span id="cb7-123">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb7-124">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> controller.connected:</span>
<span id="cb7-125">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read current state</span></span>
<span id="cb7-126">                    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> client.read_gatt_char(CHARACTERISTIC_UUID)</span>
<span id="cb7-127">                    </span>
<span id="cb7-128">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse the data</span></span>
<span id="cb7-129">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> controller.parse_data(data):</span>
<span id="cb7-130">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get normalized stick values for easier use</span></span>
<span id="cb7-131">                        left_x, left_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_left_stick()</span>
<span id="cb7-132">                        right_x, right_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_right_stick()</span>
<span id="cb7-133">                        </span>
<span id="cb7-134">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clear the line and print current state</span></span>
<span id="cb7-135">                        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\r</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Left: (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>left_x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>left_y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) Right: (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>right_x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>right_y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) | "</span></span>
<span id="cb7-136">                              <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"A:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> B:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> X:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Y:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> "</span></span>
<span id="cb7-137">                              <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"L1:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> R1:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>r1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> L2:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> R2:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>controller<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>r2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb7-138">                    </span>
<span id="cb7-139">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wait a bit before next reading</span></span>
<span id="cb7-140">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 20Hz polling rate</span></span>
<span id="cb7-141">                    </span>
<span id="cb7-142">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">KeyboardInterrupt</span>:</span>
<span id="cb7-143">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Stopping..."</span>)</span>
<span id="cb7-144">                controller.connected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb7-145">    </span>
<span id="cb7-146">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb7-147">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-148">        controller.connected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb7-149"></span>
<span id="cb7-150"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb7-151">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GameSir T1d Controller Test"</span>)</span>
<span id="cb7-152">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Move joysticks and press buttons to see values"</span>)</span>
<span id="cb7-153">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Press Ctrl+C to exit"</span>)</span>
<span id="cb7-154">    </span>
<span id="cb7-155">    asyncio.run(main())</span></code></pre></div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb8-1">GameSir T1d Controller Test</span>
<span id="cb8-2">Move joysticks and press buttons to see values</span>
<span id="cb8-3">Press Ctrl+C to exit</span>
<span id="cb8-4">Scanning for Gamesir-T1d-39BD...</span>
<span id="cb8-5">Found Gamesir-T1d-39BD at FDF00BC3-1DEE-1525-0B34-7E2D3391C401</span>
<span id="cb8-6">Connecting...</span>
<span id="cb8-7">Connected!</span>
<span id="cb8-8">Left: (0.05, 0.03) Right: (-0.10, -0.13) | A:1 B:0 X:0 Y:0 L1:0 R1:0 L2:3 R2:155</span></code></pre></div>
</div>
</div>
</div>
<p>That seems to work pretty good! Now we can move on and create a wrapper that behaves as if it was part of a gamepy compatible controller.</p>
</section>
<section id="gamesir-t1d-pygame-compatible-wrapper" class="level2">
<h2 class="anchored" data-anchor-id="gamesir-t1d-pygame-compatible-wrapper">GameSir T1d Pygame-Compatible Wrapper</h2>
<p>The wrapper functions as a bridge between two worlds:</p>
<ol type="1">
<li>The BLE communication layer that talks directly to our GameSir T1d</li>
<li>A pygame-compatible interface that provides familiar methods like get_axis() and get_button()</li>
</ol>
<p>This allows our drone control code to interact with the controller as if it were a standard pygame joystick, while the BLE communication happens behind the scenes.</p>
<p>The wrapper code consists of two classes:</p>
<ol type="1">
<li>GameSirT1d: this class parses the raw inputs from the controller and converts it to the format and ranges we expect in a pygame controller.</li>
<li>GameSirT1dPygame: this class implements the BLE interface and provides the pygame compatible wrapper.</li>
</ol>
<p>The code can be found here: <a href="https://github.com/pors/tello-play/blob/main/gamesir_t1d_pygame.py">gamesir_t1d_pygame.py</a>.</p>
</section>
<section id="lets-try-it-out" class="level2">
<h2 class="anchored" data-anchor-id="lets-try-it-out">Let’s try it out!</h2>
<p>With this little example script we can see if the controller (at least the thumpsticks) does what we expect:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pygame</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gamesir_t1d_pygame <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GameSirT1dPygame</span>
<span id="cb9-3"></span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main(controller_name):</span>
<span id="cb9-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize pygame for window and graphics</span></span>
<span id="cb9-7">    pygame.init()</span>
<span id="cb9-8">    screen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.display.set_mode((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">640</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>))</span>
<span id="cb9-9">    pygame.display.set_caption(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GameSir T1d Test"</span>)</span>
<span id="cb9-10">    clock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.time.Clock()</span>
<span id="cb9-11"></span>
<span id="cb9-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize our custom controller</span></span>
<span id="cb9-13">    controller <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GameSirT1dPygame(controller_name)</span>
<span id="cb9-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connecting to controller..."</span>)</span>
<span id="cb9-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> controller.init():</span>
<span id="cb9-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to connect to controller"</span>)</span>
<span id="cb9-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb9-18"></span>
<span id="cb9-19">    running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb9-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> running:</span>
<span id="cb9-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process pygame events</span></span>
<span id="cb9-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> event <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pygame.event.get():</span>
<span id="cb9-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> event.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.QUIT:</span>
<span id="cb9-24">                running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb9-25"></span>
<span id="cb9-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read joystick values</span></span>
<span id="cb9-27">        left_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb9-28">        left_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-29">        right_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-30">        right_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> controller.get_axis(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb9-31"></span>
<span id="cb9-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clear screen</span></span>
<span id="cb9-33">        screen.fill((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-34"></span>
<span id="cb9-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw joystick positions</span></span>
<span id="cb9-36">        pygame.draw.circle(</span>
<span id="cb9-37">            screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">160</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb9-38">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Left stick background</span></span>
<span id="cb9-39">        pygame.draw.circle(</span>
<span id="cb9-40">            screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">160</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(left_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(left_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb9-41">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Left stick position</span></span>
<span id="cb9-42"></span>
<span id="cb9-43">        pygame.draw.circle(</span>
<span id="cb9-44">            screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb9-45">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Right stick background</span></span>
<span id="cb9-46">        pygame.draw.circle(</span>
<span id="cb9-47">            screen, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(right_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(right_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb9-48">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Right stick position</span></span>
<span id="cb9-49"></span>
<span id="cb9-50">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update display</span></span>
<span id="cb9-51">        pygame.display.flip()</span>
<span id="cb9-52"></span>
<span id="cb9-53">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Control frame rate</span></span>
<span id="cb9-54">        clock.tick(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb9-55"></span>
<span id="cb9-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean up</span></span>
<span id="cb9-57">    controller.quit()</span>
<span id="cb9-58">    pygame.quit()</span>
<span id="cb9-59"></span>
<span id="cb9-60"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb9-61">    main(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamesir-T1d-39BD"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># replace with the name of your T1d</span></span></code></pre></div>
<p>Look at that! Pretty responsive!</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/7sMoOxHOOcM" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>Now that we have the T1d working with pygame we can implement the interface with the Tello. Read on…</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/key-navigation-video-snapshots/">← Previous: Key navigation &amp; video snapshots</a>
</div>
<div>
<a href="../../posts/tello-controller-navigation-part-1/">Next: Tello controller navigation - Part 1 →</a>
</div>
</div>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>pygame</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/gamesir-t1d-controller/</guid>
  <pubDate>Thu, 01 May 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/gamesir-t1d-controller/GameSir-T1d.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Key navigation &amp; Video snapshots</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/key-navigation-video-snapshots/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-04-27</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Learn how to control a Tello drone using keyboard navigation with responsive, event-based controls in Python (via pygame).</li>
<li>Understand why velocity-based commands and fixed frame-rate updates create smoother, more natural drone movement.</li>
<li>See how to stream live video from the drone, process frames, and overlay status info (like battery level).</li>
<li>Get step-by-step instructions to add a keyboard shortcut for saving video snapshots directly from the drone feed.</li>
<li>Discover practical tips for reliable streaming and why naive command loops don’t work well for real-time control.</li>
<li>Preview what’s next: moving from keyboard to game controller navigation for even better piloting.</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/crash-the-tello/">← Previous: Crash the Tello</a>
</div>
<div>
<a href="../../posts/gamesir-t1d-controller/">Next: GameSir T1d &amp; pygame →</a>
</div>
</div>
</div>
</div>
</div>
<section id="keyboard-navigation" class="level2">
<h2 class="anchored" data-anchor-id="keyboard-navigation">Keyboard navigation</h2>
<p>Now that we can control the TT with code, let’s extend that to a human in the ground-bound pilot seat. The most simple approach is to use specific keyboard strokes to map to drone navigation commands.</p>
<p>Keyboard navigation is implemented as an example in the DJSTelloPy repo: <a href="https://github.com/damiafuentes/DJITelloPy/blob/master/examples/manual-control-pygame.py">manual-control-pygame.py</a>. This is quite a cool piece of code. It uses pygame, which I never used before, so lets go through some of the interesting parts of the code.</p>
<section id="the-secret-sauce-event-based-controls" class="level3">
<h3 class="anchored" data-anchor-id="the-secret-sauce-event-based-controls">The secret sauce: Event-based controls</h3>
<p>The example uses pygame’s event system rather than simple polling, and this creates nice and responsive controls.</p>
<div id="8d77cf63" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up a timer that triggers events at the specified frame rate</span></span>
<span id="cb1-2">pygame.time.set_timer(pygame.USEREVENT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> FPS)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In the main loop, process all pending events</span></span>
<span id="cb1-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> event <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pygame.event.get():</span>
<span id="cb1-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> event.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.USEREVENT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb1-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.update()</span>
<span id="cb1-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> event.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.KEYDOWN:</span>
<span id="cb1-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.keydown(event.key)</span>
<span id="cb1-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> event.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.KEYUP:</span>
<span id="cb1-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.keyup(event.key)</span></code></pre></div>
</div>
<p>Instead of constantly checking “is this key pressed?” in a loop, the code waits for pygame to tell it when keys are pressed or released. This means:</p>
<ol type="1">
<li>no missed keypresses, even if they happen very quickly</li>
<li>immediate detection of key events</li>
<li>clear separation between “key is pressed” and “key is released” logic</li>
</ol>
<p>Pretty cool.</p>
</section>
<section id="smooth-flying-with-velocity-controls" class="level3">
<h3 class="anchored" data-anchor-id="smooth-flying-with-velocity-controls">Smooth flying with velocity controls</h3>
<p>Another interesting bit from the example code is how smoothly it makes the drone fly. This is done through velocity-based control (not up, down, left etc. commands).</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize velocity variables</span></span>
<span id="cb2-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.for_back_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forward/backward</span></span>
<span id="cb2-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.left_right_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Left/right</span></span>
<span id="cb2-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up_down_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Up/down</span></span>
<span id="cb2-5"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.yaw_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rotation</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># When UP arrow is pressed</span></span>
<span id="cb2-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> keydown(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, key):</span>
<span id="cb2-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_UP:</span>
<span id="cb2-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.for_back_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set to speed value (60)</span></span>
<span id="cb2-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...other keys...</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># When UP arrow is released</span></span>
<span id="cb2-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> keyup(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, key):</span>
<span id="cb2-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_UP <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_DOWN:</span>
<span id="cb2-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.for_back_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stop movement</span></span>
<span id="cb2-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...other keys...</span></span></code></pre></div>
<p>Instead of sending a “move forward” command when we press UP, it sets a forward velocity that remains until we release the key. This creates a very natural movement, especially when:</p>
<ul>
<li>moving diagonally (pressing UP and RIGHT simultaneously)</li>
<li>transitioning between movements (release UP while still holding RIGHT)</li>
<li>making subtle adjustments to flight path</li>
</ul>
</section>
<section id="the-heartbeat-why-frame-rate-matters" class="level3">
<h3 class="anchored" data-anchor-id="the-heartbeat-why-frame-rate-matters">The Heartbeat: Why frame rate matters</h3>
<p>Something that reminds me of my hardware/telco days: the pygame library work synchronously with fixed time intervals. This line sets the heartbeat:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">pygame.time.set_timer(pygame.USEREVENT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> FPS)</span></code></pre></div>
<p>Basically at each interval it listens for user events and handles them as needed. At 120 FPS, it generates an event every 8.3 milliseconds, triggering e.g.&nbsp;our update function:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb4-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.send_rc_control:</span>
<span id="cb4-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.send_rc_control(</span>
<span id="cb4-4">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.left_right_velocity,</span>
<span id="cb4-5">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.for_back_velocity,</span>
<span id="cb4-6">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up_down_velocity, </span>
<span id="cb4-7">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.yaw_velocity</span>
<span id="cb4-8">        )</span></code></pre></div>
</section>
<section id="why-not-send-commands-immediately" class="level3">
<h3 class="anchored" data-anchor-id="why-not-send-commands-immediately">Why not send commands immediately?</h3>
<p>The naive alternative is to have a <code>while True:</code> loop that reads key strokes and react to that instantly. What’s wrong with that?</p>
<ol type="1">
<li><strong>Command Rate Control</strong>: Drones can get overwhelmed if we send too many commands too quickly</li>
<li><strong>Command Combination</strong>: If we press multiple keys in one frame, they’re combined into a single efficient command</li>
<li><strong>Smooth Motion</strong>: Even, regular command timing creates more natural drone movement</li>
</ol>
<p>I tried the <code>while True</code> approach and it doesn’t work that great. There is no feel between pressing keys and the drone following up on that.</p>
<p>So, I learned something new: <code>pygame</code>, which I’m sure will come in handy soon (spoiler alert: after this I want to use the GameSire controller to fly the Tello. Guess which library is great to speak to gaming consoles!).</p>
</section>
</section>
<section id="video-streaming-snapshots" class="level2">
<h2 class="anchored" data-anchor-id="video-streaming-snapshots">Video streaming &amp; snapshots</h2>
<p>There is no autonomous flying without vision, and now is the first time we can have a peek at streaming video and capturing it.</p>
<p>The same example from above contains the video streaming as well.</p>
<section id="video-streaming" class="level3">
<h3 class="anchored" data-anchor-id="video-streaming">Video streaming</h3>
<section id="setting-up-the-stream" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-the-stream">Setting Up the Stream</h4>
<p>First, the code initializes the video stream:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make sure streaming is off before we start</span></span>
<span id="cb5-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.streamoff()</span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Then turn streaming on</span></span>
<span id="cb5-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.streamon()</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the object that will give us frames</span></span>
<span id="cb5-7">frame_read <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.get_frame_read()</span></code></pre></div>
<p>This pattern of turning streaming off then on again is a good practice to ensure we’re starting with a clean slate. I had it hang a couple of times before applying this trick.</p>
</section>
<section id="capturing-and-processing-frames" class="level4">
<h4 class="anchored" data-anchor-id="capturing-and-processing-frames">Capturing and processing frames</h4>
<p>In the main loop, the code grabs frames from the drone and processes them:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the latest frame</span></span>
<span id="cb6-2">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> frame_read.frame</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add battery information to the frame</span></span>
<span id="cb6-5">text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Battery: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.get_battery())</span>
<span id="cb6-6">cv2.putText(frame, text, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">720</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb6-7">    cv2.FONT_HERSHEY_SIMPLEX, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<p>This overlays the battery percentage in red text at the bottom left of the frame. A handy feature when we’re flying!</p>
</section>
<section id="frame-transformation" class="level4">
<h4 class="anchored" data-anchor-id="frame-transformation">Frame transformation</h4>
<p>The next three lines are needed for displaying the frame correctly in pygame:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenCV uses BGR, pygame needs RGB</span></span>
<span id="cb7-2">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rotate the frame 90 degrees</span></span>
<span id="cb7-5">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.rot90(frame)</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flip the frame upside down</span></span>
<span id="cb7-8">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.flipud(frame)</span></code></pre></div>
<p>Why all this transformation? Cameras often capture images in orientations or color formats that aren’t immediately displayable. OpenCV uses BGR color format while pygame expects RGB, and the Tello camera orientation needs adjusting to appear correctly on screen.</p>
</section>
<section id="displaying-in-pygame" class="level4">
<h4 class="anchored" data-anchor-id="displaying-in-pygame">Displaying in pygame</h4>
<p>Finally, the frame is displayed in the pygame window:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert numpy array to a pygame surface</span></span>
<span id="cb8-2">frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pygame.surfarray.make_surface(frame)</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw the surface to the screen</span></span>
<span id="cb8-5"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.screen.blit(frame, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the display</span></span>
<span id="cb8-8">pygame.display.update()</span></code></pre></div>
<p>This process happens every frame (120 times per second with the default settings), creating a smooth video feed.</p>
</section>
</section>
<section id="video-snapshots" class="level3">
<h3 class="anchored" data-anchor-id="video-snapshots">Video snapshots</h3>
<p>Not included in the example code is the ability to take a snapshot by pressing a key and saving the current frame to disk.</p>
<p>So let’s add it:</p>
<section id="first-add-the-necessary-import" class="level4">
<h4 class="anchored" data-anchor-id="first-add-the-necessary-import">1. First, add the necessary import</h4>
<p>At the top of the file, make sure we have:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span></code></pre></div>
</section>
<section id="create-a-directory-to-store-images" class="level4">
<h4 class="anchored" data-anchor-id="create-a-directory-to-store-images">2. Create a directory to store images</h4>
<p>Add this near the beginning of our <code>__init__</code> method:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a directory to store images if it doesn't exist</span></span>
<span id="cb10-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> os.path.exists(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tello_images'</span>):</span>
<span id="cb10-3">    os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tello_images'</span>)</span></code></pre></div>
</section>
<section id="add-a-key-handler-for-taking-snapshots" class="level4">
<h4 class="anchored" data-anchor-id="add-a-key-handler-for-taking-snapshots">3. Add a key handler for taking snapshots</h4>
<p>In the <code>keyup</code> method, add a case for a new key (I’ll use ‘p’ for “picture”):</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> keyup(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, key):</span>
<span id="cb11-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Update velocities based on key released """</span></span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_UP <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_DOWN:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set zero forward/backward velocity</span></span>
<span id="cb11-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.for_back_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_LEFT <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_RIGHT:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set zero left/right velocity</span></span>
<span id="cb11-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.left_right_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_w <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_s:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set zero up/down velocity</span></span>
<span id="cb11-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up_down_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_d:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set zero yaw velocity</span></span>
<span id="cb11-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.yaw_velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_t:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># takeoff</span></span>
<span id="cb11-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.takeoff()</span>
<span id="cb11-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.send_rc_control <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb11-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_l:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># land</span></span>
<span id="cb11-15">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.land()</span>
<span id="cb11-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.send_rc_control <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb11-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pygame.K_p:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take a snapshot</span></span>
<span id="cb11-18">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.take_snapshot()</span></code></pre></div>
</section>
<section id="add-the-snapshot-method" class="level4">
<h4 class="anchored" data-anchor-id="add-the-snapshot-method">4. Add the snapshot method</h4>
<p>Add this new method to our <code>FrontEnd</code> class:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> take_snapshot(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb12-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Take a snapshot of the current frame and save it to disk</span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb12-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the current frame</span></span>
<span id="cb12-6">    frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tello.get_frame_read().frame</span>
<span id="cb12-7">    </span>
<span id="cb12-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb12-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a filename with timestamp</span></span>
<span id="cb12-10">        timestamp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y%m</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-%H%M%S"</span>)</span>
<span id="cb12-11">        filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"tello_images/tello_snapshot_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>timestamp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpg"</span></span>
<span id="cb12-12">        </span>
<span id="cb12-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the image - note we save the original frame before any transformations</span></span>
<span id="cb12-14">        cv2.imwrite(filename, frame)</span>
<span id="cb12-15">        </span>
<span id="cb12-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Snapshot saved: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>filename<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<p>The resulting code can be found <a href="https://github.com/pors/tello-play/blob/main/manual-control-pygame.py">here</a>.</p>
</section>
</section>
<section id="lets-try-it-out" class="level3">
<h3 class="anchored" data-anchor-id="lets-try-it-out">Let’s try it out!</h3>
<p>It all works just fine, here are some low res snapshots I made:</p>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142617.967533.jpg" class="img-fluid" width="250"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142635.818627.jpg" class="img-fluid" width="250"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142638.978236.jpg" class="img-fluid" width="250"></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142643.129198.jpg" class="img-fluid" width="250"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142653.1736279.jpg" class="img-fluid" width="250"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots/image-1745142683.295296.jpg" class="img-fluid" width="250"></p>
</div>
</div>
</div>
<p>Navigating with a keyboard is a disaster, so….</p>
</section>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>To improve navigation we are going to hook up the GameSir T1d, <a href="../../posts/gamesir-t1d-controller/">read on..</a>.</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/crash-the-tello/">← Previous: Crash the Tello</a>
</div>
<div>
<a href="../../posts/gamesir-t1d-controller/">Next: GameSir T1d &amp; pygame →</a>
</div>
</div>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>pygame</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/key-navigation-video-snapshots/</guid>
  <pubDate>Sat, 26 Apr 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/key-navigation-video-snapshots/snapshots.png" medium="image" type="image/png" height="91" width="144"/>
</item>
<item>
  <title>Interlude: I’m a Pilot!</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/i-am-a-pilot/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-04-25</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Passed the EASA A1/A3 pilot exam, officially becoming a UAV (drone) pilot—childhood dream “fulfilled.”</li>
<li>Created a web-based EASA exam practice app to prep for the test, available online for free.</li>
<li>Shared app’s source code on GitHub for community use.</li>
</ul>
</div>
</div>
</div>
<section id="fulfilling-a-dream" class="level2">
<h2 class="anchored" data-anchor-id="fulfilling-a-dream">Fulfilling a dream</h2>
<p>As a kid I always wanted to be a pilot (not true, it just makes for a more interesting story), and now I just passed the EASA A1/A3 pilot exam!</p>
<p>Yeah, I know, this is a certification for UAV’s. UAV stands for Unmanned Aerial Vehicle, where you as a pilot stay on the ground. We can’t have it all.</p>
<p>I will need this certification to fly drones outdoors, even the tiny Tello requires the ground-bound pilot to have the authorization to fly drones.</p>
</section>
<section id="easa-a1a3-exam-practice-app" class="level2">
<h2 class="anchored" data-anchor-id="easa-a1a3-exam-practice-app">EASA A1/A3 Exam Practice App</h2>
<p>Anyway, to help me study, I (Claude.ai) created a practice app to go over all possible questions for the exam. I thought it might be handy for others so I put it up online here: <a href="https://dronelab.dev/easa-exam/">EASA A1/A3 exam test app</a>. The source code is <a href="https://github.com/pors/EASA-exam-practice">here</a>.</p>
<p><small>Beware: the source PDF with questions was used as the basis for the app, and the LLM made some mistakes. I think I have corrected most/all of them, but if you want to be sure please double check.</small></p>


</section>

 ]]></description>
  <category>drone</category>
  <category>open-source</category>
  <guid>https://dronelab.dev/posts/i-am-a-pilot/</guid>
  <pubDate>Thu, 24 Apr 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/i-am-a-pilot/pilot.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Crash the Tello (with and without code)</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/crash-the-tello/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-04-24</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Unboxed and crashed a DJI Tello drone — first due to a buggy phone app, then because of the infamous “ceiling effect.”</li>
<li>Recommend using TelloFPV app and GameSir T1d controller for smoother manual flight experiences.</li>
<li>Explained basic drone movements clearly (throttle, yaw, pitch, roll).</li>
<li>Introduced DJI’s Python SDK for coding drone flight, setting the stage for further explorations with code.</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/enter-the-tello/">← Previous: Enter the Tello</a>
</div>
<div>
<a href="../../posts/key-navigation-video-snapshots/">Next: Key navigation &amp; Video snapshots →</a>
</div>
</div>
</div>
</div>
</div>
<section id="unboxed" class="level2">
<h2 class="anchored" data-anchor-id="unboxed">Unboxed</h2>
<p>Now that the drone is out of the box, we’re gonna take it for a spin (and yes it crashed). First with the phone app, then with code.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/crash-the-tello/crashed-TT.png" class="img-fluid figure-img"></p>
<figcaption>Crashed RoboMaster TT (generated by ChatGPT)</figcaption>
</figure>
</div>
<p><br></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>These blog posts are intended to be read in order. If you want to follow along on my journey, start here: <a href="../../posts/enter-the-tello/">Enter the Tello</a>. Or ignore this and keep on reading below.</p>
</div>
</div>
</section>
<section id="first-tt-flight" class="level2">
<h2 class="anchored" data-anchor-id="first-tt-flight">First TT flight</h2>
<p>To fly a drone for the first time it is good to have a basic understanding how these quadcopters work, and what the basic movements are:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 79%">
</colgroup>
<thead>
<tr class="header">
<th>Movement</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>throttle</td>
<td>increases or decreases the height of the drone by adjusting all propellers equally</td>
</tr>
<tr class="even">
<td>yaw</td>
<td>turns the drone clockwise or counterclockwise by varying propeller speeds</td>
</tr>
<tr class="odd">
<td>pitch</td>
<td>moves the drone forward or backward by changing speeds between front and back propellers</td>
</tr>
<tr class="even">
<td>roll</td>
<td>moves the drone left or right by varying left and right propeller speeds</td>
</tr>
</tbody>
</table>
<p><br> This video explains very clearly how it works: </p><div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/C0KBu2ihp-s" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p></p>
<p>The Tello doesn’t come with a controller, we fly it through the Tello app. I used the Tello app for iPhone. This app hasn’t been updated for a long time and unfortunately it is useless as it crashes all the time. When the app crashes the drone keeps on hovering in the air, so this first crash is just a software crash.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to fly the TT or Tello manually I recommend you get the <a href="https://apps.apple.com/us/app/tellofpv/id1545864950">TelloFPV</a>. It’s not free, but doesn’t crash either.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To really enjoy flying the TT manually you can get a controller that is customized for the Tello: the <a href="https://gamesir.com/pages/tello-tutorial">GameSir T1d</a>. I got one, and it works straight out of the box — even with the TelloFPV app.</p>
</div>
</div>
<section id="beware-of-the-ceiling-effect" class="level3">
<h3 class="anchored" data-anchor-id="beware-of-the-ceiling-effect">Beware of the ceiling effect</h3>
<p>While flying the drone around a bit in my office, I went up a bit too high and the drone crashed when it came near the ceiling. This phenomenon even has a name and is called the “ceiling effect.” Basically, the drone gets <a href="https://aviation.stackexchange.com/questions/59128/what-disadvantages-does-flying-a-drone-close-under-a-ceiling-have">sucked up to the ceiling</a> because there is not enough air to push down through the propellers.</p>
<p>Alright, now for the real fun — controlling the drone with code.</p>
</section>
</section>
<section id="the-tello-python-sdk" class="level2">
<h2 class="anchored" data-anchor-id="the-tello-python-sdk">The Tello Python SDK</h2>
<p>DJI provides an SDK for the Tello drone that can be used with Python. The SDK can be used to control the drone through its API. The API is fairly basic but supports:</p>
<ul>
<li>Flight control with takeoff, landing and movement commands</li>
<li>Flight status information (battery level, height, acceleration, speed)</li>
<li>Stream camera feed</li>
</ul>
<p>The Python library we will be using for this SDK is <a href="https://github.com/damiafuentes/DJITelloPy">DJITelloPy</a>.</p>
<p>A couple of useful resources:</p>
<ul>
<li><a href="https://dl.djicdn.com/downloads/RoboMaster+TT/Tello_SDK_3.0_User_Guide_en.pdf">SDK 3.0 user guide</a> (includes the API spec).</li>
<li><a href="https://robomaster-dev.readthedocs.io/en/latest/">RoboMaster Developer Guide</a> (also for RoboMasters on wheels).</li>
<li><a href="https://github.com/dji-sdk/RoboMaster-SDK">RoboMaster SDK</a> (as provided by DJI).</li>
<li><a href="https://djitellopy.readthedocs.io/en/latest/tello/">DJITelloPy API Reference</a>.</li>
</ul>
<p>To give it a try, let’s first install djitellopy:</p>
<div id="setup" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>{sys.executable} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>m pip install djitellopy</span></code></pre></div>
</div>
<section id="take-off-fly-land" class="level3">
<h3 class="anchored" data-anchor-id="take-off-fly-land">Take-off, fly, land</h3>
<p>Let’s start with a simple script to take-off, fly, and land the drone.</p>
<p>To make this work the computer running the script needs to be connected to the Wifi Access Point the Tello provides. The SSID is of the form <code>TELLO-XXXXXX</code>.</p>
<div id="1765d13e" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> djitellopy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tello</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sleep</span>
<span id="cb2-3"></span>
<span id="cb2-4">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tello.Tello()</span>
<span id="cb2-5">t.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>()</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Bat: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_battery()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Temp: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_temperature()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10">t.takeoff()</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Send RC control via four channels. Command is sent every self.TIME_BTW_RC_CONTROL_COMMANDS seconds.</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Arguments:</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    left_right_velocity: -100~100 (left/right)</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    forward_backward_velocity: -100~100 (forward/backward)</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    up_down_velocity: -100~100 (up/down)</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    yaw_velocity: -100~100 (yaw)</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-19">t.send_rc_control(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-20">sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-21">t.send_rc_control(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-22">sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-23">t.send_rc_control(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># don't forget this!</span></span>
<span id="cb2-24"></span>
<span id="cb2-25">t.land()</span>
<span id="cb2-26">t.end()</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre class="text"><code>[INFO] tello.py - 129 - Tello instance was initialized. Host: '192.168.1.85'. Port: '8889'.
[INFO] tello.py - 438 - Send command: 'command'
[INFO] tello.py - 462 - Response command: 'ok'
Bat: 100
Temp: 45.0
[INFO] tello.py - 438 - Send command: 'takeoff'
[INFO] tello.py - 462 - Response takeoff: 'ok'
[INFO] tello.py - 471 - Send command (no response expected): 'rc 0 50 0 0'
[INFO] tello.py - 471 - Send command (no response expected): 'rc 30 0 0 0'
[INFO] tello.py - 471 - Send command (no response expected): 'rc 0 0 0 0'
[INFO] tello.py - 438 - Send command: 'land'
[INFO] tello.py - 462 - Response land: 'ok'</code></pre>
</div>
<p>It is pretty straightforward. My first attempt made the drone crash though: not having the <code>t.send_rc_control(0, 0, 0, 0)</code> command there tells the drone to move sideways (to the right) while landing, with the expected result.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The code above was executed in my code editor and the output you see there is the actual output. Similar to a frozen Jupyter notebook. This is possible because this blog is powered by <a href="https://quarto.org">Quarto</a>. If you haven’t tried Quarto, maybe check it out.</p>
</div>
</div>
</section>
<section id="using-router-mode" class="level3">
<h3 class="anchored" data-anchor-id="using-router-mode">Using router mode</h3>
<p>It is quite annoying that the computer you are working on is not connected to the Internet while testing the code (it is connected to the wifi of the drone). Every five seconds I MUST check with Claude/ChatGPT if I am doing things right, no?</p>
<p>For the original Tello there is nothing we can do about that, but the RoboMaster TT has two <a href="https://robomaster-dev.readthedocs.io/en/latest/third_part_comm.html#wi-fi-connection">wifi connection modes</a>:</p>
<ul>
<li>Direct connection mode (aka AP mode): this is what we did so far, the Tello provides an access point and the computer connects to that.</li>
<li>Router mode (aka STA mode): both the TT and the computer connect to the same wifi router, so we are still online if that router is our home router.</li>
</ul>
<p>The TT has an expansion kit that contains a small microprocessor that provides wifi and Bluetooth connectivity: <a href="https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_en.pdf">ESP32-D2WD</a>. We will have a look later to see what we can do with it, for now we just use the wifi in router mode. There is a tiny switch on the expansion unit that we can toggle between the two modes. It does involve a couple of other steps though, which are outlined here: <a href="https://robomaster-dev.readthedocs.io/en/latest/text_sdk/connection.html#connection-examples">Connection examples</a>. It didn’t work for me (there is no QR code I can get from the Tello app), so I will show you what I did:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before continuing, the controller needs to be activated from the Tello app! This happens after the firmware update of this controller. This cost me a couple of days of my life, so next time I’ll RTFM.</p>
</div>
</div>
<section id="step-1." class="level4">
<h4 class="anchored" data-anchor-id="step-1.">Step 1.</h4>
<p>Set the switch to AP mode first (down).</p>
</section>
<section id="step-2." class="level4">
<h4 class="anchored" data-anchor-id="step-2.">Step 2.</h4>
<p>Connect the PC to the RMTT-xxx network. We are now in direct connection mode, provided by the Wifi on the expansion kit.</p>
</section>
<section id="step-4" class="level4">
<h4 class="anchored" data-anchor-id="step-4">Step 4:</h4>
<p>Run this script:</p>
<div id="0c6affc6" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> socket</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> getpass</span>
<span id="cb4-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Environment variables for Wi-Fi credentials just to make it run in a notebook</span></span>
<span id="cb4-7">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WIFI_SSID"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MyNetwork"</span></span>
<span id="cb4-8">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WIFI_PASSWORD"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SuperSecret"</span></span>
<span id="cb4-9"></span>
<span id="cb4-10">sock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span>
<span id="cb4-11">sock.settimeout(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb4-12"></span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_wifi_credentials():</span>
<span id="cb4-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-16">        ssid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Wi-Fi SSID: "</span>)</span>
<span id="cb4-17">        password <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getpass.getpass(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Wi-Fi Password: "</span>)</span>
<span id="cb4-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> (<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">EOFError</span>, getpass.GetPassWarning, <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>):</span>
<span id="cb4-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fall back to environment variables</span></span>
<span id="cb4-20">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Interactive input not available. Falling back to environment variables."</span>)</span>
<span id="cb4-21">        ssid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WIFI_SSID"</span>)</span>
<span id="cb4-22">        password <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WIFI_PASSWORD"</span>)</span>
<span id="cb4-23"></span>
<span id="cb4-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> ssid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> password:</span>
<span id="cb4-25">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">RuntimeError</span>(</span>
<span id="cb4-26">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing WIFI_SSID or WIFI_PASSWORD environment variable."</span></span>
<span id="cb4-27">            )</span>
<span id="cb4-28"></span>
<span id="cb4-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ssid, password</span>
<span id="cb4-30"></span>
<span id="cb4-31"></span>
<span id="cb4-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 1: Enter SDK mode</span></span>
<span id="cb4-33">sock.sendto(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">b"command"</span>, (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"192.168.10.1"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8889</span>))</span>
<span id="cb4-34"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-35">    response, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sock.recvfrom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>)</span>
<span id="cb4-36">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response 1:"</span>, response)</span>
<span id="cb4-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No response to command:"</span>, e)</span>
<span id="cb4-39"></span>
<span id="cb4-40">time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-41"></span>
<span id="cb4-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 2: Send ap command</span></span>
<span id="cb4-43">ssid, password <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_wifi_credentials()</span>
<span id="cb4-44">sock.sendto(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">b"ap %s %s"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (ssid.encode(), password.encode()), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"192.168.10.1"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8889</span>))</span>
<span id="cb4-45"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-46">    response, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sock.recvfrom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>)</span>
<span id="cb4-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response 2:"</span>, response)</span>
<span id="cb4-48"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No response to ap:"</span>, e)</span></code></pre></div>
</div>
</section>
<section id="step-5" class="level4">
<h4 class="anchored" data-anchor-id="step-5">Step 5:</h4>
<p>Toggle the switch to STA mode (up).</p>
</section>
<section id="step-6" class="level4">
<h4 class="anchored" data-anchor-id="step-6">Step 6:</h4>
<p>Connect the PC to the wifi network you provided in the script above.</p>
</section>
<section id="step-7" class="level4">
<h4 class="anchored" data-anchor-id="step-7">Step 7:</h4>
<p>Find the IP address that was assigned to the TT (e.g.&nbsp;in your home router admin settings).</p>
</section>
<section id="step-8" class="level4">
<h4 class="anchored" data-anchor-id="step-8">Step 8:</h4>
<p>Use this IP address every time you connect to the Tello in your code:</p>
<div id="c6d45296" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tello.Tello(host<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"192.168.1.85"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the IP address from step 7</span></span>
<span id="cb5-2"></span>
<span id="cb5-3">t.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>()</span></code></pre></div>
</div>
<p>From here on we can connect to the TT and also be connected to the Internet. Yay!</p>
</section>
</section>
<section id="thanks" class="level3">
<h3 class="anchored" data-anchor-id="thanks">Thanks!</h3>
<p>I want to thank <a href="https://github.com/murtazahassan">Murtaza Hassan</a> for getting me started through this video: <a href="https://www.youtube.com/watch?v=LmEcyQnfpDA">Drone Programming With Python Course</a>.</p>
<hr>
</section>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next</h2>
<p>In the next episode I’m going to implement keyboard control and stream video frames to the PC and save them on disk on demand (“inspired” by Murtaza <sup>1</sup>).</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>
<a href="../../posts/enter-the-tello/">← Previous: Enter the Tello</a>
</div>
<div>
<a href="../../posts/key-navigation-video-snapshots/">Next: Key navigation &amp; Video snapshots →</a>
</div>
</div>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Borrowed is the real word here. No: stolen!↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>drone</category>
  <category>code</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/crash-the-tello/</guid>
  <pubDate>Wed, 23 Apr 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/crash-the-tello/crashed-TT2.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Enter the Tello</title>
  <dc:creator>Mark Pors</dc:creator>
  <link>https://dronelab.dev/posts/enter-the-tello/</link>
  <description><![CDATA[ 

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-04-20</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TL;DR
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Combined interests in hiking, coding, and new tech led to a drone project idea</li>
<li>Goal: build an autonomous scouting drone for hiking adventures</li>
<li>Started with no drone or computer vision experience</li>
<li>Resisted the urge to over-invest at first (just bought the domain dronelab.dev)</li>
<li>Chose the DJI RoboMaster TT as a beginner-friendly, programmable drone</li>
<li>Next steps: experiment with the RoboMaster TT, both manually and with code</li>
</ul>
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>

</div>
<div>
<a href="../../posts/crash-the-tello/">Next: Crash the Tello →</a>
</div>
</div>
</div>
</div>
</div>
<section id="combine-the-stuff-you-like" class="level2">
<h2 class="anchored" data-anchor-id="combine-the-stuff-you-like">Combine the stuff you like</h2>
<p>“Combine the stuff you like” is good advice when looking for a new project to work on. I like to follow good advice and so I brainstormed a bit with ChatGPT to find interesting intersections between my interests. Some of my favorite activities — like sex, meditation, and reading — didn’t quite lend themselves to computer vision projects. Others had more potential: hiking in nature, coding, learning about new tech.</p>
</section>
<section id="autonomous-scouting-drone" class="level2">
<h2 class="anchored" data-anchor-id="autonomous-scouting-drone">Autonomous scouting drone</h2>
<p>Having a drone accompany us on hikes to do some scouting ahead hits the mark for me. It includes hiking and coding, and most important: I need to learn a lot to make a drone do what I want. I have zero experience with drones and very limited experience with computer vision models.</p>
</section>
<section id="getting-ready-big-time" class="level2">
<h2 class="anchored" data-anchor-id="getting-ready-big-time">Getting ready big time</h2>
<p>Like any self-respecting tech nerd, I decided to kick things off in style:</p>
<ol type="1">
<li>Buy a domain name (most important!)</li>
<li>Get a logo (as important!)</li>
<li>Buy the best dev/DIY drone out there</li>
<li>Buy a top line PC to train models</li>
<li>Buy another PC to run simulation environments</li>
</ol>
<p>OK, guilty — I bought the domain (hello <a href="../..">dronelab.dev</a>), but <em>tried</em> to stop myself there <sup>1</sup> <sup>2</sup>. I don’t know anything about drones, and might get bored with the project after a couple of weeks, so better start small.</p>
</section>
<section id="enter-the-tello" class="level2">
<h2 class="anchored" data-anchor-id="enter-the-tello">Enter the Tello</h2>
<p>I stumbled upon a modest little drone from way back in 2018 <sup>3</sup> — the DJI Tello — and it was perfect for my first steps. It can fly indoors, is programmable and has a camera.</p>
<p>There is an even better version of it with some extra goodies that might come in handy:</p>
<ul>
<li>an onboard processor</li>
<li>a matrix display</li>
<li>a distance sensor</li>
</ul>
<p>So I bought the DJI RoboMaster TT. TT stands for Tello Talent — basically smart kids coding drones at an age I was still figuring out crayons.</p>
<p>Look at that beauty!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dronelab.dev/posts/enter-the-tello/tt.jpg" class="img-fluid figure-img"></p>
<figcaption>DJI RoboMaster TT</figcaption>
</figure>
</div>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>In the next episode I will play with the RoboMaster TT, both with and without code to control it. It includes different ways to crash it. <a href="../../posts/crash-the-tello">Read on…</a></p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div style="text-align: center;">
<p><strong>Series: <a href="../../series/">Code, Fly &amp; AI</a></strong></p>
</div>
<div style="display: flex; justify-content: space-between; margin-top: 0.5em;">
<div>

</div>
<div>
<a href="../../posts/crash-the-tello/">Next: Crash the Tello →</a>
</div>
</div>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I always buy the domain first, even before I know what I’m doing.↩︎</p></li>
<li id="fn2"><p>I didn’t really stop myself there, I also created a logo. Technically ChatGPT did: <img src="https://dronelab.dev/posts/enter-the-tello/logo_high.png" class="img-fluid" alt="dronelab">↩︎</p></li>
<li id="fn3"><p>2018, also the last time I blogged something: <a href="https://decentralized.blog/">decentralized.blog</a>.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>drone</category>
  <category>tello</category>
  <guid>https://dronelab.dev/posts/enter-the-tello/</guid>
  <pubDate>Sat, 19 Apr 2025 21:00:00 GMT</pubDate>
  <media:content url="https://dronelab.dev/posts/enter-the-tello/tt.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
