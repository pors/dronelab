<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Pors">
<meta name="dcterms.date" content="2025-06-11">
<meta name="keywords" content="mnist dataset, pixel representation, broadcasting in pytorch, stochastic gradient descent, digit classification, neural network basics, pytorch tutorial, fastai walkthrough, tensor operations, linear models, relu activation, sigmoid function, mini-batch training">
<meta name="description" content="A hands-on exploration of neural network training fundamentals using the MNIST dataset, covering pixel representation, broadcasting, gradient descent, and building basic digit classifiers with PyTorch.">

<title>MNIST basics - Training a Digit Classifier – dronelab.dev</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a368816def9a8950b8d88926fee9d1b8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-J790G06FED"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J790G06FED', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="MNIST basics - Training a Digit Classifier">
<meta property="og:description" content="A hands-on exploration of neural network training fundamentals using the MNIST dataset, covering pixel representation, broadcasting, gradient descent, and building basic digit classifiers with PyTorch.">
<meta property="og:image" content="https://dronelab.dev/posts/mnist-basics/MNIST.png">
<meta property="og:site_name" content="dronelab.dev">
<meta property="og:image:alt" content="DroneLab - Coding Autonomous Drones in Baby Steps.">
<meta property="og:image:height" content="628">
<meta property="og:image:width" content="1200">
<meta name="twitter:title" content="MNIST basics - Training a Digit Classifier">
<meta name="twitter:description" content="A hands-on exploration of neural network training fundamentals using the MNIST dataset, covering pixel representation, broadcasting, gradient descent, and building basic digit classifiers with PyTorch.">
<meta name="twitter:image" content="https://dronelab.dev/posts/mnist-basics/MNIST.png">
<meta name="twitter:image:alt" content="MNIST basics - Training a Digit Classifier">
<meta name="twitter:creator" content="@pors">
<meta name="twitter:site" content="@pors">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="628">
<meta name="twitter:image-width" content="1200">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">dronelab.dev</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pors"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/pors"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#under-the-hood-training-a-digit-classifier" id="toc-under-the-hood-training-a-digit-classifier" class="nav-link active" data-scroll-target="#under-the-hood-training-a-digit-classifier">Under the Hood: Training a Digit Classifier</a>
  <ul>
  <li><a href="#pixels-the-foundations-of-computer-vision" id="toc-pixels-the-foundations-of-computer-vision" class="nav-link" data-scroll-target="#pixels-the-foundations-of-computer-vision">Pixels: The Foundations of Computer Vision</a></li>
  <li><a href="#first-try-pixel-similarity" id="toc-first-try-pixel-similarity" class="nav-link" data-scroll-target="#first-try-pixel-similarity">First Try: Pixel Similarity</a></li>
  <li><a href="#computing-metrics-using-broadcasting" id="toc-computing-metrics-using-broadcasting" class="nav-link" data-scroll-target="#computing-metrics-using-broadcasting">Computing Metrics Using Broadcasting</a></li>
  <li><a href="#stochastic-gradient-descent-sgd" id="toc-stochastic-gradient-descent-sgd" class="nav-link" data-scroll-target="#stochastic-gradient-descent-sgd">Stochastic Gradient Descent (SGD)</a>
  <ul class="collapse">
  <li><a href="#calculating-gradients" id="toc-calculating-gradients" class="nav-link" data-scroll-target="#calculating-gradients">Calculating Gradients</a></li>
  <li><a href="#stepping-with-a-learning-rate" id="toc-stepping-with-a-learning-rate" class="nav-link" data-scroll-target="#stepping-with-a-learning-rate">Stepping With a Learning Rate</a></li>
  <li><a href="#an-end-to-end-sgd-example" id="toc-an-end-to-end-sgd-example" class="nav-link" data-scroll-target="#an-end-to-end-sgd-example">An End-to-End SGD Example</a>
  <ul class="collapse">
  <li><a href="#step-1-initialize-the-parameters" id="toc-step-1-initialize-the-parameters" class="nav-link" data-scroll-target="#step-1-initialize-the-parameters">Step 1: Initialize the parameters</a></li>
  <li><a href="#step-2-calculate-the-predictions" id="toc-step-2-calculate-the-predictions" class="nav-link" data-scroll-target="#step-2-calculate-the-predictions">Step 2: Calculate the predictions</a></li>
  <li><a href="#step-3-calculate-the-loss" id="toc-step-3-calculate-the-loss" class="nav-link" data-scroll-target="#step-3-calculate-the-loss">Step 3: Calculate the loss</a></li>
  <li><a href="#step-4-calculate-the-gradients" id="toc-step-4-calculate-the-gradients" class="nav-link" data-scroll-target="#step-4-calculate-the-gradients">Step 4: Calculate the gradients</a></li>
  <li><a href="#step-5-step-the-weights." id="toc-step-5-step-the-weights." class="nav-link" data-scroll-target="#step-5-step-the-weights.">Step 5: Step the weights.</a></li>
  <li><a href="#step-6-repeat-the-process" id="toc-step-6-repeat-the-process" class="nav-link" data-scroll-target="#step-6-repeat-the-process">Step 6: Repeat the process</a></li>
  <li><a href="#step-7-stop" id="toc-step-7-stop" class="nav-link" data-scroll-target="#step-7-stop">Step 7: stop</a></li>
  </ul></li>
  <li><a href="#summarizing-gradient-descent" id="toc-summarizing-gradient-descent" class="nav-link" data-scroll-target="#summarizing-gradient-descent">Summarizing Gradient Descent</a></li>
  </ul></li>
  <li><a href="#the-mnist-loss-function" id="toc-the-mnist-loss-function" class="nav-link" data-scroll-target="#the-mnist-loss-function">The MNIST Loss Function</a>
  <ul class="collapse">
  <li><a href="#sigmoid" id="toc-sigmoid" class="nav-link" data-scroll-target="#sigmoid">Sigmoid</a></li>
  <li><a href="#sgd-and-mini-batches" id="toc-sgd-and-mini-batches" class="nav-link" data-scroll-target="#sgd-and-mini-batches">SGD and Mini-Batches</a></li>
  </ul></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together">Putting It All Together</a>
  <ul class="collapse">
  <li><a href="#creating-an-optimizer" id="toc-creating-an-optimizer" class="nav-link" data-scroll-target="#creating-an-optimizer">Creating an Optimizer</a></li>
  </ul></li>
  <li><a href="#adding-a-nonlinearity" id="toc-adding-a-nonlinearity" class="nav-link" data-scroll-target="#adding-a-nonlinearity">Adding a Nonlinearity</a>
  <ul class="collapse">
  <li><a href="#going-deeper" id="toc-going-deeper" class="nav-link" data-scroll-target="#going-deeper">Going Deeper</a></li>
  </ul></li>
  <li><a href="#jargon-recap" id="toc-jargon-recap" class="nav-link" data-scroll-target="#jargon-recap">Jargon Recap</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"><h1 class="title display-7">MNIST basics - Training a Digit Classifier</h1></header>

<header id="title-block-header">

<p class="author">Mark Pors</p>

<p class="date">2025-06-11</p>
</header>


<p><a href="https://colab.research.google.com/github/pors/dronelab/blob/main/posts/mnist-basics/index.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="under-the-hood-training-a-digit-classifier" class="level1">
<h1>Under the Hood: Training a Digit Classifier</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook is a copy of chapter four of the fastai book <a href="https://github.com/fastai/fastbook/blob/master/04_mnist_basics.ipynb" target="_blank">Under the Hood: Training a Digit Classifier</a>.</p>
<p>I added and removed code and markdown here and there reflecting my own understanding of the topic. Not very interesting (aka boring) for 99+% of you, it is mostly for my own reference. My approach here is to work through the original notebook, and if I don’t understand something fully, I dive into it a bit. My comments are marked with <mark>&lt;mark&gt;…&lt;/mark&gt;</mark>.</p>
<p>For drone related stuff, see the <a href="../../series/index.html">Code, Fly &amp; AI Series</a>.</p>
</div>
</div>
<section id="pixels-the-foundations-of-computer-vision" class="level2">
<h2 class="anchored" data-anchor-id="pixels-the-foundations-of-computer-vision">Pixels: The Foundations of Computer Vision</h2>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>matplotlib.rc(<span class="st">'image'</span>, cmap<span class="op">=</span><span class="st">'Greys'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For this initial tutorial we are just going to try to create a model that can classify any image as a 3 or a 7. So let’s download a sample of MNIST that contains images of just these digits:</p>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:37}}" data-outputid="e2dd7b78-1d09-4a96-9e88-c8348bc30d03" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.MNIST_SAMPLE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="3219456" class="" max="3214948" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.14% [3219456/3214948 00:01&lt;00:00]
    </div>
    
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hide</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Path.BASE_PATH <span class="op">=</span> path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="c5393658-2cbc-4761-9c5a-ececeb92fbad" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(path<span class="op">/</span><span class="st">'train'</span>).ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(#2) [Path('train/7'),Path('train/3')]</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="3360ee2f-5d66-4a64-83a3-0d273c4ddfb7" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>threes <span class="op">=</span> (path<span class="op">/</span><span class="st">'train'</span><span class="op">/</span><span class="st">'3'</span>).ls().<span class="bu">sorted</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sevens <span class="op">=</span> (path<span class="op">/</span><span class="st">'train'</span><span class="op">/</span><span class="st">'7'</span>).ls().<span class="bu">sorted</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>threes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(#6131) [Path('train/3/10.png'),Path('train/3/10000.png'),Path('train/3/10011.png'),Path('train/3/10031.png'),Path('train/3/10034.png'),Path('train/3/10042.png'),Path('train/3/10052.png'),Path('train/3/1007.png'),Path('train/3/10074.png'),Path('train/3/10091.png')...]</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-outputid="ee69753f-b303-4c2a-d067-a51805d5ed47" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>im3_path <span class="op">=</span> threes[<span class="dv">1</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>im3 <span class="op">=</span> Image.<span class="bu">open</span>(im3_path)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>im3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-12" class="cell" data-outputid="598cf5d9-9ab8-4ca4-8252-450731e04186">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>array(im3)[<span class="dv">4</span>:<span class="dv">10</span>,<span class="dv">4</span>:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[  0,   0,   0,   0,   0,   0],
       [  0,   0,   0,   0,   0,  29],
       [  0,   0,   0,  48, 166, 224],
       [  0,  93, 244, 249, 253, 187],
       [  0, 107, 253, 253, 230,  48],
       [  0,   3,  20,  20,  15,   0]], dtype=uint8)</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-outputid="6de93db1-c035-4392-a4ec-9a94d23f18c6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tensor(im3)[<span class="dv">4</span>:<span class="dv">10</span>,<span class="dv">4</span>:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[  0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,  29],
        [  0,   0,   0,  48, 166, 224],
        [  0,  93, 244, 249, 253, 187],
        [  0, 107, 253, 253, 230,  48],
        [  0,   3,  20,  20,  15,   0]], dtype=torch.uint8)</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-outputid="122b00d5-51a5-4365-8ae8-2d559780b693" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>im3_t <span class="op">=</span> tensor(im3)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(im3_t[<span class="dv">4</span>:<span class="dv">15</span>,<span class="dv">4</span>:<span class="dv">22</span>])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>df.style.set_properties(<span class="op">**</span>{<span class="st">'font-size'</span>:<span class="st">'6pt'</span>}).background_gradient(<span class="st">'Greys'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<style type="text/css">
#T_1743a_row0_col0, #T_1743a_row0_col1, #T_1743a_row0_col2, #T_1743a_row0_col3, #T_1743a_row0_col4, #T_1743a_row0_col5, #T_1743a_row0_col6, #T_1743a_row0_col7, #T_1743a_row0_col8, #T_1743a_row0_col9, #T_1743a_row0_col10, #T_1743a_row0_col11, #T_1743a_row0_col12, #T_1743a_row0_col13, #T_1743a_row0_col14, #T_1743a_row0_col15, #T_1743a_row0_col16, #T_1743a_row0_col17, #T_1743a_row1_col0, #T_1743a_row1_col1, #T_1743a_row1_col2, #T_1743a_row1_col3, #T_1743a_row1_col4, #T_1743a_row1_col15, #T_1743a_row1_col16, #T_1743a_row1_col17, #T_1743a_row2_col0, #T_1743a_row2_col1, #T_1743a_row2_col2, #T_1743a_row2_col15, #T_1743a_row2_col16, #T_1743a_row2_col17, #T_1743a_row3_col0, #T_1743a_row3_col15, #T_1743a_row3_col16, #T_1743a_row3_col17, #T_1743a_row4_col0, #T_1743a_row4_col6, #T_1743a_row4_col7, #T_1743a_row4_col8, #T_1743a_row4_col9, #T_1743a_row4_col10, #T_1743a_row4_col15, #T_1743a_row4_col16, #T_1743a_row4_col17, #T_1743a_row5_col0, #T_1743a_row5_col5, #T_1743a_row5_col6, #T_1743a_row5_col7, #T_1743a_row5_col8, #T_1743a_row5_col9, #T_1743a_row5_col15, #T_1743a_row5_col16, #T_1743a_row5_col17, #T_1743a_row6_col0, #T_1743a_row6_col1, #T_1743a_row6_col2, #T_1743a_row6_col3, #T_1743a_row6_col4, #T_1743a_row6_col5, #T_1743a_row6_col6, #T_1743a_row6_col7, #T_1743a_row6_col8, #T_1743a_row6_col9, #T_1743a_row6_col14, #T_1743a_row6_col15, #T_1743a_row6_col16, #T_1743a_row6_col17, #T_1743a_row7_col0, #T_1743a_row7_col1, #T_1743a_row7_col2, #T_1743a_row7_col3, #T_1743a_row7_col4, #T_1743a_row7_col5, #T_1743a_row7_col6, #T_1743a_row7_col13, #T_1743a_row7_col14, #T_1743a_row7_col15, #T_1743a_row7_col16, #T_1743a_row7_col17, #T_1743a_row8_col0, #T_1743a_row8_col1, #T_1743a_row8_col2, #T_1743a_row8_col3, #T_1743a_row8_col4, #T_1743a_row8_col13, #T_1743a_row8_col14, #T_1743a_row8_col15, #T_1743a_row8_col16, #T_1743a_row8_col17, #T_1743a_row9_col0, #T_1743a_row9_col1, #T_1743a_row9_col2, #T_1743a_row9_col3, #T_1743a_row9_col4, #T_1743a_row9_col16, #T_1743a_row9_col17, #T_1743a_row10_col0, #T_1743a_row10_col1, #T_1743a_row10_col2, #T_1743a_row10_col3, #T_1743a_row10_col4, #T_1743a_row10_col5, #T_1743a_row10_col6, #T_1743a_row10_col17 {
  font-size: 6pt;
  background-color: #ffffff;
  color: #000000;
}
#T_1743a_row1_col5 {
  font-size: 6pt;
  background-color: #efefef;
  color: #000000;
}
#T_1743a_row1_col6, #T_1743a_row1_col13 {
  font-size: 6pt;
  background-color: #7c7c7c;
  color: #f1f1f1;
}
#T_1743a_row1_col7 {
  font-size: 6pt;
  background-color: #4a4a4a;
  color: #f1f1f1;
}
#T_1743a_row1_col8, #T_1743a_row1_col9, #T_1743a_row1_col10, #T_1743a_row2_col5, #T_1743a_row2_col6, #T_1743a_row2_col7, #T_1743a_row2_col11, #T_1743a_row2_col12, #T_1743a_row2_col13, #T_1743a_row3_col4, #T_1743a_row3_col12, #T_1743a_row3_col13, #T_1743a_row4_col1, #T_1743a_row4_col2, #T_1743a_row4_col3, #T_1743a_row4_col12, #T_1743a_row4_col13, #T_1743a_row5_col12, #T_1743a_row6_col11, #T_1743a_row9_col11, #T_1743a_row10_col11, #T_1743a_row10_col12, #T_1743a_row10_col13, #T_1743a_row10_col14, #T_1743a_row10_col15, #T_1743a_row10_col16 {
  font-size: 6pt;
  background-color: #000000;
  color: #f1f1f1;
}
#T_1743a_row1_col11 {
  font-size: 6pt;
  background-color: #606060;
  color: #f1f1f1;
}
#T_1743a_row1_col12 {
  font-size: 6pt;
  background-color: #4d4d4d;
  color: #f1f1f1;
}
#T_1743a_row1_col14 {
  font-size: 6pt;
  background-color: #bbbbbb;
  color: #000000;
}
#T_1743a_row2_col3 {
  font-size: 6pt;
  background-color: #e4e4e4;
  color: #000000;
}
#T_1743a_row2_col4, #T_1743a_row8_col6 {
  font-size: 6pt;
  background-color: #6b6b6b;
  color: #f1f1f1;
}
#T_1743a_row2_col8, #T_1743a_row2_col14, #T_1743a_row3_col14 {
  font-size: 6pt;
  background-color: #171717;
  color: #f1f1f1;
}
#T_1743a_row2_col9, #T_1743a_row3_col11 {
  font-size: 6pt;
  background-color: #4b4b4b;
  color: #f1f1f1;
}
#T_1743a_row2_col10, #T_1743a_row7_col10, #T_1743a_row8_col8, #T_1743a_row8_col10, #T_1743a_row9_col8, #T_1743a_row9_col10 {
  font-size: 6pt;
  background-color: #010101;
  color: #f1f1f1;
}
#T_1743a_row3_col1 {
  font-size: 6pt;
  background-color: #272727;
  color: #f1f1f1;
}
#T_1743a_row3_col2 {
  font-size: 6pt;
  background-color: #0a0a0a;
  color: #f1f1f1;
}
#T_1743a_row3_col3 {
  font-size: 6pt;
  background-color: #050505;
  color: #f1f1f1;
}
#T_1743a_row3_col5 {
  font-size: 6pt;
  background-color: #333333;
  color: #f1f1f1;
}
#T_1743a_row3_col6 {
  font-size: 6pt;
  background-color: #e6e6e6;
  color: #000000;
}
#T_1743a_row3_col7, #T_1743a_row3_col10 {
  font-size: 6pt;
  background-color: #fafafa;
  color: #000000;
}
#T_1743a_row3_col8 {
  font-size: 6pt;
  background-color: #fbfbfb;
  color: #000000;
}
#T_1743a_row3_col9 {
  font-size: 6pt;
  background-color: #fdfdfd;
  color: #000000;
}
#T_1743a_row4_col4 {
  font-size: 6pt;
  background-color: #1b1b1b;
  color: #f1f1f1;
}
#T_1743a_row4_col5 {
  font-size: 6pt;
  background-color: #e0e0e0;
  color: #000000;
}
#T_1743a_row4_col11 {
  font-size: 6pt;
  background-color: #4e4e4e;
  color: #f1f1f1;
}
#T_1743a_row4_col14 {
  font-size: 6pt;
  background-color: #767676;
  color: #f1f1f1;
}
#T_1743a_row5_col1 {
  font-size: 6pt;
  background-color: #fcfcfc;
  color: #000000;
}
#T_1743a_row5_col2, #T_1743a_row5_col3 {
  font-size: 6pt;
  background-color: #f6f6f6;
  color: #000000;
}
#T_1743a_row5_col4, #T_1743a_row7_col7 {
  font-size: 6pt;
  background-color: #f8f8f8;
  color: #000000;
}
#T_1743a_row5_col10, #T_1743a_row10_col7 {
  font-size: 6pt;
  background-color: #e8e8e8;
  color: #000000;
}
#T_1743a_row5_col11 {
  font-size: 6pt;
  background-color: #222222;
  color: #f1f1f1;
}
#T_1743a_row5_col13, #T_1743a_row6_col12 {
  font-size: 6pt;
  background-color: #090909;
  color: #f1f1f1;
}
#T_1743a_row5_col14 {
  font-size: 6pt;
  background-color: #d0d0d0;
  color: #000000;
}
#T_1743a_row6_col10, #T_1743a_row7_col11, #T_1743a_row9_col6 {
  font-size: 6pt;
  background-color: #060606;
  color: #f1f1f1;
}
#T_1743a_row6_col13 {
  font-size: 6pt;
  background-color: #979797;
  color: #f1f1f1;
}
#T_1743a_row7_col8 {
  font-size: 6pt;
  background-color: #b6b6b6;
  color: #000000;
}
#T_1743a_row7_col9 {
  font-size: 6pt;
  background-color: #252525;
  color: #f1f1f1;
}
#T_1743a_row7_col12 {
  font-size: 6pt;
  background-color: #999999;
  color: #f1f1f1;
}
#T_1743a_row8_col5 {
  font-size: 6pt;
  background-color: #f9f9f9;
  color: #000000;
}
#T_1743a_row8_col7 {
  font-size: 6pt;
  background-color: #101010;
  color: #f1f1f1;
}
#T_1743a_row8_col9, #T_1743a_row9_col9 {
  font-size: 6pt;
  background-color: #020202;
  color: #f1f1f1;
}
#T_1743a_row8_col11 {
  font-size: 6pt;
  background-color: #545454;
  color: #f1f1f1;
}
#T_1743a_row8_col12 {
  font-size: 6pt;
  background-color: #f1f1f1;
  color: #000000;
}
#T_1743a_row9_col5 {
  font-size: 6pt;
  background-color: #f7f7f7;
  color: #000000;
}
#T_1743a_row9_col7 {
  font-size: 6pt;
  background-color: #030303;
  color: #f1f1f1;
}
#T_1743a_row9_col12 {
  font-size: 6pt;
  background-color: #181818;
  color: #f1f1f1;
}
#T_1743a_row9_col13 {
  font-size: 6pt;
  background-color: #303030;
  color: #f1f1f1;
}
#T_1743a_row9_col14 {
  font-size: 6pt;
  background-color: #a9a9a9;
  color: #f1f1f1;
}
#T_1743a_row9_col15 {
  font-size: 6pt;
  background-color: #fefefe;
  color: #000000;
}
#T_1743a_row10_col8, #T_1743a_row10_col9 {
  font-size: 6pt;
  background-color: #bababa;
  color: #000000;
}
#T_1743a_row10_col10 {
  font-size: 6pt;
  background-color: #393939;
  color: #f1f1f1;
}
</style>

<table id="T_1743a" class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_1743a_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">0</th>
<th id="T_1743a_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">1</th>
<th id="T_1743a_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">2</th>
<th id="T_1743a_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">3</th>
<th id="T_1743a_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">4</th>
<th id="T_1743a_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">5</th>
<th id="T_1743a_level0_col6" class="col_heading level0 col6" data-quarto-table-cell-role="th">6</th>
<th id="T_1743a_level0_col7" class="col_heading level0 col7" data-quarto-table-cell-role="th">7</th>
<th id="T_1743a_level0_col8" class="col_heading level0 col8" data-quarto-table-cell-role="th">8</th>
<th id="T_1743a_level0_col9" class="col_heading level0 col9" data-quarto-table-cell-role="th">9</th>
<th id="T_1743a_level0_col10" class="col_heading level0 col10" data-quarto-table-cell-role="th">10</th>
<th id="T_1743a_level0_col11" class="col_heading level0 col11" data-quarto-table-cell-role="th">11</th>
<th id="T_1743a_level0_col12" class="col_heading level0 col12" data-quarto-table-cell-role="th">12</th>
<th id="T_1743a_level0_col13" class="col_heading level0 col13" data-quarto-table-cell-role="th">13</th>
<th id="T_1743a_level0_col14" class="col_heading level0 col14" data-quarto-table-cell-role="th">14</th>
<th id="T_1743a_level0_col15" class="col_heading level0 col15" data-quarto-table-cell-role="th">15</th>
<th id="T_1743a_level0_col16" class="col_heading level0 col16" data-quarto-table-cell-role="th">16</th>
<th id="T_1743a_level0_col17" class="col_heading level0 col17" data-quarto-table-cell-role="th">17</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_1743a_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_1743a_row0_col0" class="data row0 col0">0</td>
<td id="T_1743a_row0_col1" class="data row0 col1">0</td>
<td id="T_1743a_row0_col2" class="data row0 col2">0</td>
<td id="T_1743a_row0_col3" class="data row0 col3">0</td>
<td id="T_1743a_row0_col4" class="data row0 col4">0</td>
<td id="T_1743a_row0_col5" class="data row0 col5">0</td>
<td id="T_1743a_row0_col6" class="data row0 col6">0</td>
<td id="T_1743a_row0_col7" class="data row0 col7">0</td>
<td id="T_1743a_row0_col8" class="data row0 col8">0</td>
<td id="T_1743a_row0_col9" class="data row0 col9">0</td>
<td id="T_1743a_row0_col10" class="data row0 col10">0</td>
<td id="T_1743a_row0_col11" class="data row0 col11">0</td>
<td id="T_1743a_row0_col12" class="data row0 col12">0</td>
<td id="T_1743a_row0_col13" class="data row0 col13">0</td>
<td id="T_1743a_row0_col14" class="data row0 col14">0</td>
<td id="T_1743a_row0_col15" class="data row0 col15">0</td>
<td id="T_1743a_row0_col16" class="data row0 col16">0</td>
<td id="T_1743a_row0_col17" class="data row0 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_1743a_row1_col0" class="data row1 col0">0</td>
<td id="T_1743a_row1_col1" class="data row1 col1">0</td>
<td id="T_1743a_row1_col2" class="data row1 col2">0</td>
<td id="T_1743a_row1_col3" class="data row1 col3">0</td>
<td id="T_1743a_row1_col4" class="data row1 col4">0</td>
<td id="T_1743a_row1_col5" class="data row1 col5">29</td>
<td id="T_1743a_row1_col6" class="data row1 col6">150</td>
<td id="T_1743a_row1_col7" class="data row1 col7">195</td>
<td id="T_1743a_row1_col8" class="data row1 col8">254</td>
<td id="T_1743a_row1_col9" class="data row1 col9">255</td>
<td id="T_1743a_row1_col10" class="data row1 col10">254</td>
<td id="T_1743a_row1_col11" class="data row1 col11">176</td>
<td id="T_1743a_row1_col12" class="data row1 col12">193</td>
<td id="T_1743a_row1_col13" class="data row1 col13">150</td>
<td id="T_1743a_row1_col14" class="data row1 col14">96</td>
<td id="T_1743a_row1_col15" class="data row1 col15">0</td>
<td id="T_1743a_row1_col16" class="data row1 col16">0</td>
<td id="T_1743a_row1_col17" class="data row1 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_1743a_row2_col0" class="data row2 col0">0</td>
<td id="T_1743a_row2_col1" class="data row2 col1">0</td>
<td id="T_1743a_row2_col2" class="data row2 col2">0</td>
<td id="T_1743a_row2_col3" class="data row2 col3">48</td>
<td id="T_1743a_row2_col4" class="data row2 col4">166</td>
<td id="T_1743a_row2_col5" class="data row2 col5">224</td>
<td id="T_1743a_row2_col6" class="data row2 col6">253</td>
<td id="T_1743a_row2_col7" class="data row2 col7">253</td>
<td id="T_1743a_row2_col8" class="data row2 col8">234</td>
<td id="T_1743a_row2_col9" class="data row2 col9">196</td>
<td id="T_1743a_row2_col10" class="data row2 col10">253</td>
<td id="T_1743a_row2_col11" class="data row2 col11">253</td>
<td id="T_1743a_row2_col12" class="data row2 col12">253</td>
<td id="T_1743a_row2_col13" class="data row2 col13">253</td>
<td id="T_1743a_row2_col14" class="data row2 col14">233</td>
<td id="T_1743a_row2_col15" class="data row2 col15">0</td>
<td id="T_1743a_row2_col16" class="data row2 col16">0</td>
<td id="T_1743a_row2_col17" class="data row2 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_1743a_row3_col0" class="data row3 col0">0</td>
<td id="T_1743a_row3_col1" class="data row3 col1">93</td>
<td id="T_1743a_row3_col2" class="data row3 col2">244</td>
<td id="T_1743a_row3_col3" class="data row3 col3">249</td>
<td id="T_1743a_row3_col4" class="data row3 col4">253</td>
<td id="T_1743a_row3_col5" class="data row3 col5">187</td>
<td id="T_1743a_row3_col6" class="data row3 col6">46</td>
<td id="T_1743a_row3_col7" class="data row3 col7">10</td>
<td id="T_1743a_row3_col8" class="data row3 col8">8</td>
<td id="T_1743a_row3_col9" class="data row3 col9">4</td>
<td id="T_1743a_row3_col10" class="data row3 col10">10</td>
<td id="T_1743a_row3_col11" class="data row3 col11">194</td>
<td id="T_1743a_row3_col12" class="data row3 col12">253</td>
<td id="T_1743a_row3_col13" class="data row3 col13">253</td>
<td id="T_1743a_row3_col14" class="data row3 col14">233</td>
<td id="T_1743a_row3_col15" class="data row3 col15">0</td>
<td id="T_1743a_row3_col16" class="data row3 col16">0</td>
<td id="T_1743a_row3_col17" class="data row3 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_1743a_row4_col0" class="data row4 col0">0</td>
<td id="T_1743a_row4_col1" class="data row4 col1">107</td>
<td id="T_1743a_row4_col2" class="data row4 col2">253</td>
<td id="T_1743a_row4_col3" class="data row4 col3">253</td>
<td id="T_1743a_row4_col4" class="data row4 col4">230</td>
<td id="T_1743a_row4_col5" class="data row4 col5">48</td>
<td id="T_1743a_row4_col6" class="data row4 col6">0</td>
<td id="T_1743a_row4_col7" class="data row4 col7">0</td>
<td id="T_1743a_row4_col8" class="data row4 col8">0</td>
<td id="T_1743a_row4_col9" class="data row4 col9">0</td>
<td id="T_1743a_row4_col10" class="data row4 col10">0</td>
<td id="T_1743a_row4_col11" class="data row4 col11">192</td>
<td id="T_1743a_row4_col12" class="data row4 col12">253</td>
<td id="T_1743a_row4_col13" class="data row4 col13">253</td>
<td id="T_1743a_row4_col14" class="data row4 col14">156</td>
<td id="T_1743a_row4_col15" class="data row4 col15">0</td>
<td id="T_1743a_row4_col16" class="data row4 col16">0</td>
<td id="T_1743a_row4_col17" class="data row4 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_1743a_row5_col0" class="data row5 col0">0</td>
<td id="T_1743a_row5_col1" class="data row5 col1">3</td>
<td id="T_1743a_row5_col2" class="data row5 col2">20</td>
<td id="T_1743a_row5_col3" class="data row5 col3">20</td>
<td id="T_1743a_row5_col4" class="data row5 col4">15</td>
<td id="T_1743a_row5_col5" class="data row5 col5">0</td>
<td id="T_1743a_row5_col6" class="data row5 col6">0</td>
<td id="T_1743a_row5_col7" class="data row5 col7">0</td>
<td id="T_1743a_row5_col8" class="data row5 col8">0</td>
<td id="T_1743a_row5_col9" class="data row5 col9">0</td>
<td id="T_1743a_row5_col10" class="data row5 col10">43</td>
<td id="T_1743a_row5_col11" class="data row5 col11">224</td>
<td id="T_1743a_row5_col12" class="data row5 col12">253</td>
<td id="T_1743a_row5_col13" class="data row5 col13">245</td>
<td id="T_1743a_row5_col14" class="data row5 col14">74</td>
<td id="T_1743a_row5_col15" class="data row5 col15">0</td>
<td id="T_1743a_row5_col16" class="data row5 col16">0</td>
<td id="T_1743a_row5_col17" class="data row5 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_1743a_row6_col0" class="data row6 col0">0</td>
<td id="T_1743a_row6_col1" class="data row6 col1">0</td>
<td id="T_1743a_row6_col2" class="data row6 col2">0</td>
<td id="T_1743a_row6_col3" class="data row6 col3">0</td>
<td id="T_1743a_row6_col4" class="data row6 col4">0</td>
<td id="T_1743a_row6_col5" class="data row6 col5">0</td>
<td id="T_1743a_row6_col6" class="data row6 col6">0</td>
<td id="T_1743a_row6_col7" class="data row6 col7">0</td>
<td id="T_1743a_row6_col8" class="data row6 col8">0</td>
<td id="T_1743a_row6_col9" class="data row6 col9">0</td>
<td id="T_1743a_row6_col10" class="data row6 col10">249</td>
<td id="T_1743a_row6_col11" class="data row6 col11">253</td>
<td id="T_1743a_row6_col12" class="data row6 col12">245</td>
<td id="T_1743a_row6_col13" class="data row6 col13">126</td>
<td id="T_1743a_row6_col14" class="data row6 col14">0</td>
<td id="T_1743a_row6_col15" class="data row6 col15">0</td>
<td id="T_1743a_row6_col16" class="data row6 col16">0</td>
<td id="T_1743a_row6_col17" class="data row6 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_1743a_row7_col0" class="data row7 col0">0</td>
<td id="T_1743a_row7_col1" class="data row7 col1">0</td>
<td id="T_1743a_row7_col2" class="data row7 col2">0</td>
<td id="T_1743a_row7_col3" class="data row7 col3">0</td>
<td id="T_1743a_row7_col4" class="data row7 col4">0</td>
<td id="T_1743a_row7_col5" class="data row7 col5">0</td>
<td id="T_1743a_row7_col6" class="data row7 col6">0</td>
<td id="T_1743a_row7_col7" class="data row7 col7">14</td>
<td id="T_1743a_row7_col8" class="data row7 col8">101</td>
<td id="T_1743a_row7_col9" class="data row7 col9">223</td>
<td id="T_1743a_row7_col10" class="data row7 col10">253</td>
<td id="T_1743a_row7_col11" class="data row7 col11">248</td>
<td id="T_1743a_row7_col12" class="data row7 col12">124</td>
<td id="T_1743a_row7_col13" class="data row7 col13">0</td>
<td id="T_1743a_row7_col14" class="data row7 col14">0</td>
<td id="T_1743a_row7_col15" class="data row7 col15">0</td>
<td id="T_1743a_row7_col16" class="data row7 col16">0</td>
<td id="T_1743a_row7_col17" class="data row7 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_1743a_row8_col0" class="data row8 col0">0</td>
<td id="T_1743a_row8_col1" class="data row8 col1">0</td>
<td id="T_1743a_row8_col2" class="data row8 col2">0</td>
<td id="T_1743a_row8_col3" class="data row8 col3">0</td>
<td id="T_1743a_row8_col4" class="data row8 col4">0</td>
<td id="T_1743a_row8_col5" class="data row8 col5">11</td>
<td id="T_1743a_row8_col6" class="data row8 col6">166</td>
<td id="T_1743a_row8_col7" class="data row8 col7">239</td>
<td id="T_1743a_row8_col8" class="data row8 col8">253</td>
<td id="T_1743a_row8_col9" class="data row8 col9">253</td>
<td id="T_1743a_row8_col10" class="data row8 col10">253</td>
<td id="T_1743a_row8_col11" class="data row8 col11">187</td>
<td id="T_1743a_row8_col12" class="data row8 col12">30</td>
<td id="T_1743a_row8_col13" class="data row8 col13">0</td>
<td id="T_1743a_row8_col14" class="data row8 col14">0</td>
<td id="T_1743a_row8_col15" class="data row8 col15">0</td>
<td id="T_1743a_row8_col16" class="data row8 col16">0</td>
<td id="T_1743a_row8_col17" class="data row8 col17">0</td>
</tr>
<tr class="even">
<td id="T_1743a_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_1743a_row9_col0" class="data row9 col0">0</td>
<td id="T_1743a_row9_col1" class="data row9 col1">0</td>
<td id="T_1743a_row9_col2" class="data row9 col2">0</td>
<td id="T_1743a_row9_col3" class="data row9 col3">0</td>
<td id="T_1743a_row9_col4" class="data row9 col4">0</td>
<td id="T_1743a_row9_col5" class="data row9 col5">16</td>
<td id="T_1743a_row9_col6" class="data row9 col6">248</td>
<td id="T_1743a_row9_col7" class="data row9 col7">250</td>
<td id="T_1743a_row9_col8" class="data row9 col8">253</td>
<td id="T_1743a_row9_col9" class="data row9 col9">253</td>
<td id="T_1743a_row9_col10" class="data row9 col10">253</td>
<td id="T_1743a_row9_col11" class="data row9 col11">253</td>
<td id="T_1743a_row9_col12" class="data row9 col12">232</td>
<td id="T_1743a_row9_col13" class="data row9 col13">213</td>
<td id="T_1743a_row9_col14" class="data row9 col14">111</td>
<td id="T_1743a_row9_col15" class="data row9 col15">2</td>
<td id="T_1743a_row9_col16" class="data row9 col16">0</td>
<td id="T_1743a_row9_col17" class="data row9 col17">0</td>
</tr>
<tr class="odd">
<td id="T_1743a_level0_row10" class="row_heading level0 row10" data-quarto-table-cell-role="th">10</td>
<td id="T_1743a_row10_col0" class="data row10 col0">0</td>
<td id="T_1743a_row10_col1" class="data row10 col1">0</td>
<td id="T_1743a_row10_col2" class="data row10 col2">0</td>
<td id="T_1743a_row10_col3" class="data row10 col3">0</td>
<td id="T_1743a_row10_col4" class="data row10 col4">0</td>
<td id="T_1743a_row10_col5" class="data row10 col5">0</td>
<td id="T_1743a_row10_col6" class="data row10 col6">0</td>
<td id="T_1743a_row10_col7" class="data row10 col7">43</td>
<td id="T_1743a_row10_col8" class="data row10 col8">98</td>
<td id="T_1743a_row10_col9" class="data row10 col9">98</td>
<td id="T_1743a_row10_col10" class="data row10 col10">208</td>
<td id="T_1743a_row10_col11" class="data row10 col11">253</td>
<td id="T_1743a_row10_col12" class="data row10 col12">253</td>
<td id="T_1743a_row10_col13" class="data row10 col13">253</td>
<td id="T_1743a_row10_col14" class="data row10 col14">253</td>
<td id="T_1743a_row10_col15" class="data row10 col15">187</td>
<td id="T_1743a_row10_col16" class="data row10 col16">22</td>
<td id="T_1743a_row10_col17" class="data row10 col17">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="first-try-pixel-similarity" class="level2">
<h2 class="anchored" data-anchor-id="first-try-pixel-similarity">First Try: Pixel Similarity</h2>
<blockquote class="blockquote">
<p>jargon: Baseline: A simple model which you are confident should perform reasonably well. It should be very simple to implement, and very easy to test, so that you can then test each of your improved ideas, and make sure they are always better than your baseline. Without starting with a sensible baseline, it is very difficult to know whether your super-fancy models are actually any good. One good approach to creating a baseline is doing what we have done here: think of a simple, easy-to-implement model. Another good approach is to search around to find other people that have solved similar problems to yours, and download and run their code on your dataset. Ideally, try both of these!</p>
</blockquote>
<p><mark>&lt;mark&gt;I love this advice ^^^. I’ll try to follow it as much as possible.&lt;/mark&gt;</mark></p>
<div id="cell-18" class="cell" data-outputid="47a60c35-ed66-4f0b-abf6-542b983623dd" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>seven_tensors <span class="op">=</span> [tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> sevens]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>three_tensors <span class="op">=</span> [tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> threes]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(three_tensors),<span class="bu">len</span>(seven_tensors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(6131, 6265)</code></pre>
</div>
</div>
<div id="cell-19" class="cell" data-outputid="1ba29d9a-1c4b-498d-fcf2-86180c373e26" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>show_image(three_tensors[<span class="dv">1</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-20" class="cell" data-outputid="9d3597bf-f400-442f-c08b-cc87fd957abd" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>stacked_sevens <span class="op">=</span> torch.stack(seven_tensors).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>stacked_threes <span class="op">=</span> torch.stack(three_tensors).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>stacked_threes.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>torch.Size([6131, 28, 28])</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-outputid="0f11346d-4d8e-4d72-9621-4cec4ec8d573" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(stacked_threes.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>3</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-outputid="0ef247d5-310e-4005-ec38-c00f6641a7cc" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>stacked_threes.ndim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>3</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-outputid="68ba5928-6201-451b-8388-0de3b3a4445c" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mean3 <span class="op">=</span> stacked_threes.mean(<span class="dv">0</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>show_image(mean3)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-outputid="3882e076-28b2-400b-9dc7-6102000f1620" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>mean7 <span class="op">=</span> stacked_sevens.mean(<span class="dv">0</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>show_image(mean7)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-25" class="cell" data-outputid="d890a751-9157-4e4a-f931-e78f7cb5fe3e" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>a_3 <span class="op">=</span> stacked_threes[<span class="dv">1</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>show_image(a_3)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There are two main ways data scientists measure distance in this context:</p>
<ul>
<li>Take the mean of the <em>absolute value</em> of differences (absolute value is the function that replaces negative values with positive values). This is called the <em>mean absolute difference</em> or <em>L1 norm</em></li>
<li>Take the mean of the <em>square</em> of differences (which makes everything positive) and then take the <em>square root</em> (which undoes the squaring). This is called the <em>root mean squared error</em> (RMSE) or <em>L2 norm</em>.</li>
</ul>
<div id="cell-27" class="cell" data-outputid="63f93072-ee00-4fee-bef7-4a790d0f83f9" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dist_3_abs <span class="op">=</span> (a_3 <span class="op">-</span> mean3).<span class="bu">abs</span>().mean()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>dist_3_sqr <span class="op">=</span> ((a_3 <span class="op">-</span> mean3)<span class="op">**</span><span class="dv">2</span>).mean().sqrt()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>dist_3_abs,dist_3_sqr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tensor(0.1114), tensor(0.2021))</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-outputid="5e15a121-9740-41cc-fdbd-a55c043e9fc5" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dist_7_abs <span class="op">=</span> (a_3 <span class="op">-</span> mean7).<span class="bu">abs</span>().mean()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>dist_7_sqr <span class="op">=</span> ((a_3 <span class="op">-</span> mean7)<span class="op">**</span><span class="dv">2</span>).mean().sqrt()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>dist_7_abs,dist_7_sqr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(tensor(0.1586), tensor(0.3021))</code></pre>
</div>
</div>
<p>PyTorch already provides both of these as <em>loss functions</em>. You’ll find these inside <code>torch.nn.functional</code>, which the PyTorch team recommends importing as <code>F</code> (and is available by default under that name in fastai):</p>
<div id="cell-30" class="cell" data-outputid="5d615dff-0185-4bf8-a007-d1abf2b41b85" data-execution_count="20">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>F.l1_loss(a_3.<span class="bu">float</span>(),mean7), F.mse_loss(a_3,mean7).sqrt()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>(tensor(0.1586), tensor(0.3021))</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>S: Intuitively, the difference between L1 norm and mean squared error (MSE) is that the latter will penalize bigger mistakes more heavily than the former (and be more lenient with small mistakes).</p>
</blockquote>
</section>
<section id="computing-metrics-using-broadcasting" class="level2">
<h2 class="anchored" data-anchor-id="computing-metrics-using-broadcasting">Computing Metrics Using Broadcasting</h2>
<div id="cell-33" class="cell" data-outputid="ee76ded8-152e-4def-8160-e2f52e1b3202" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>valid_3_tens <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> o <span class="kw">in</span> (path<span class="op">/</span><span class="st">'valid'</span><span class="op">/</span><span class="st">'3'</span>).ls()])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>valid_3_tens <span class="op">=</span> valid_3_tens.<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>valid_7_tens <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> o <span class="kw">in</span> (path<span class="op">/</span><span class="st">'valid'</span><span class="op">/</span><span class="st">'7'</span>).ls()])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>valid_7_tens <span class="op">=</span> valid_7_tens.<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>valid_3_tens.shape,valid_7_tens.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(torch.Size([1010, 28, 28]), torch.Size([1028, 28, 28]))</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-outputid="a538cb27-05b6-43e2-ca5f-032d0d7d8f96" data-execution_count="24">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_distance(a,b): <span class="cf">return</span> (a<span class="op">-</span>b).<span class="bu">abs</span>().mean((<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">2</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>mnist_distance(a_3, mean3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>tensor(0.1114)</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;This tuple <code>(-1,-2)</code> as an argument for the <code>mean()</code> method is not directly clear to me, so let’s have a look at the docs:&lt;/mark&gt;</mark></p>
<div id="cell-36" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>?torch.mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Docstring:</span>

mean(input, *, dtype=None) -&gt; Tensor



Returns the mean value of all elements in the :attr:`input` tensor.



Args:

    input (Tensor): the input tensor.



Keyword args:

    dtype (:class:`torch.dtype`, optional): the desired data type of returned tensor.

        If specified, the input tensor is casted to :attr:`dtype` before the operation

        is performed. This is useful for preventing data type overflows. Default: None.



Example::



    &gt;&gt;&gt; a = torch.randn(1, 3)

    &gt;&gt;&gt; a

    tensor([[ 0.2294, -0.5481,  1.3288]])

    &gt;&gt;&gt; torch.mean(a)

    tensor(0.3367)



.. function:: mean(input, dim, keepdim=False, *, dtype=None, out=None) -&gt; Tensor

   :noindex:



Returns the mean value of each row of the :attr:`input` tensor in the given

dimension :attr:`dim`. If :attr:`dim` is a list of dimensions,

reduce over all of them.





If :attr:`keepdim` is ``True``, the output tensor is of the same size

as :attr:`input` except in the dimension(s) :attr:`dim` where it is of size 1.

Otherwise, :attr:`dim` is squeezed (see :func:`torch.squeeze`), resulting in the

output tensor having 1 (or ``len(dim)``) fewer dimension(s).





Args:

    input (Tensor): the input tensor.

    dim (int or tuple of ints): the dimension or dimensions to reduce.

    keepdim (bool): whether the output tensor has :attr:`dim` retained or not.



Keyword args:

    dtype (:class:`torch.dtype`, optional): the desired data type of returned tensor.

        If specified, the input tensor is casted to :attr:`dtype` before the operation

        is performed. This is useful for preventing data type overflows. Default: None.

    out (Tensor, optional): the output tensor.



.. seealso::



    :func:`torch.nanmean` computes the mean value of `non-NaN` elements.



Example::



    &gt;&gt;&gt; a = torch.randn(4, 4)

    &gt;&gt;&gt; a

    tensor([[-0.3841,  0.6320,  0.4254, -0.7384],

            [-0.9644,  1.0131, -0.6549, -1.4279],

            [-0.2951, -1.3350, -0.7694,  0.5600],

            [ 1.0842, -0.9580,  0.3623,  0.2343]])

    &gt;&gt;&gt; torch.mean(a, 1)

    tensor([-0.0163, -0.5085, -0.4599,  0.1807])

    &gt;&gt;&gt; torch.mean(a, 1, True)

    tensor([[-0.0163],

            [-0.5085],

            [-0.4599],

            [ 0.1807]])

<span class="ansi-red-fg">Type:</span>      builtin_function_or_method</pre>
</div>
</div>
</div>
<p><mark>&lt;mark&gt;So the tuple represents a list of dimensions to reduce. In our case the last and second last dimension, which are the dimensions that contain the image pixel values (and the only two dimensions). In other words, this method calculates the average over all elements in the 24x24 matrix.&lt;/mark&gt;</mark></p>
<div id="cell-38" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(a_3<span class="op">-</span>mean3).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>torch.Size([28, 28])</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>sm <span class="op">=</span> (a_3<span class="op">-</span>mean3).<span class="bu">abs</span>().<span class="bu">sum</span>()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>avg <span class="op">=</span> sm <span class="op">/</span> (a_3.shape[<span class="dv">0</span>] <span class="op">*</span> a_3.shape[<span class="dv">1</span>])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>avg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>tensor(0.1114)</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;Same result!&lt;/mark&gt;</mark></p>
<div id="cell-41" class="cell" data-outputid="df75ce37-f441-4a3a-ae39-9a9b77a32f73" data-execution_count="38">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>valid_3_dist <span class="op">=</span> mnist_distance(valid_3_tens, mean3)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>valid_3_dist, valid_3_dist.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(tensor([0.1634, 0.1145, 0.1363,  ..., 0.1105, 0.1111, 0.1640]),
 torch.Size([1010]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So here we did the same, but as the first argument we pass a whole stack of images from the validation set. What happened? This works because of a feature called broadcasting. Let’s dive into that:&lt;/mark&gt;</mark></p>
<div id="cell-43" class="cell" data-outputid="c0f521e0-b116-4039-9df5-561c6d140ed5">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"valid_3_tens.shape: </span><span class="sc">{</span>valid_3_tens<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"mean3.shape: </span><span class="sc">{</span>mean3<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> (valid_3_tens<span class="op">-</span>mean3)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>diff.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>valid_3_tens.shape: torch.Size([1010, 28, 28])
mean3.shape: torch.Size([28, 28])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>torch.Size([1010, 28, 28])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;<code>valid_3_tens</code> has shape <code>[1010, 28, 28]</code>, and <code>mean3</code> has shape <code>[28, 28]</code>. When we subtract them we don’t get an error, but a tensor with shape <code>[1010, 28, 28]</code>.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;So the broadcasting feature automatically expands the shape of <code>mean3</code> to <code>[1010, 28, 28]</code> so that it can be subtracted from <code>valid_3_tens</code>. There is a couple of conditions that need to be met for this to made possible. Time to experiment a bit with the help of Gemini:&lt;/mark&gt;</mark></p>
<blockquote class="blockquote">
<p>Broadcasting is PyTorch’s way of making operations work between tensors of different but compatible shapes. Instead of you writing explicit loops or manually reshaping/copying data, PyTorch does it conceptually (and efficiently in C++/CUDA).</p>
<p>The Core Idea: Pretend the smaller tensor is expanded (like stretching or copying) to match the shape of the larger tensor, then perform the operation elementwise. Crucially, no actual memory duplication happens.</p>
<p>Rules for Compatibility: PyTorch compares the shapes of two tensors elementwise, starting from the trailing dimensions (the rightmost ones) and working backward. Two dimensions are compatible if:</p>
<ol type="1">
<li>They are equal.</li>
<li>One of them is 1.</li>
</ol>
<p>If these conditions aren’t met for any dimension pair, the tensors are not broadcast-compatible, and you’ll get an error. If one tensor runs out of dimensions during the comparison (e.g., comparing a 3D tensor to a 2D tensor), dimensions of size 1 are assumed at the beginning of its shape.</p>
</blockquote>
<p><mark>&lt;mark&gt;Now that we know that, we can see that in our example, the two rightmost dimensions have the same size [28, 28], and then the mean3 tensor runs out of dimensions, so it is turned into [1, 28, 28], which makes it compatible for broadcasting. Subsequently the mean3 tensor is expanded into [1010, 28, 28], by repeating the same data 1010 times, so we can subtract the two tensors.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;Let’s play a bit with that…&lt;/mark&gt;</mark></p>
<div id="cell-47" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a tensor A with shape (5, 1, 4)</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.zeros(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a tensor B with shape (5, 3, 1)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> torch.ones(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a tensor C with shape (3, 4)</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> torch.rand(<span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Can we add A and B?</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> A <span class="op">+</span> B</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"A + B result shape:"</span>, result.shape)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> e:</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error adding A and B: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Can we add A and C?</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> A <span class="op">+</span> C</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"A + C result shape:"</span>, result.shape)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> e:</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error adding A and C: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Can we add B and C?</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> B <span class="op">+</span> C</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"B + C result shape:"</span>, result.shape)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> e:</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error adding B and C: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A + B result shape: torch.Size([5, 3, 4])
A + C result shape: torch.Size([5, 3, 4])
B + C result shape: torch.Size([5, 3, 4])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;I think I’ve got that down now!&lt;/mark&gt;</mark></p>
<div id="cell-49" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_3(x): <span class="cf">return</span> mnist_distance(x,mean3) <span class="op">&lt;</span> mnist_distance(x,mean7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell" data-outputid="b5ac07c2-aa78-4a84-b0de-ed4d024e4341" data-execution_count="53">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>is_3(a_3), is_3(a_3).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(tensor(True), tensor(1.))</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-outputid="7db6134e-69ab-4850-8ed8-e76d4ec8b4f5" data-execution_count="54">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>is_3(valid_3_tens)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>tensor([True, True, True,  ..., True, True, True])</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-outputid="da9e6481-3dd3-476e-90ee-7e011bff1564" data-execution_count="55">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>accuracy_3s <span class="op">=</span>      is_3(valid_3_tens).<span class="bu">float</span>() .mean()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>accuracy_7s <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> is_3(valid_7_tens).<span class="bu">float</span>()).mean()</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>accuracy_3s,accuracy_7s,(accuracy_3s<span class="op">+</span>accuracy_7s)<span class="op">/</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(tensor(0.9168), tensor(0.9854), tensor(0.9511))</code></pre>
</div>
</div>
</section>
<section id="stochastic-gradient-descent-sgd" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-gradient-descent-sgd">Stochastic Gradient Descent (SGD)</h2>
<p>To be more specific, here are the steps that we are going to require, to turn this function into a machine learning classifier:</p>
<ol type="1">
<li><em>Initialize</em> the weights.</li>
<li>For each image, use these weights to <em>predict</em> whether it appears to be a 3 or a 7.</li>
<li>Based on these predictions, calculate how good the model is (its <em>loss</em>).</li>
<li>Calculate the <em>gradient</em>, which measures for each weight, how changing that weight would change the loss</li>
<li><em>Step</em> (that is, change) all the weights based on that calculation.</li>
<li>Go back to the step 2, and <em>repeat</em> the process.</li>
<li>Iterate until you decide to <em>stop</em> the training process (for instance, because the model is good enough or you don’t want to wait any longer).</li>
</ol>
<p>These seven steps, illustrated below, are the key to the training of all deep learning models. That deep learning turns out to rely entirely on these steps is extremely surprising and counterintuitive. It’s amazing that this process can solve such complex problems. But, as you’ll see, it really does!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./gradient-descent.png" class="img-fluid figure-img"></p>
<figcaption>Gradient descent</figcaption>
</figure>
</div>
<p>There are many different ways to do each of these seven steps, and we will be learning about them throughout the rest of this book. These are the details that make a big difference for deep learning practitioners, but it turns out that the general approach to each one generally follows some basic principles. Here are a few guidelines:</p>
<ul>
<li>Initialize:: We initialize the parameters to random values. This may sound surprising. There are certainly other choices we could make, such as initializing them to the percentage of times that pixel is activated for that category—but since we already know that we have a routine to improve these weights, it turns out that just starting with random weights works perfectly well.</li>
<li>Loss:: This is what Samuel referred to when he spoke of <em>testing the effectiveness of any current weight assignment in terms of actual performance</em>. We need some function that will return a number that is small if the performance of the model is good (the standard approach is to treat a small loss as good, and a large loss as bad, although this is just a convention).</li>
<li>Step:: A simple way to figure out whether a weight should be increased a bit, or decreased a bit, would be just to try it: increase the weight by a small amount, and see if the loss goes up or down. Once you find the correct direction, you could then change that amount by a bit more, and a bit less, until you find an amount that works well. However, this is slow! As we will see, the magic of calculus allows us to directly figure out in which direction, and by roughly how much, to change each weight, without having to try all these small changes. The way to do this is by calculating <em>gradients</em>. This is just a performance optimization, we would get exactly the same results by using the slower manual process as well.</li>
<li>Stop:: Once we’ve decided how many epochs to train the model for (a few suggestions for this were given in the earlier list), we apply that decision. This is where that decision is applied. For our digit classifier, we would keep training until the accuracy of the model started getting worse, or we ran out of time.</li>
</ul>
<div id="cell-57" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x): <span class="cf">return</span> x<span class="op">**</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-58" class="cell" data-outputid="d98e10a2-0307-41b6-ee92-2468fafdb63a">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>plot_function(f, <span class="st">'x'</span>, <span class="st">'x**2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-59" class="cell" data-outputid="aa87d9be-88f4-4947-a5c7-60931453dd7f">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plot_function(f, <span class="st">'x'</span>, <span class="st">'x**2'</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(<span class="op">-</span><span class="fl">1.5</span>, f(<span class="op">-</span><span class="fl">1.5</span>), color<span class="op">=</span><span class="st">'red'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><img alt="A graph showing the squared function with the slope at one point" width="400" src="https://github.com/fastai/fastbook/blob/master/images/grad_illustration.svg?raw=1"></p>
<p><img alt="An illustration of gradient descent" width="400" src="https://github.com/fastai/fastbook/blob/master/images/chapter2_perfect.svg?raw=1"></p>
<section id="calculating-gradients" class="level3">
<h3 class="anchored" data-anchor-id="calculating-gradients">Calculating Gradients</h3>
<p>One important thing to be aware of is that our function has lots of weights that we need to adjust, so when we calculate the derivative we won’t get back one number, but lots of them—a gradient for every weight. But there is nothing mathematically tricky here; you can calculate the derivative with respect to one weight, and treat all the other ones as constant, then repeat that for each other weight. This is how all of the gradients are calculated, for every weight.</p>
<p>First, let’s pick a tensor value which we want gradients at:</p>
<div id="cell-64" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> tensor(<span class="fl">3.</span>).requires_grad_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell" data-outputid="4827e1c8-c423-467b-ecfb-a6b91491f734" data-execution_count="59">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> f(xt)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>yt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>tensor(9., grad_fn=&lt;PowBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>yt.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell" data-outputid="b06a9a97-7aec-4bb8-9928-30b9d198d740" data-execution_count="61">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>xt.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>tensor(6.)</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-outputid="d552e789-091e-4fbc-f162-198a3d98f605" data-execution_count="62">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> tensor([<span class="fl">3.</span>,<span class="fl">4.</span>,<span class="fl">10.</span>]).requires_grad_()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>xt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>tensor([ 3.,  4., 10.], requires_grad=True)</code></pre>
</div>
</div>
<div id="cell-69" class="cell" data-outputid="160d94d7-4469-4117-f974-40709a5820f4" data-execution_count="63">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x): <span class="cf">return</span> (x<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> f(xt)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>yt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>tensor(125., grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-outputid="502ca637-8d79-45db-9934-59239c3081ee" data-execution_count="64">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>yt.backward()</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>xt.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>tensor([ 6.,  8., 20.])</code></pre>
</div>
</div>
</section>
<section id="stepping-with-a-learning-rate" class="level3">
<h3 class="anchored" data-anchor-id="stepping-with-a-learning-rate">Stepping With a Learning Rate</h3>
<p>w -= gradient(w) * lr</p>
</section>
<section id="an-end-to-end-sgd-example" class="level3">
<h3 class="anchored" data-anchor-id="an-end-to-end-sgd-example">An End-to-End SGD Example</h3>
<div id="cell-74" class="cell" data-outputid="8aa24e97-88ba-4625-d100-f809d8bb30f5" data-execution_count="65">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>time <span class="op">=</span> torch.arange(<span class="dv">0</span>,<span class="dv">20</span>).<span class="bu">float</span>()<span class="op">;</span> time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>tensor([ 0.,  1.,  2.,  3.,  4.,  5.,  6.,  7.,  8.,  9., 10., 11., 12., 13.,
        14., 15., 16., 17., 18., 19.])</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-outputid="da844c17-0939-46dc-fb2a-aef5159658cc" data-execution_count="66">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>speed <span class="op">=</span> torch.randn(<span class="dv">20</span>)<span class="op">*</span><span class="dv">3</span> <span class="op">+</span> <span class="fl">0.75</span><span class="op">*</span>(time<span class="op">-</span><span class="fl">9.5</span>)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(time,speed)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(t, params):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    a,b,c <span class="op">=</span> params</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">*</span>(t<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> (b<span class="op">*</span>t) <span class="op">+</span> c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mse(preds, targets): <span class="cf">return</span> ((preds<span class="op">-</span>targets)<span class="op">**</span><span class="dv">2</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="step-1-initialize-the-parameters" class="level4">
<h4 class="anchored" data-anchor-id="step-1-initialize-the-parameters">Step 1: Initialize the parameters</h4>
<div id="cell-79" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> torch.randn(<span class="dv">3</span>).requires_grad_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-calculate-the-predictions" class="level4">
<h4 class="anchored" data-anchor-id="step-2-calculate-the-predictions">Step 2: Calculate the predictions</h4>
<div id="cell-81" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> f(time, params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-82" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_preds(preds, ax<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>: ax<span class="op">=</span>plt.subplots()[<span class="dv">1</span>]</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    ax.scatter(time, speed)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    ax.scatter(time, to_np(preds), color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="op">-</span><span class="dv">300</span>,<span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell" data-outputid="ab42ec89-3091-45b3-a88b-6ff6afaef035" data-execution_count="74">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>show_preds(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-3-calculate-the-loss" class="level4">
<h4 class="anchored" data-anchor-id="step-3-calculate-the-loss">Step 3: Calculate the loss</h4>
<div id="cell-85" class="cell" data-outputid="e3ad74c6-baa1-4e6d-9d39-d1c947517630" data-execution_count="75">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse(preds, speed)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor(82827.6641, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="step-4-calculate-the-gradients" class="level4">
<h4 class="anchored" data-anchor-id="step-4-calculate-the-gradients">Step 4: Calculate the gradients</h4>
<div id="cell-87" class="cell" data-outputid="ace11234-1204-49ce-cd09-512ea01378f2" data-execution_count="76">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>loss.backward()</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>params.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>tensor([-96139.7500,  -6190.7744,   -445.6926])</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-outputid="3bf8436f-f151-4b43-e9dc-b7e4d8cae1f1" data-execution_count="77">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>params.grad <span class="op">*</span> <span class="fl">1e-5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>tensor([-0.9614, -0.0619, -0.0045])</code></pre>
</div>
</div>
<div id="cell-89" class="cell" data-outputid="eb25f1e0-bc91-4992-81f3-f96615d97b71" data-execution_count="78">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>tensor([-1.4608, -1.6226, -1.2073], requires_grad=True)</code></pre>
</div>
</div>
</section>
<section id="step-5-step-the-weights." class="level4">
<h4 class="anchored" data-anchor-id="step-5-step-the-weights.">Step 5: Step the weights.</h4>
<div id="cell-91" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">1e-5</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>params.data <span class="op">-=</span> lr <span class="op">*</span> params.grad.data</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>params.grad <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-92" class="cell" data-outputid="0e37f27f-2abc-454e-f2fc-5c002544ebe7" data-execution_count="80">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> f(time,params)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>mse(preds, speed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>tensor(16233.4893, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<p>And take a look at the plot:</p>
<div id="cell-94" class="cell" data-outputid="f4739554-78b8-4ebf-aea0-c4cba04899fd" data-execution_count="81">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>show_preds(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-58-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-95" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_step(params, prn<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> f(time, params)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> mse(preds, speed)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    params.data <span class="op">-=</span> lr <span class="op">*</span> params.grad.data</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    params.grad <span class="op">=</span> <span class="va">None</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prn: <span class="bu">print</span>(loss.item())</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><mark>&lt;mark&gt;Remember from my <a href="../how-does-a-neural-net-really-work/">previous post</a> that we had to do this: <code>with torch.no_grad(): abc -= abc.grad*0.01</code>, to make sure PyTorch won’t track this operation for calculating the gradient? So, why not here? Because it sets the result directly on the <code>data</code> property of <code>params</code>. That apparently prevents the gradient function tracker to ignore this operation.&lt;/mark&gt;</mark></p>
</section>
<section id="step-6-repeat-the-process" class="level4">
<h4 class="anchored" data-anchor-id="step-6-repeat-the-process">Step 6: Repeat the process</h4>
<div id="cell-98" class="cell" data-outputid="fc6a8e1c-fe18-4949-ee58-03846cf33b44" data-execution_count="83">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>): apply_step(params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>16233.4892578125
3631.822265625
1247.1947021484375
795.9425659179688
710.5438842773438
694.3759765625
691.3086547851562
690.7203369140625
690.6011352539062
690.5706787109375</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-outputid="c3159e5a-c425-46cb-cddd-4f7c1f747636">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>_,axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">4</span>,figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">3</span>))</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axs: show_preds(apply_step(params, <span class="va">False</span>), ax)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-61-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-7-stop" class="level4">
<h4 class="anchored" data-anchor-id="step-7-stop">Step 7: stop</h4>
</section>
</section>
<section id="summarizing-gradient-descent" class="level3">
<h3 class="anchored" data-anchor-id="summarizing-gradient-descent">Summarizing Gradient Descent</h3>
</section>
</section>
<section id="the-mnist-loss-function" class="level2">
<h2 class="anchored" data-anchor-id="the-mnist-loss-function">The MNIST Loss Function</h2>
<div id="cell-103" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>stacked_sevens.shape, stacked_threes.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>(torch.Size([6265, 28, 28]), torch.Size([6131, 28, 28]))</code></pre>
</div>
</div>
<div id="cell-104" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> torch.cat([stacked_threes, stacked_sevens]).view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>train_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>torch.Size([12396, 784])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;OK, so each image is now a vector of all 28*28 pixels, and dimension 0 basically points to each single image.&lt;/mark&gt;</mark></p>
<div id="cell-106" class="cell" data-outputid="315a6aee-59d4-4fa3-d94f-2dacbc5f4d1a" data-execution_count="94">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>train_y <span class="op">=</span> tensor([<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(threes) <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span><span class="bu">len</span>(sevens)).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>train_x.shape,train_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(torch.Size([12396, 784]), torch.Size([12396, 1]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So, <code>[1]*len(threes) + [0]*len(sevens)</code> simply creates a vector with all the “labels” (dependent variables). Now what is this <code>unsqueeze(1)</code> doing? We have a row of labels, but if we want to match them up with <code>train_x</code> we need a column. That is exactly what <code>unsqueeze(1)</code> does. Let’s play a little bit with that:&lt;/mark&gt;</mark></p>
<div id="cell-108" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>labels_list <span class="op">=</span> tensor([<span class="dv">1</span>]<span class="op">*</span><span class="dv">10</span> <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"shape: </span><span class="sc">{</span>labels_list<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>labels_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])</code></pre>
</div>
</div>
<div id="cell-109" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed <span class="op">=</span> labels_list.unsqueeze(<span class="dv">1</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"shape: </span><span class="sc">{</span>labels_list_unsqueezed<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20, 1])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor([[1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0]])</code></pre>
</div>
</div>
<div id="cell-110" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed0 <span class="op">=</span> labels_list.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"shape: </span><span class="sc">{</span>labels_list_unsqueezed0<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([1, 20])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>tensor([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]])</code></pre>
</div>
</div>
<div id="cell-111" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed0 <span class="op">=</span> labels_list[:, <span class="va">None</span>]</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"shape: </span><span class="sc">{</span>labels_list_unsqueezed0<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>labels_list_unsqueezed0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: torch.Size([20, 1])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>tensor([[1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [1],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0]])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;Ah, look at that! It is the same as the <code>[:, None]</code> trick we saw in the previous post!&lt;/mark&gt;</mark></p>
<p>A <code>Dataset</code> in PyTorch is required to return a tuple of <code>(x,y)</code> when indexed. Python provides a <code>zip</code> function which, when combined with <code>list</code>, provides a simple way to get this functionality:</p>
<div id="cell-114" class="cell" data-outputid="8c1a9f7c-9215-45b2-8660-39bedfa43012" data-execution_count="95">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>dset <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(train_x,train_y))</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dset[<span class="dv">0</span>]</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>x.shape,y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>(torch.Size([784]), tensor([1]))</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;So we now have a nice list of tuples of the form: (image vector, label)&lt;/mark&gt;</mark></p>
<div id="cell-116" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> torch.cat([valid_3_tens, valid_7_tens]).view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>valid_y <span class="op">=</span> tensor([<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(valid_3_tens) <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span><span class="bu">len</span>(valid_7_tens)).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>valid_dset <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(valid_x,valid_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-117" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params(size, std<span class="op">=</span><span class="fl">1.0</span>): <span class="cf">return</span> (torch.randn(size)<span class="op">*</span>std).requires_grad_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-118" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> init_params((<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>bias <span class="op">=</span> init_params(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>jargon: Parameters: The <em>weights</em> and <em>biases</em> of a model. The weights are the <code>w</code> in the equation <code>w*x+b</code>, and the biases are the <code>b</code> in that equation.</p>
</blockquote>
<div id="cell-121" class="cell" data-outputid="f6cce718-f766-45ca-83cc-73790f558ab4" data-execution_count="100">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>(train_x[<span class="dv">0</span>]<span class="op">*</span>weights.T).<span class="bu">sum</span>() <span class="op">+</span> bias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor([9.3344], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<p><img alt="Matrix multiplication" width="400" caption="Matrix multiplication" src="https://github.com/fastai/fastbook/blob/master/images/matmul2.svg?raw=1" id="matmul"></p>
<div id="cell-123" class="cell" data-outputid="ccc17977-b2ad-44cf-a96e-bd460bfa4e63" data-execution_count="101">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> linear1(xb): <span class="cf">return</span> xb<span class="op">@</span>weights <span class="op">+</span> bias</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> linear1(train_x)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>tensor([[ 9.3344],
        [ 0.8027],
        [ 7.0013],
        ...,
        [-1.8317],
        [ 3.5838],
        [-4.9083]], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-124" class="cell" data-outputid="93922ce2-b8ff-497e-d850-704f58e65d6d" data-execution_count="102">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>corrects <span class="op">=</span> (preds<span class="op">&gt;</span><span class="fl">0.0</span>).<span class="bu">float</span>() <span class="op">==</span> train_y</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>corrects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>tensor([[ True],
        [ True],
        [ True],
        ...,
        [ True],
        [False],
        [ True]])</code></pre>
</div>
</div>
<div id="cell-125" class="cell" data-outputid="fe59df8e-bf61-4e8d-9b65-1c7feea90df2" data-execution_count="103">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>corrects.<span class="bu">float</span>().mean().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>0.6630364656448364</code></pre>
</div>
</div>
<div id="cell-126" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad(): weights[<span class="dv">0</span>] <span class="op">*=</span> <span class="fl">1.0001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-127" class="cell" data-outputid="13beb12e-c956-47b5-bc18-77f3acc0fc8a" data-execution_count="105">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> linear1(train_x)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>((preds<span class="op">&gt;</span><span class="fl">0.0</span>).<span class="bu">float</span>() <span class="op">==</span> train_y).<span class="bu">float</span>().mean().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>0.6630364656448364</code></pre>
</div>
</div>
<div id="cell-128" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>trgts  <span class="op">=</span> tensor([<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>prds   <span class="op">=</span> tensor([<span class="fl">0.9</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-129" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_loss(predictions, targets):</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.where(targets<span class="op">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="op">-</span>predictions, predictions).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-130" class="cell" data-outputid="81242a2a-08af-41d9-cfe1-ba8daf9bd8f2" data-execution_count="108">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>torch.where(trgts<span class="op">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="op">-</span>prds, prds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>tensor([0.1000, 0.4000, 0.8000])</code></pre>
</div>
</div>
<div id="cell-131" class="cell" data-outputid="f5981d0d-e23f-461f-e6af-5abadb0958d6" data-execution_count="109">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>mnist_loss(prds,trgts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>tensor(0.4333)</code></pre>
</div>
</div>
<div id="cell-132" class="cell" data-outputid="ef080630-a0be-4c5b-e695-aa31a542aff6" data-execution_count="110">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>mnist_loss(tensor([<span class="fl">0.9</span>, <span class="fl">0.4</span>, <span class="fl">0.8</span>]),trgts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>tensor(0.2333)</code></pre>
</div>
</div>
<section id="sigmoid" class="level3">
<h3 class="anchored" data-anchor-id="sigmoid">Sigmoid</h3>
<div id="cell-134" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sigmoid(x): <span class="cf">return</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>torch.exp(<span class="op">-</span>x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-135" class="cell" data-outputid="cc8dad8b-0aa1-477a-818b-7d56750753c9">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>plot_function(torch.sigmoid, title<span class="op">=</span><span class="st">'Sigmoid'</span>, <span class="bu">min</span><span class="op">=-</span><span class="dv">4</span>, <span class="bu">max</span><span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-86-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-136" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_loss(predictions, targets):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> predictions.sigmoid()</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.where(targets<span class="op">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="op">-</span>predictions, predictions).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sgd-and-mini-batches" class="level3">
<h3 class="anchored" data-anchor-id="sgd-and-mini-batches">SGD and Mini-Batches</h3>
<div id="cell-138" class="cell" data-outputid="5508d8af-e61c-43a1-c93d-c8a479c75ad6" data-execution_count="113">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>coll <span class="op">=</span> <span class="bu">range</span>(<span class="dv">15</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> DataLoader(coll, batch_size<span class="op">=</span><span class="dv">5</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>[tensor([11,  4,  8,  9, 10]),
 tensor([13,  1,  5,  0, 14]),
 tensor([ 3, 12,  7,  2,  6])]</code></pre>
</div>
</div>
<div id="cell-139" class="cell" data-outputid="89a1da5b-c69c-414a-b981-d6a27db53159" data-execution_count="114">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> L(<span class="bu">enumerate</span>(string.ascii_lowercase))</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>(#26) [(0, 'a'),(1, 'b'),(2, 'c'),(3, 'd'),(4, 'e'),(5, 'f'),(6, 'g'),(7, 'h'),(8, 'i'),(9, 'j')...]</code></pre>
</div>
</div>
<div id="cell-140" class="cell" data-outputid="278fb0fb-95f2-4be6-e540-46675a3c325b" data-execution_count="115">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> DataLoader(ds, batch_size<span class="op">=</span><span class="dv">6</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>[(tensor([17, 22, 12, 20,  9,  6]), ('r', 'w', 'm', 'u', 'j', 'g')),
 (tensor([21,  7, 14, 13,  0, 24]), ('v', 'h', 'o', 'n', 'a', 'y')),
 (tensor([ 3,  8,  4, 16, 19,  5]), ('d', 'i', 'e', 'q', 't', 'f')),
 (tensor([18, 11, 25, 23,  2,  1]), ('s', 'l', 'z', 'x', 'c', 'b')),
 (tensor([10, 15]), ('k', 'p'))]</code></pre>
</div>
</div>
</section>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting It All Together</h2>
<div id="cell-142" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> init_params((<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">1</span>))</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>bias <span class="op">=</span> init_params(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-143" class="cell" data-outputid="b0303e03-745c-4651-cc8f-20a0e0dc5c2a" data-execution_count="117">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> DataLoader(dset, batch_size<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>xb,yb <span class="op">=</span> first(dl)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>xb.shape,yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<div id="cell-144" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="op">=</span> DataLoader(valid_dset, batch_size<span class="op">=</span><span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-145" class="cell" data-outputid="75c7aa4b-f081-4778-bffb-c95f17e773d7" data-execution_count="119">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> train_x[:<span class="dv">4</span>]</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>batch.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>torch.Size([4, 784])</code></pre>
</div>
</div>
<div id="cell-146" class="cell" data-outputid="850a3219-4492-4765-f05f-c1a423fefdde" data-execution_count="120">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> linear1(batch)</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>tensor([[0.7288],
        [2.3106],
        [2.0486],
        [1.4359]], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-147" class="cell" data-outputid="bb093d1b-adaf-4016-eaf1-3a776bf0756c" data-execution_count="121">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mnist_loss(preds, train_y[:<span class="dv">4</span>])</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>tensor(0.1805, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-148" class="cell" data-outputid="f0548fc4-89c2-4855-a7ee-af6a838ea2bd" data-execution_count="122">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>loss.backward()</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>weights.grad.shape,weights.grad.mean(),bias.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>(torch.Size([784, 1]), tensor(-0.0212), tensor([-0.1395]))</code></pre>
</div>
</div>
<div id="cell-149" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_grad(xb, yb, model):</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(xb)</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> mnist_loss(preds, yb)</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-150" class="cell" data-outputid="416d15a8-9438-436b-85b9-dd40a8295537" data-execution_count="124">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>calc_grad(batch, train_y[:<span class="dv">4</span>], linear1)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>weights.grad.mean(),bias.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">
<pre><code>(tensor(-0.0424), tensor([-0.2790]))</code></pre>
</div>
</div>
<div id="cell-151" class="cell" data-outputid="b4cb86b6-ddc4-4702-b8eb-b37b90ef52a5" data-execution_count="125">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>calc_grad(batch, train_y[:<span class="dv">4</span>], linear1)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>weights.grad.mean(),bias.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>(tensor(-0.0636), tensor([-0.4185]))</code></pre>
</div>
</div>
<div id="cell-152" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>weights.grad.zero_()</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>bias.grad.zero_()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-153" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_epoch(model, lr, params):</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> xb,yb <span class="kw">in</span> dl:</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>        calc_grad(xb, yb, model)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> params:</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>            p.data <span class="op">-=</span> p.grad<span class="op">*</span>lr</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>            p.grad.zero_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-154" class="cell" data-outputid="7b48f81b-ccc5-42ec-d093-a813424506cb" data-execution_count="128">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>(preds<span class="op">&gt;</span><span class="fl">0.0</span>).<span class="bu">float</span>() <span class="op">==</span> train_y[:<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>tensor([[True],
        [True],
        [True],
        [True]])</code></pre>
</div>
</div>
<div id="cell-155" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_accuracy(xb, yb):</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> xb.sigmoid()</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    correct <span class="op">=</span> (preds<span class="op">&gt;</span><span class="fl">0.5</span>) <span class="op">==</span> yb</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> correct.<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-156" class="cell" data-outputid="218d0407-3016-48e7-df52-53b24dfa6a19" data-execution_count="130">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>batch_accuracy(linear1(batch), train_y[:<span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>tensor(1.)</code></pre>
</div>
</div>
<div id="cell-157" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_epoch(model):</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>    accs <span class="op">=</span> [batch_accuracy(model(xb), yb) <span class="cf">for</span> xb,yb <span class="kw">in</span> valid_dl]</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">round</span>(torch.stack(accs).mean().item(), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-158" class="cell" data-outputid="d7b15398-25cb-419a-8fbd-586ce3241b7c" data-execution_count="132">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>validate_epoch(linear1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>0.7649</code></pre>
</div>
</div>
<div id="cell-159" class="cell" data-outputid="b1f8023e-593d-4bc3-ae60-08cecf07e809" data-execution_count="133">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">1.</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> weights,bias</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>train_epoch(linear1, lr, params)</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>validate_epoch(linear1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>0.8446</code></pre>
</div>
</div>
<div id="cell-160" class="cell" data-outputid="9bb7d42a-4c9c-4a6f-8cb5-898a9aec1615" data-execution_count="134">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>):</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    train_epoch(linear1, lr, params)</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(validate_epoch(linear1), end<span class="op">=</span><span class="st">' '</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.9144 0.9369 0.9462 0.9545 0.9589 0.9603 0.9628 0.9638 0.9638 0.9643 0.9657 0.9652 0.9657 0.9677 0.9681 0.9681 0.9696 0.9696 0.9706 0.972 </code></pre>
</div>
</div>
<section id="creating-an-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="creating-an-optimizer">Creating an Optimizer</h3>
<div id="cell-162" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>linear_model <span class="op">=</span> nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-163" class="cell" data-outputid="bbe3cce1-6ac7-4a60-9641-7aec07409b7e" data-execution_count="136">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>w,b <span class="op">=</span> linear_model.parameters()</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>w.shape,b.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>(torch.Size([1, 784]), torch.Size([1]))</code></pre>
</div>
</div>
<div id="cell-164" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicOptim:</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,params,lr): <span class="va">self</span>.params,<span class="va">self</span>.lr <span class="op">=</span> <span class="bu">list</span>(params),lr</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p.data <span class="op">-=</span> p.grad.data <span class="op">*</span> <span class="va">self</span>.lr</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> zero_grad(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p.grad <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-165" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> BasicOptim(linear_model.parameters(), lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-166" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_epoch(model):</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> xb,yb <span class="kw">in</span> dl:</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>        calc_grad(xb, yb, model)</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>        opt.step()</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>        opt.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-167" class="cell" data-outputid="7eb5a6bd-adef-4f94-d464-6f41ada4492b" data-execution_count="140">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>validate_epoch(linear_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>0.6292</code></pre>
</div>
</div>
<div id="cell-168" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, epochs):</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>        train_epoch(model)</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(validate_epoch(model), end<span class="op">=</span><span class="st">' '</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-169" class="cell" data-outputid="7fa40c27-a23c-4181-e616-e489f28c5b01" data-execution_count="142">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>train_model(linear_model, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4932 0.8052 0.8525 0.917 0.9346 0.9487 0.957 0.9624 0.9658 0.9678 0.9692 0.9717 0.9736 0.9746 0.9761 0.9765 0.9775 0.978 0.978 0.979 </code></pre>
</div>
</div>
<div id="cell-170" class="cell" data-outputid="bc32f893-4ad0-4dc3-8ede-0f23dea4355a" data-execution_count="143">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>linear_model <span class="op">=</span> nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">1</span>)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> SGD(linear_model.parameters(), lr)</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>train_model(linear_model, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4932 0.7759 0.8603 0.9179 0.9346 0.9516 0.957 0.9634 0.9658 0.9673 0.9697 0.9717 0.9746 0.9751 0.9761 0.977 0.9775 0.978 0.978 0.9785 </code></pre>
</div>
</div>
<div id="cell-171" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(dl, valid_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-172" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">1</span>), opt_func<span class="op">=</span>SGD,</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>                loss_func<span class="op">=</span>mnist_loss, metrics<span class="op">=</span>batch_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-173" class="cell" data-outputid="7c61af77-bdc5-4360-d785-14e65c6895b1" data-execution_count="146">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.636803</td>
<td>0.503571</td>
<td>0.495584</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.569794</td>
<td>0.217214</td>
<td>0.807655</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.208501</td>
<td>0.165452</td>
<td>0.851816</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.090031</td>
<td>0.101155</td>
<td>0.914622</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.046536</td>
<td>0.074791</td>
<td>0.935231</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.029671</td>
<td>0.060303</td>
<td>0.948970</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.022822</td>
<td>0.051260</td>
<td>0.956330</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.019821</td>
<td>0.045237</td>
<td>0.962218</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.018322</td>
<td>0.040985</td>
<td>0.965653</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.017435</td>
<td>0.037833</td>
<td>0.968106</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="adding-a-nonlinearity" class="level2">
<h2 class="anchored" data-anchor-id="adding-a-nonlinearity">Adding a Nonlinearity</h2>
<div id="cell-175" class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_net(xb):</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> xb<span class="op">@</span>w1 <span class="op">+</span> b1</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> res.<span class="bu">max</span>(tensor(<span class="fl">0.0</span>))</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> res<span class="op">@</span>w2 <span class="op">+</span> b2</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-176" class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> init_params((<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">30</span>))</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> init_params(<span class="dv">30</span>)</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>w2 <span class="op">=</span> init_params((<span class="dv">30</span>,<span class="dv">1</span>))</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> init_params(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key point about this is that <code>w1</code> has 30 output activations (which means that <code>w2</code> must have 30 input activations, so they match). That means that the first layer can construct 30 different features, each representing some different mix of pixels. You can change that <code>30</code> to anything you like, to make the model more or less complex.</p>
<p><mark>&lt;mark&gt;So, the <code>w1</code> matrix has 30 rows and 784 columns, which means that it can take a vector of 784 pixel values as input (the image we want to classify), and return a vector of 30 values. The <code>w2</code> matrix has 1 row and 30 columns, which means that it can take a vector of 30 values as input, and return a scalar (which is the probability).&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;These 30 output activations are synonym to a layer of 30 nodes. Each of these 30 nodes has it’s own set of 784 weights that we try to optimize. So more nodes means more possible feature detectors or pattern recognizers that our model can learn. We can think of each of those 30 nodes as becoming specialized in detecting different aspects of what makes a digit look like a “3” versus a “7”.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;I like how Claude said it while explaining this to me:&lt;/mark&gt;</mark></p>
<blockquote class="blockquote">
<p>Here’s a helpful way to think about it: imagine you’re trying to distinguish between cats and dogs, and you have 30 friends helping you. Each friend specializes in looking for different features - one focuses on ear shape, another on tail length, another on fur texture, and so on. Each friend gives you their opinion (a number between, say, -10 and +10), and then you have to weigh all 30 opinions to make your final decision. That’s essentially what your two-layer network is doing.</p>
<p>The beauty is that during training, the network automatically figures out what each of those 30 “friends” should specialize in looking for. You don’t have to tell it “node 1, you focus on curves” - it discovers these useful features on its own through the optimization process.</p>
</blockquote>
<p><mark>&lt;mark&gt;I was then wondering: what if some or all nodes try to specialize in the same feature? There are two reasons why this is not likely:</mark></p>
<p><mark>1. We initialize the weights randomly, so each node starts with a different perspective.</mark></p>
<p><mark>2. The optimization process will adjust the weights in such a way that it minimizes the loss function, which means that if two nodes try to learn the same feature, one of them will end up being less effective and will be encouraged to learn something else.&lt;/mark&gt;</mark></p>
<p><mark>&lt;mark&gt;I still have to think hard to get the matrix juggling down, so let’s create a super-tiny net:&lt;/mark&gt;</mark></p>
<div id="cell-178" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Our tiny network layer</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> nn.Linear(<span class="dv">4</span>, <span class="dv">3</span>)  <span class="co"># 4 inputs (2x2 image flattened), 3 outputs</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample 2x2 image</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> tensor([[<span class="fl">1.0</span>, <span class="fl">2.0</span>],</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>                [<span class="fl">3.0</span>, <span class="fl">4.0</span>]])</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten the image to a column vector</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> image.flatten()  <span class="co"># x = [1.0, 2.0, 3.0, 4.0] with shape [4]</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The weights and biases are already initialized by nn.Linear</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> layer.weight  <span class="co"># shape [3, 4]</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> layer.bias      <span class="co"># shape [3]</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Weights </span><span class="sc">{</span>w<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>w<span class="sc">.</span>data<span class="sc">}</span><span class="ss">, Bias </span><span class="sc">{</span>b<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>b<span class="sc">.</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Matrix multiplication: w @ x (shape [3,4] @ [4] = [3])</span></span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> w <span class="op">@</span> x <span class="op">+</span> b</span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output shape: </span><span class="sc">{</span>output<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Output: </span><span class="sc">{</span>output<span class="sc">.</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Now apply ReLU activation</span></span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a>output2 <span class="op">=</span> F.relu(output)</span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output after ReLU shape: </span><span class="sc">{</span>output2<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Output: </span><span class="sc">{</span>output2<span class="sc">.</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-25"><a href="#cb196-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Last layer</span></span>
<span id="cb196-26"><a href="#cb196-26" aria-hidden="true" tabindex="-1"></a>layer2 <span class="op">=</span> nn.Linear(<span class="dv">3</span>, <span class="dv">1</span>)  <span class="co"># 3 inputs, 1 output</span></span>
<span id="cb196-27"><a href="#cb196-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights and biases for the last layer</span></span>
<span id="cb196-28"><a href="#cb196-28" aria-hidden="true" tabindex="-1"></a>w2 <span class="op">=</span> layer2.weight  <span class="co"># shape [1, 3]</span></span>
<span id="cb196-29"><a href="#cb196-29" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> layer2.bias      <span class="co"># shape [1]</span></span>
<span id="cb196-30"><a href="#cb196-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Final output</span></span>
<span id="cb196-31"><a href="#cb196-31" aria-hidden="true" tabindex="-1"></a>final_output <span class="op">=</span> w2 <span class="op">@</span> output2 <span class="op">+</span> b2</span>
<span id="cb196-32"><a href="#cb196-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final output shape: </span><span class="sc">{</span>final_output<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Final output: </span><span class="sc">{</span>final_output<span class="sc">.</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb196-33"><a href="#cb196-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Final output after sigmoid activation</span></span>
<span id="cb196-34"><a href="#cb196-34" aria-hidden="true" tabindex="-1"></a>final_output_sigmoid <span class="op">=</span> torch.sigmoid(final_output)</span>
<span id="cb196-35"><a href="#cb196-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final output after sigmoid shape: </span><span class="sc">{</span>final_output_sigmoid<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, Final output: </span><span class="sc">{</span>final_output_sigmoid<span class="sc">.</span>data<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weights torch.Size([3, 4]): tensor([[ 0.0777,  0.2776,  0.4277,  0.0007],
        [-0.4654, -0.0821,  0.1229,  0.2742],
        [ 0.1707, -0.2651,  0.3052,  0.1164]]), Bias torch.Size([3]): tensor([-0.1928, -0.2575,  0.3110])
Output shape: torch.Size([3]), Output: tensor([1.7258, 0.5783, 1.3328])
Output after ReLU shape: torch.Size([3]), Output: tensor([1.7258, 0.5783, 1.3328])
Final output shape: torch.Size([1]), Final output: tensor([-0.2682])
Final output after sigmoid shape: torch.Size([1]), Final output: tensor([0.4333])</code></pre>
</div>
</div>
<p><mark>&lt;mark&gt;This tiny model is visualized below. The first layer has 3 nodes and the second linear layer has 1 node.&lt;/mark&gt;</mark></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./super-tiny.png" class="img-fluid figure-img"></p>
<figcaption>Super-tiny net. Made with <a href="https://alexlenail.me/NN-SVG/index.html" target="_blank">NN-SVG</a></figcaption>
</figure>
</div>
<div id="cell-181" class="cell" data-outputid="11c5fd28-a441-4c5a-da21-67cf34e6fd23">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>plot_function(F.relu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-125-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-182" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>,<span class="dv">30</span>),</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>,<span class="dv">1</span>)</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-183" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, simple_net, opt_func<span class="op">=</span>SGD,</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>                loss_func<span class="op">=</span>mnist_loss, metrics<span class="op">=</span>batch_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-184" class="cell" data-outputid="985cd0b9-576f-4ff4-8467-d0be68ef488d">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">40</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.325859</td>
<td>0.411601</td>
<td>0.504907</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.150409</td>
<td>0.233516</td>
<td>0.798332</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.082649</td>
<td>0.116558</td>
<td>0.913150</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.054023</td>
<td>0.078485</td>
<td>0.940628</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.040843</td>
<td>0.061257</td>
<td>0.954858</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.034143</td>
<td>0.051604</td>
<td>0.963199</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.030300</td>
<td>0.045509</td>
<td>0.965653</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.027805</td>
<td>0.041319</td>
<td>0.967615</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.026009</td>
<td>0.038248</td>
<td>0.968597</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.024617</td>
<td>0.035891</td>
<td>0.969578</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.023491</td>
<td>0.034015</td>
<td>0.972031</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.022551</td>
<td>0.032479</td>
<td>0.973994</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.021751</td>
<td>0.031189</td>
<td>0.974485</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.021059</td>
<td>0.030088</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.020454</td>
<td>0.029132</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.019918</td>
<td>0.028290</td>
<td>0.975957</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.019438</td>
<td>0.027543</td>
<td>0.976938</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.019006</td>
<td>0.026874</td>
<td>0.977920</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.018614</td>
<td>0.026271</td>
<td>0.978410</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.018255</td>
<td>0.025726</td>
<td>0.978901</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.017924</td>
<td>0.025230</td>
<td>0.979392</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.017619</td>
<td>0.024777</td>
<td>0.979882</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.017335</td>
<td>0.024363</td>
<td>0.980373</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.017070</td>
<td>0.023981</td>
<td>0.980864</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.016821</td>
<td>0.023629</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>25</td>
<td>0.016588</td>
<td>0.023304</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>26</td>
<td>0.016368</td>
<td>0.023003</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>27</td>
<td>0.016160</td>
<td>0.022723</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>28</td>
<td>0.015963</td>
<td>0.022462</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>29</td>
<td>0.015775</td>
<td>0.022220</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>30</td>
<td>0.015597</td>
<td>0.021993</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>31</td>
<td>0.015427</td>
<td>0.021782</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>32</td>
<td>0.015265</td>
<td>0.021584</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>33</td>
<td>0.015110</td>
<td>0.021398</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>34</td>
<td>0.014961</td>
<td>0.021224</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>35</td>
<td>0.014819</td>
<td>0.021060</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>36</td>
<td>0.014682</td>
<td>0.020906</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>37</td>
<td>0.014550</td>
<td>0.020760</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>38</td>
<td>0.014423</td>
<td>0.020622</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>39</td>
<td>0.014301</td>
<td>0.020492</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-185" class="cell" data-outputid="fbd769f0-d426-456a-b942-d67e25f8f185" data-execution_count="163">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>plt.plot(L(learn.recorder.values).itemgot(<span class="dv">2</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-129-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-186" class="cell" data-outputid="b6acc6c6-dbbb-4da9-9a90-b5ce50073eb2" data-execution_count="164">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>learn.recorder.values[<span class="op">-</span><span class="dv">1</span>][<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>0.981844961643219</code></pre>
</div>
</div>
<section id="going-deeper" class="level3">
<h3 class="anchored" data-anchor-id="going-deeper">Going Deeper</h3>
<div id="cell-188" class="cell" data-outputid="978109c2-b940-4993-d4c1-1ac86504fda6">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(path)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>                    loss_func<span class="op">=</span>F.cross_entropy, metrics<span class="op">=</span>accuracy)</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
0.082135
</td>
<td>
0.014342
</td>
<td>
0.996565
</td>
<td>
02:26
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="jargon-recap" class="level2">
<h2 class="anchored" data-anchor-id="jargon-recap">Jargon Recap</h2>
<p>Congratulations: you now know how to create and train a deep neural network from scratch! We’ve gone through quite a few steps to get to this point, but you might be surprised at how simple it really is.</p>
<p>Now that we are at this point, it is a good opportunity to define, and review, some jargon and key concepts.</p>
<p>A neural network contains a lot of numbers, but they are only of two types: numbers that are calculated, and the parameters that these numbers are calculated from. This gives us the two most important pieces of jargon to learn:</p>
<ul>
<li><mark>Activations: Numbers that are calculated (both by linear and nonlinear layers)</mark></li>
<li><mark>Parameters: Numbers that are randomly initialized, and optimized (that is, the numbers that define the model)</mark></li>
</ul>
<p>We will often talk in this book about activations and parameters. Remember that they have very specific meanings. They are numbers. They are not abstract concepts, but they are actual specific numbers that are in your model. Part of becoming a good deep learning practitioner is getting used to the idea of actually looking at your activations and parameters, and plotting them and testing whether they are behaving correctly.</p>
<p>Our activations and parameters are all contained in <em>tensors</em>. These are simply regularly shaped arrays—for example, a matrix. Matrices have rows and columns; we call these the <em>axes</em> or <em>dimensions</em>. The number of dimensions of a tensor is its <em>rank</em>. There are some special tensors:</p>
<ul>
<li>Rank zero: scalar</li>
<li>Rank one: vector</li>
<li>Rank two: matrix</li>
</ul>
<p>A neural network contains a number of layers. Each layer is either <em>linear</em> or <em>nonlinear</em>. We generally alternate between these two kinds of layers in a neural network. Sometimes people refer to both a linear layer and its subsequent nonlinearity together as a single layer. Yes, this is confusing. Sometimes a nonlinearity is referred to as an <em>activation function</em>.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ReLU</td>
<td>Function that returns 0 for negative numbers and doesn’t change positive numbers.</td>
</tr>
<tr class="even">
<td>Mini-batch</td>
<td>A small group of inputs and labels gathered together in two arrays. A gradient descent step is updated on this batch (rather than a whole epoch).</td>
</tr>
<tr class="odd">
<td>Forward pass</td>
<td>Applying the model to some input and computing the predictions.</td>
</tr>
<tr class="even">
<td>Loss</td>
<td>A value that represents how well (or badly) our model is doing.</td>
</tr>
<tr class="odd">
<td>Gradient</td>
<td>The derivative of the loss with respect to some parameter of the model.</td>
</tr>
<tr class="even">
<td>Backward pass</td>
<td>Computing the gradients of the loss with respect to all model parameters.</td>
</tr>
<tr class="odd">
<td>Gradient descent</td>
<td>Taking a step in the directions opposite to the gradients to make the model parameters a little bit better.</td>
</tr>
<tr class="even">
<td>Learning rate</td>
<td>The size of the step we take when applying SGD to update the parameters of the model.</td>
</tr>
</tbody>
</table>
<p><mark>&lt;mark&gt;And that concludes lesson 3 of the course (and chapter 4 of the book) for me. I’ll move on with chapter 5 of the book instead of lesson 4 of the course. Let’s get all the computer vision stuff done before moving to NLP.&lt;/mark&gt;</mark></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dronelab\.dev");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>